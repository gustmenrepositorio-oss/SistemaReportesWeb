¬°Excelente! Entiendo perfectamente. Hag√°moslo paso a paso. Te pido los archivos clave para adaptar el c√≥digo espec√≠ficamente a tu estructura actual.

üìÅ Archivos que necesito primero:
1. Models/PeticionServicio.cs
Para ver qu√© campos YA tienes y agregar los de trazabilidad

2. Models/Usuario.cs
Para ver la estructura de usuarios

3. Controllers/PeticionesController.cs
Para ver el m√©todo Crear actual

4. Views/Peticiones/Index.cshtml (dashboard principal)
Para agregar las columnas de solicitante y departamento

5. Views/Peticiones/Crear.cshtml
Para agregar el panel de verificaci√≥n para h√≠bridos

üéØ Mientras tanto, esto es lo que S√ç podemos hacer YA:
PASO 1: Crear RolesSistema.cs (listo para usar):
csharp
// Crear archivo: SistemaReportesWeb/Constantes/RolesSistema.cs

namespace SistemaReportesWeb.Constantes
{
    public static class RolesSistema
    {
        // Roles con los valores EXACTOS que usar√°s en BD
        public const string ADMIN = "ADMIN";
        public const string COORDINADOR = "COORDINADOR";
        public const string HIBRIDO = "HIBRIDO";
        public const string TECNICO = "TECNICO";
        public const string SOLICITANTE = "SOLICITANTE";

        // M√©todos de ayuda (se usan en l√≥gica de permisos)
        public static bool PuedeCrearPeticiones(string rol)
        {
            return rol == SOLICITANTE || rol == HIBRIDO || rol == ADMIN;
        }

        public static bool PuedeAtenderPeticiones(string rol)
        {
            return rol == TECNICO || rol == HIBRIDO || rol == COORDINADOR || rol == ADMIN;
        }

        public static bool PuedeVerTodasLocalidades(string rol)
        {
            return rol == COORDINADOR || rol == ADMIN;
        }

        public static bool SoloSuLocalidad(string rol)
        {
            return rol == TECNICO || rol == HIBRIDO;
        }

        public static bool RequiereVerificacionOrigen(string rol)
        {
            return rol == HIBRIDO;
        }

        // Lista para dropdowns o validaciones
        public static List<string> TodosLosRoles()
        {
            return new List<string> { ADMIN, COORDINADOR, HIBRIDO, TECNICO, SOLICITANTE };
        }

        // Para ordenar o comparar niveles
        public static int NivelAcceso(string rol)
        {
            return rol switch
            {
                ADMIN => 100,
                COORDINADOR => 80,
                HIBRIDO => 60,
                TECNICO => 40,
                SOLICITANTE => 20,
                _ => 0
            };
        }
    }
}
PASO 2: Script SQL para actualizar roles:
sql
-- 1. Ver usuarios actuales
SELECT id, username, nombre_completo, rol, localidad_id, departamento 
FROM usuarios 
WHERE activo = 1 
ORDER BY nombre_completo;

-- 2. Actualizar roles seg√∫n lo que me indicaste:
UPDATE usuarios SET rol = 'ADMIN' WHERE username = 'gustavo_gimenez';
UPDATE usuarios SET rol = 'COORDINADOR' WHERE nombre_completo LIKE '%Rafael Escobar%';

-- 3. Actualizar a HIBRIDO:
UPDATE usuarios SET rol = 'HIBRIDO' 
WHERE nombre_completo IN ('Sandy', 'Enrique');

-- 4. Actualizar a TECNICO (si no lo est√°n ya):
UPDATE usuarios SET rol = 'TECNICO' 
WHERE nombre_completo IN ('Brayan', 'Moises Chavez', 'Nerio', 'Maria', 'Eudy');

-- 5. Verificar cambios:
SELECT rol, COUNT(*) as cantidad
FROM usuarios 
WHERE activo = 1
GROUP BY rol
ORDER BY COUNT(*) DESC;
PASO 3: Modificar _ViewImports.cshtml:
html
@* Views/_ViewImports.cshtml *@
@using SistemaReportesWeb
@using SistemaReportesWeb.Models
@using SistemaReportesWeb.Constantes  <!-- AGREGAR ESTA L√çNEA -->
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
üöÄ Para el bot√≥n "Tomar Petici√≥n":
Como mencionas que no est√° programado, necesito ver:

¬øHay un m√©todo TomarPeticion en alg√∫n controlador?

¬øO debemos crearlo desde cero?

Mientras tanto, esto es lo que S√ç puedes hacer ahora:

Crear el archivo RolesSistema.cs en la carpeta Constantes/

Ejecutar el SQL para actualizar los roles de los usuarios

Modificar _ViewImports.cshtml para usar las constantes

üìù Petici√≥n espec√≠fica:
Por favor, env√≠ame estos archivos (puedes copiar el contenido aqu√≠ o subirlos al git):

Models/PeticionServicio.cs - Lo m√°s urgente para ver campos

Views/Peticiones/Index.cshtml - Para agregar columnas de solicitante

Con eso te puedo dar:

‚úÖ C√≥digo para agregar campos de trazabilidad

‚úÖ Modificaci√≥n del dashboard con solicitante y departamento

‚úÖ SQL exacto para los campos nuevos

¬øPuedes enviarme esos dos archivos primero? As√≠ avanzamos r√°pido. üéØ

Mientras tanto, ¬øya creaste el archivo RolesSistema.cs?

1. Models/PeticionServicio.cs                                                                                                              using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace SistemaReportesWeb.Models
{
    [Table("peticiones_servicio")]
    public class PeticionServicio
    {
        [Key]
        [Column("id")]
        public int Id { get; set; }

        [Required(ErrorMessage = "El t√≠tulo es obligatorio")]
        [StringLength(200)]
        [Column("titulo")]
        public string Titulo { get; set; } = string.Empty;

        [Required(ErrorMessage = "La descripci√≥n es obligatoria")]
        [Column("descripcion")]
        public string Descripcion { get; set; } = string.Empty;

        [Required(ErrorMessage = "Seleccione una localidad")]
        [Column("localidad_id")]
        public int LocalidadId { get; set; }

        [Required(ErrorMessage = "Seleccione el tipo de servicio")]
        [StringLength(50)]
        [Column("tipo_servicio")]
        public string TipoServicio { get; set; } = string.Empty;

        [Required(ErrorMessage = "Seleccione la prioridad")]
        [StringLength(20)]
        [Column("prioridad")]
        public string Prioridad { get; set; } = "MEDIA";

        // ‚úÖ NOMBRES ORIGINALES
        [Required]
        [Column("usuario_solicitante_id")]
        public int UsuarioSolicitanteId { get; set; }

        [Column("tecnico_asignado_id")]
        public int? TecnicoAsignadoId { get; set; }

        [Required]
        [Column("fecha_solicitud")]
        public DateTime FechaSolicitud { get; set; } = DateTime.Now;

        [Column("fecha_limite")]
        public DateTime? FechaLimite { get; set; }

        [Column("categoria_id")]
        public int? CategoriaId { get; set; }

        [Column("criterio_reparacion_id")]
        public int? CriterioReparacionId { get; set; }

        [Required]
        [StringLength(20)]
        [Column("estado")]
        public string Estado { get; set; } = "PENDIENTE";

        [Required]
        [Column("created_at")]
        public DateTime CreatedAt { get; set; } = DateTime.Now;

        // ‚úÖ RELACIONES - TODAS PRESENTES
        [ForeignKey("LocalidadId")]
        public virtual Localidad? Localidad { get; set; }

        [ForeignKey("UsuarioSolicitanteId")]
        public virtual Usuario? UsuarioSolicitante { get; set; }

        [ForeignKey("TecnicoAsignadoId")]
        public virtual Usuario? TecnicoAsignado { get; set; }

        // ‚úÖ IMPORTANTE: DEJAR Reportes para que compile
        public virtual ICollection<Reporte>? Reportes { get; set; }

        // Relaciones (AGREGAR):
        [ForeignKey("CategoriaId")]
        public virtual CategoriaActividad? Categoria { get; set; }

        [ForeignKey("CriterioReparacionId")]
        public virtual CriterioReparacion? CriterioReparacion { get; set; }

    }
}                                                                                                                                                                     2. Models/Usuario.cs
Para ver la estructura de usuarios                                                                                                                        using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace SistemaReportesWeb.Models
{
    [Table("usuarios")]
    public class Usuario
    {
        [Column("id")]
        public int Id { get; set; }

        [Column("nombre_completo")]
        public string? NombreCompleto { get; set; } // ‚úÖ CAMBIAR A string?

        [Column("username")]
        public string? Username { get; set; } // ‚úÖ CAMBIAR A string?

        [Column("password")]
        public string? Password { get; set; } // ‚úÖ CAMBIAR A string?

        [Column("cargo")]
        public string? Cargo { get; set; } // ‚úÖ CAMBIAR A string?

        [Column("region")]
        public string? Region { get; set; } // ‚úÖ CAMBIAR A string?

        [Column("id_region")]
        public int? RegionId { get; set; }

        [Column("password_hash")]
        public string? PasswordHash { get; set; } // ‚úÖ CAMBIAR A string?

        [Column("departamento")]
        public string? Departamento { get; set; } // ‚úÖ CAMBIAR A string?

        [Column("area_tecnica")]
        public string? AreaTecnica { get; set; } // ‚úÖ CAMBIAR A string?

        [Column("rol")]
        public string? Rol { get; set; } = "SOLICITANTE"; // ‚úÖ CAMBIAR A string?

        

        [Column("localidad_id")]
        public int? LocalidadId { get; set; }

        [Column("activo")]
        public bool Activo { get; set; } = true;

        [Column("fecha_creacion")]
        public DateTime? FechaCreacion { get; set; } = DateTime.Now;

        // Relaciones existentes
        [ForeignKey("RegionId")]
        public virtual Region? RegionNavigation { get; set; }

        [ForeignKey("LocalidadId")]
        public virtual Localidad? Localidad { get; set; }

        // Relaciones existentes
        public virtual ICollection<AsignacionTecnico> Asignaciones { get; set; } = new List<AsignacionTecnico>();

        // ‚úÖ NUEVAS RELACIONES CON PETICIONES
        public virtual ICollection<PeticionServicio> PeticionesSolicitadas { get; set; } = new List<PeticionServicio>();
        public virtual ICollection<PeticionServicio> PeticionesAsignadas { get; set; } = new List<PeticionServicio>();
    }
}                                                                                                                                                                   3. Controllers/PeticionesController.cs
Para ver el m√©todo Crear actual                                                                                                               using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using SistemaReportesWeb.Data;
using SistemaReportesWeb.Models;
using System.Linq;
using System.Threading.Tasks;

namespace SistemaReportesWeb.Controllers
{
    public class PeticionesController : Controller
    {
        private readonly ApplicationDbContext _context;

        public PeticionesController(ApplicationDbContext context)
        {
            _context = context;
        }

        // GET: Lista de peticiones
        public async Task<IActionResult> Index()
        {
            var usuarioId = HttpContext.Session.GetInt32("UserId");
            if (usuarioId == null)
            {
                TempData["Error"] = "Debe iniciar sesi√≥n para ver peticiones";
                return RedirectToAction("Login", "Auth");
            }

            var rol = HttpContext.Session.GetString("Rol");
            IQueryable<PeticionServicio> query = _context.PeticionesServicio;

            switch (rol)
            {
                case "SOLICITANTE":
                    query = query.Where(p => p.UsuarioSolicitanteId == usuarioId);
                    break;
                case "TECNICO":
                    query = query.Where(p => p.TecnicoAsignadoId == usuarioId || p.Estado == "PENDIENTE");
                    break;
            }

            var peticiones = await query
                .Include(p => p.Localidad)
                .Include(p => p.UsuarioSolicitante)
                .Include(p => p.TecnicoAsignado)
                .Include(p => p.Categoria)
                .Include(p => p.CriterioReparacion)
                .OrderByDescending(p => p.FechaSolicitud)
                .ToListAsync();

            ViewBag.UsuarioNombre = HttpContext.Session.GetString("NombreCompleto");
            ViewBag.UsuarioRol = rol;
            ViewBag.LocalidadUsuario = HttpContext.Session.GetString("LocalidadNombre");

            return View(peticiones);
        }

        // GET: Peticiones/Crear - CORREGIDO ‚úÖ
        public IActionResult Crear()
        {
            var usuarioId = HttpContext.Session.GetInt32("UserId");
            if (usuarioId == null)
            {
                TempData["Error"] = "Debe iniciar sesi√≥n para crear peticiones";
                return RedirectToAction("Login", "Auth");
            }

            // ‚úÖ CR√çTICO: Cargar localidades para el dropdown
            ViewBag.Localidades = _context.Localidades
                .Where(l => l.Activo)
                .OrderBy(l => l.Nombre)
                .ToList();

            return View(new PeticionServicio
            {
                UsuarioSolicitanteId = usuarioId.Value,
                LocalidadId = HttpContext.Session.GetInt32("LocalidadId") ?? 1,
                FechaSolicitud = DateTime.Now,
                Estado = "PENDIENTE",
                Prioridad = "MEDIA"
            });
        }

        // POST: Guardar nueva petici√≥n - ACTUALIZADO ‚úÖ
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Crear(PeticionServicio peticion)
        {
            var usuarioId = HttpContext.Session.GetInt32("UserId");
            var localidadId = HttpContext.Session.GetInt32("LocalidadId");

            if (usuarioId == null)
            {
                TempData["Error"] = "Debe iniciar sesi√≥n para crear peticiones";
                return RedirectToAction("Login", "Auth");
            }

            if (ModelState.IsValid)
            {
                // Asignar datos autom√°ticos
                peticion.UsuarioSolicitanteId = usuarioId.Value;
                peticion.LocalidadId = localidadId ?? 1;
                peticion.FechaSolicitud = DateTime.Now;
                peticion.Estado = "PENDIENTE";
                peticion.CreatedAt = DateTime.Now;

                // Si no viene TipoServicio, asignarlo desde categor√≠a
                if (string.IsNullOrEmpty(peticion.TipoServicio) && peticion.CategoriaId.HasValue)
                {
                    var categoria = await _context.CategoriasActividades
                        .FirstOrDefaultAsync(c => c.Id == peticion.CategoriaId);
                    if (categoria != null)
                    {
                        peticion.TipoServicio = categoria.NombreCategoria;
                    }
                }

                _context.PeticionesServicio.Add(peticion);
                await _context.SaveChangesAsync();

                TempData["Success"] = "¬°Petici√≥n creada exitosamente!";
                return RedirectToAction(nameof(Index));
            }

            // Recargar localidades si hay error
            ViewBag.Localidades = _context.Localidades
                .Where(l => l.Activo)
                .OrderBy(l => l.Nombre)
                .ToList();

            return View(peticion);
        }

        // ========== M√âTODOS API EXISTENTES ==========

        [HttpGet]
        public async Task<JsonResult> ObtenerCategoriasActividades()
        {
            var categorias = await _context.CategoriasActividades
                .Where(c => c.Activo)
                .Select(c => new { id = c.Id, nombre = c.NombreCategoria })
                .ToListAsync();
            return Json(categorias);
        }

        [HttpGet]
        public async Task<JsonResult> ObtenerActividadesPorCategoria(int categoriaId)
        {
            var actividades = await _context.ActividadesDetalle
                .Where(a => a.CategoriaId == categoriaId && a.Activo)
                .Select(a => new { id = a.Id, descripcion = a.Descripcion })
                .ToListAsync();
            return Json(actividades);
        }

        [HttpGet]
        public async Task<JsonResult> ObtenerCriteriosPorActividad(int actividadId)
        {
            var actividad = await _context.ActividadesDetalle
                .Where(a => a.Id == actividadId)
                .Select(a => a.CodigoActividad)
                .FirstOrDefaultAsync();

            if (actividad != null && actividad.Length > 0)
            {
                var primerCaracter = actividad.Substring(0, 1);
                var criterios = await _context.CriteriosReparacion
                    .Where(c => c.Codigo.StartsWith(primerCaracter) && c.Activo)
                    .Select(c => new { id = c.Id, descripcion = c.Descripcion, codigo = c.Codigo })
                    .ToListAsync();
                return Json(criterios);
            }
            return Json(new List<object>());
        }

        [HttpGet]
        public async Task<JsonResult> ObtenerTodasLocalidades()
        {
            var localidades = await _context.Localidades
                .Where(l => l.Activo)
                .Select(l => new { id = l.Id, nombre = l.Nombre })
                .OrderBy(l => l.nombre)
                .ToListAsync();
            return Json(localidades);
        }

        // ========== NUEVOS M√âTODOS PARA EL FORMULARIO ==========

        [HttpGet]
        public async Task<JsonResult> ObtenerCategoriasActivas()
        {
            var categorias = await _context.CategoriasActividades
                .Where(c => c.Activo)
                .Select(c => new { 
                    id = c.Id, 
                    nombre = c.NombreCategoria,
                    codigo = c.CodigoCategoria
                })
                .OrderBy(c => c.nombre)
                .ToListAsync();
            
            return Json(categorias);
        }

        [HttpGet]
        public async Task<JsonResult> ObtenerCriteriosPorCodigoCategoria(string codigoCategoria)
        {
            var criterios = await _context.CriteriosReparacion
                .Where(c => c.Activo && c.Codigo.StartsWith(codigoCategoria))
                .Select(c => new { 
                    id = c.Id, 
                    descripcion = c.Descripcion,
                    codigo = c.Codigo 
                })
                .OrderBy(c => c.descripcion)
                .ToListAsync();
            
            return Json(criterios);
        }

        // ========== M√âTODOS EXISTENTES (mantener) ==========

        public async Task<IActionResult> Dashboard()
        {
            var usuarioId = HttpContext.Session.GetInt32("UserId");
            var rol = HttpContext.Session.GetString("Rol");

            if (usuarioId == null || rol != "TECNICO")
            {
                TempData["Error"] = "No tiene permisos";
                return RedirectToAction("Index");
            }

            var peticiones = await _context.PeticionesServicio
                .Include(p => p.Localidad)
                .Include(p => p.UsuarioSolicitante)
                .Where(p => p.Estado == "PENDIENTE" || p.Estado == "EN_PROCESO")
                .OrderByDescending(p => p.Prioridad)
                .ThenBy(p => p.FechaSolicitud)
                .ToListAsync();

            ViewBag.TecnicoNombre = HttpContext.Session.GetString("NombreCompleto");
            ViewBag.PendientesCount = peticiones.Count(p => p.Estado == "PENDIENTE");
            ViewBag.ProcesoCount = peticiones.Count(p => p.Estado == "EN_PROCESO");

            return View(peticiones);
        }

        [HttpPost]
        public async Task<JsonResult> AsignarPeticion(int peticionId)
        {
            var tecnicoId = HttpContext.Session.GetInt32("UserId");
            var rol = HttpContext.Session.GetString("Rol");

            if (tecnicoId == null || rol != "TECNICO")
            {
                return Json(new { success = false, message = "No autorizado" });
            }

            try
            {
                var peticion = await _context.PeticionesServicio.FindAsync(peticionId);
                if (peticion == null)
                {
                    return Json(new { success = false, message = "Petici√≥n no encontrada" });
                }

                peticion.TecnicoAsignadoId = tecnicoId;
                peticion.Estado = "EN_PROCESO";

                _context.Update(peticion);
                await _context.SaveChangesAsync();

                return Json(new { success = true, message = "Petici√≥n asignada correctamente" });
            }
            catch (Exception ex)
            {
                return Json(new { success = false, message = "Error: " + ex.Message });
            }
        }

        public async Task<IActionResult> Detalles(int id)
        {
            var usuarioId = HttpContext.Session.GetInt32("UserId");
            if (usuarioId == null)
            {
                TempData["Error"] = "Debe iniciar sesi√≥n";
                return RedirectToAction("Login", "Auth");
            }

            var peticion = await _context.PeticionesServicio
                .Include(p => p.Localidad)
                .Include(p => p.UsuarioSolicitante)
                .Include(p => p.TecnicoAsignado)
                .Include(p => p.Categoria)
                .Include(p => p.CriterioReparacion)
                .Include(p => p.Reportes)
                .FirstOrDefaultAsync(p => p.Id == id);

            if (peticion == null)
            {
                return NotFound();
            }

            ViewBag.UsuarioRol = HttpContext.Session.GetString("Rol");
            ViewBag.UsuarioId = usuarioId;

            return View(peticion);
        }

        public async Task<IActionResult> Editar(int id)
        {
            var usuarioId = HttpContext.Session.GetInt32("UserId");
            if (usuarioId == null)
            {
                return RedirectToAction("Login", "Auth");
            }

            var peticion = await _context.PeticionesServicio
                .Include(p => p.Localidad)
                .Include(p => p.Categoria)
                .Include(p => p.CriterioReparacion)
                .FirstOrDefaultAsync(p => p.Id == id);

            if (peticion == null)
            {
                return NotFound();
            }

            // Cargar localidades para el dropdown
            ViewBag.Localidades = _context.Localidades
                .Where(l => l.Activo)
                .OrderBy(l => l.Nombre)
                .ToList();

            return View(peticion);
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Editar(int id, PeticionServicio peticion)
        {
            if (id != peticion.Id)
            {
                return NotFound();
            }

            if (ModelState.IsValid)
            {
                try
                {
                    _context.Update(peticion);
                    await _context.SaveChangesAsync();

                    TempData["Success"] = "¬°Petici√≥n actualizada exitosamente!";
                    return RedirectToAction(nameof(Index));
                }
                catch (DbUpdateConcurrencyException)
                {
                    if (!PeticionExists(peticion.Id))
                    {
                        return NotFound();
                    }
                    else
                    {
                        throw;
                    }
                }
            }
            return View(peticion);
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Eliminar(int id)
        {
            var usuarioId = HttpContext.Session.GetInt32("UserId");
            if (usuarioId == null)
            {
                return RedirectToAction("Login", "Auth");
            }

            var peticion = await _context.PeticionesServicio.FindAsync(id);
            if (peticion == null)
            {
                return NotFound();
            }

            _context.PeticionesServicio.Remove(peticion);
            await _context.SaveChangesAsync();

            TempData["Success"] = "¬°Petici√≥n eliminada exitosamente!";
            return RedirectToAction(nameof(Index));
        }

        private bool PeticionExists(int id)
        {
            return _context.PeticionesServicio.Any(e => e.Id == id);
        }
    }
}                                                                                                                                                                                                                                                                    4. Views/Peticiones/Index.cshtml (dashboard principal)
Para agregar las columnas de solicitante y departamento                                                                             @model IEnumerable<SistemaReportesWeb.Models.PeticionServicio>
@{
    ViewData["Title"] = "Peticiones de Servicio";
    var usuarioRol = ViewBag.UsuarioRol as string;
    var esSolicitante = usuarioRol == "SOLICITANTE";
    var esTecnico = usuarioRol == "TECNICO";
    var puedeCrearPeticiones = usuarioRol == "SOLICITANTE" || usuarioRol == "COORDINADOR" || usuarioRol == "SECRETARIA" || usuarioRol == "PROGRAMADOR";
    var puedeVerTodasPeticiones = usuarioRol == "COORDINADOR" || usuarioRol == "SECRETARIA" || usuarioRol == "PROGRAMADOR";
}

<div class="container mt-4">
    <!-- Header con informaci√≥n del usuario -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-clipboard-list me-2"></i>@ViewData["Title"]
                    </h2>
                    <p class="text-muted mb-0">
                        <i class="fas fa-user me-1"></i>
                        <strong>@ViewBag.UsuarioNombre</strong> - 
                        <span class="badge bg-info">@usuarioRol</span>
                        @if (esSolicitante)
                        {
                            <span class="badge bg-warning ms-2"><i class="fas fa-eye me-1"></i>Solo sus peticiones</span>
                        }
                        @if (puedeVerTodasPeticiones)
                        {
                            <span class="badge bg-success ms-2"><i class="fas fa-users me-1"></i>Todas las peticiones</span>
                        }
                    </p>
                </div>
                
                <div class="btn-group">
                    @if (puedeCrearPeticiones)
                    {
                        <a href="@Url.Action("Crear")" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>Nueva Petici√≥n
                        </a>
                    }
                    
                    @if (esTecnico)
                    {
                        <a href="@Url.Action("Dashboard")" class="btn btn-success">
                            <i class="fas fa-tachometer-alt me-2"></i>Dashboard T√©cnico
                        </a>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Tarjeta de estad√≠sticas -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-2">
                            <h4 class="text-primary">@Model.Count()</h4>
                            <small class="text-muted">Total</small>
                        </div>
                        <div class="col-md-2">
                            <h4 class="text-warning">@Model.Count(p => p.Estado == "PENDIENTE")</h4>
                            <small class="text-muted">Pendientes</small>
                        </div>
                        <div class="col-md-2">
                            <h4 class="text-info">@Model.Count(p => p.Estado == "EN_PROCESO")</h4>
                            <small class="text-muted">En Proceso</small>
                        </div>
                        <div class="col-md-2">
                            <h4 class="text-success">@Model.Count(p => p.Estado == "COMPLETADO")</h4>
                            <small class="text-muted">Completadas</small>
                        </div>
                        <div class="col-md-2">
                            <h4 class="text-danger">@Model.Count(p => p.Estado == "CANCELADO")</h4>
                            <small class="text-muted">Canceladas</small>
                        </div>
                        <div class="col-md-2">
                            <h4 class="text-secondary">@Model.Count(p => p.Prioridad == "ALTA")</h4>
                            <small class="text-muted">Prioridad Alta</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros r√°pidos -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body py-2">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary filter-btn active" data-filter="all">
                            <i class="fas fa-list me-1"></i>Todas (@Model.Count())
                        </button>
                        <button type="button" class="btn btn-outline-warning filter-btn" data-filter="PENDIENTE">
                            <i class="fas fa-clock me-1"></i>Pendientes (@Model.Count(p => p.Estado == "PENDIENTE"))
                        </button>
                        <button type="button" class="btn btn-outline-info filter-btn" data-filter="EN_PROCESO">
                            <i class="fas fa-cogs me-1"></i>En Proceso (@Model.Count(p => p.Estado == "EN_PROCESO"))
                        </button>
                        <button type="button" class="btn btn-outline-success filter-btn" data-filter="COMPLETADO">
                            <i class="fas fa-check me-1"></i>Completadas (@Model.Count(p => p.Estado == "COMPLETADO"))
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de peticiones -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>Lista de Peticiones
                        @if (esSolicitante)
                        {
                            <small class="text-muted">(Solo sus peticiones)</small>
                        }
                    </h5>
                </div>
                <div class="card-body">
                    @if (Model.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover" id="tablaPeticiones">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>T√≠tulo</th>
                                        @if (puedeVerTodasPeticiones)
                                        {
                                            <th>Solicitante</th>
                                        }
                                        <th>Localidad</th>
                                        <th>Tipo Servicio</th>
                                        <th>Prioridad</th>
                                        <th>Estado</th>
                                        @if (puedeVerTodasPeticiones || esTecnico)
                                        {
                                            <th>T√©cnico Asignado</th>
                                        }
                                        <th>Fecha Solicitud</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var peticion in Model)
                                    {
                                        <tr class="peticion-fila" data-estado="@peticion.Estado">
                                            <td>
                                                <strong>#@peticion.Id</strong>
                                            </td>
                                            <td>
                                                <div class="fw-bold">@peticion.Titulo</div>
                                                <small class="text-muted">
                                                    @(peticion.Descripcion.Length > 50 ? 
                                                      peticion.Descripcion.Substring(0, 50) + "..." : 
                                                      peticion.Descripcion)
                                                </small>
                                            </td>
                                            
                                            @if (puedeVerTodasPeticiones)
                                            {
                                                <!-- ‚úÖ CORREGIDO: UsuarioSolicitante existe en el modelo -->
                                                <td>@peticion.UsuarioSolicitante?.NombreCompleto</td>
                                            }
                                            
                                            <td>@peticion.Localidad?.Nombre</td>
                                            <td>
                                                <span class="badge bg-secondary">@peticion.TipoServicio</span>
                                            </td>
                                            <td>
                                                @{
                                                    var prioridadClass = peticion.Prioridad switch
                                                    {
                                                        "URGENTE" => "danger",
                                                        "ALTA" => "warning",
                                                        "MEDIA" => "info",
                                                        "BAJA" => "success",
                                                        _ => "secondary"
                                                    };
                                                }
                                                <span class="badge bg-@prioridadClass">@peticion.Prioridad</span>
                                            </td>
                                            <td>
                                                @{
                                                    var estadoClass = peticion.Estado switch
                                                    {
                                                        "PENDIENTE" => "warning",
                                                        "EN_PROCESO" => "info",
                                                        "COMPLETADO" => "success",
                                                        "CANCELADO" => "danger",
                                                        _ => "secondary"
                                                    };
                                                }
                                                <span class="badge bg-@estadoClass">@peticion.Estado</span>
                                            </td>
                                            
                                            @if (puedeVerTodasPeticiones || esTecnico)
                                            {
                                                <td>
                                                    @if (peticion.TecnicoAsignado != null)
                                                    {
                                                        <span class="text-success">@peticion.TecnicoAsignado.NombreCompleto</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">No asignado</span>
                                                    }
                                                </td>
                                            }
                                            
                                            <!-- ‚úÖ CORREGIDO: FechaSolicitud existe en el modelo -->
                                            <td>@peticion.FechaSolicitud.ToString("dd/MM/yyyy")</td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <!-- Ver Detalles -->
                                                    <a href="@Url.Action("Detalles", new { id = peticion.Id })" 
                                                       class="btn btn-outline-primary" title="Ver detalles">
                                                        <i class="fas fa-eye"></i>
                                                    </a>

                                                    <!-- Crear Reporte (solo t√©cnicos y roles superiores) -->
                                                    @if ((esTecnico && peticion.Estado != "PENDIENTE") || puedeVerTodasPeticiones)
                                                    {
                                                        <a href="@Url.Action("Crear", "Reportes", new { peticionId = peticion.Id })" 
                                                           class="btn btn-outline-success" title="Crear reporte">
                                                            <i class="fas fa-file-alt"></i>
                                                        </a>
                                                    }

                                                    <!-- Editar (solo solicitante de la petici√≥n o roles superiores) -->
                                                    <!-- ‚úÖ CORREGIDO: UsuarioSolicitanteId existe en el modelo -->
                                                    @if ((esSolicitante && peticion.UsuarioSolicitanteId.ToString() == ViewBag.UsuarioId?.ToString()) || puedeVerTodasPeticiones)
                                                    {
                                                        <a href="@Url.Action("Editar", new { id = peticion.Id })" 
                                                           class="btn btn-outline-warning" title="Editar petici√≥n">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                    }

                                                    <!-- Eliminar (solo roles superiores) -->
                                                    @if (puedeVerTodasPeticiones)
                                                    {
                                                        <form asp-action="Eliminar" method="post" class="d-inline" 
                                                              onsubmit="return confirm('¬øEst√° seguro de eliminar esta petici√≥n?');">
                                                            <input type="hidden" name="id" value="@peticion.Id" />
                                                            <button type="submit" class="btn btn-outline-danger" title="Eliminar">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </form>
                                                    }
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
                            <h4 class="text-muted">
                                @if (esSolicitante)
                                {
                                    @:No hay peticiones registradas
                                }
                                else
                                {
                                    @:No hay peticiones en el sistema
                                }
                            </h4>
                            <p class="text-muted">
                                @if (puedeCrearPeticiones)
                                {
                                    @:Comienza creando tu primera petici√≥n de servicio
                                }
                                else
                                {
                                    @:No hay peticiones asignadas o pendientes
                                }
                            </p>
                            @if (puedeCrearPeticiones)
                            {
                                <a href="@Url.Action("Crear")" class="btn btn-primary">
                                    <i class="fas fa-plus me-2"></i>Crear Primera Petici√≥n
                                </a>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Navegaci√≥n adicional -->
    <div class="row mt-4">
        <div class="col-12 text-center">
            <div class="btn-group" role="group">
                @if (esTecnico)
                {
                    <a href="@Url.Action("Dashboard")" class="btn btn-outline-info">
                        <i class="fas fa-tachometer-alt me-2"></i>Ir al Dashboard T√©cnico
                    </a>
                }
                
                @if (usuarioRol != "SOLICITANTE")
                {
                    <a href="@Url.Action("Index", "Reportes")" class="btn btn-outline-secondary">
                        <i class="fas fa-chart-bar me-2"></i>Ver Reportes del Sistema
                    </a>
                }

                <a href="@Url.Action("Logout", "Auth")" class="btn btn-outline-dark">
                    <i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesi√≥n
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Configuraci√≥n de DataTables
            $('#tablaPeticiones').DataTable({
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/Spanish.json"
                },
                "pageLength": 10,
                "order": [[0, "desc"]],
                "columnDefs": [
                    { "orderable": false, "targets": @(puedeVerTodasPeticiones ? 9 : 7) } // Columna de acciones no ordenable
                ]
            });

            // Filtros por estado
            $('.filter-btn').click(function() {
                $('.filter-btn').removeClass('active');
                $(this).addClass('active');
                
                var filter = $(this).data('filter');
                
                if (filter === 'all') {
                    $('.peticion-fila').show();
                } else {
                    $('.peticion-fila').hide();
                    $('.peticion-fila[data-estado="' + filter + '"]').show();
                }
            });

            // Auto-refresh cada 3 minutos para usuarios con permisos
            @if (puedeVerTodasPeticiones || esTecnico)
            {
                @:setInterval(function() {
                @:    if ($('.modal:visible').length === 0) {
                @:        console.log('Actualizando lista de peticiones...');
                @:        // En una versi√≥n futura podr√≠amos hacer AJAX aqu√≠
                @:    }
                @:}, 180000); // 3 minutos
            }
        });
    </script>

    <style>
        .peticion-fila {
            transition: all 0.3s ease;
        }
        .peticion-fila:hover {
            background-color: #f8f9fa;
            transform: translateY(-1px);
        }
        .badge {
            font-size: 0.75em;
        }
        .filter-btn.active {
            font-weight: bold;
            border-width: 2px;
        }
        .card {
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }
    </style>
}                                                                                                                                                                                             5. Views/Peticiones/Crear.cshtml
Para agregar el panel de verificaci√≥n para h√≠bridos                                                                             @model SistemaReportesWeb.Models.PeticionServicio
@{
    ViewData["Title"] = "Nueva Solicitud de Servicio";
}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0"><i class="fas fa-tools me-2"></i>@ViewData["Title"]</h4>
                </div>
                <div class="card-body">
                    <!-- Informaci√≥n del Usuario -->
                    <div class="alert alert-primary mb-4">
                        <div class="row">
                            <div class="col-md-6">
                                <strong><i class="fas fa-user me-2"></i>Solicitante:</strong>
                                <span>@Context.Session.GetString("UserName")</span>
                            </div>
                            <div class="col-md-6">
                                <strong><i class="fas fa-calendar me-2"></i>Fecha:</strong>
                                <span>@DateTime.Now.ToString("dd/MM/yyyy HH:mm")</span>
                            </div>
                        </div>
                    </div>

                    <form asp-action="Crear" method="post" id="formPeticion">
                        @Html.AntiForgeryToken()
                        
                        <!-- CAMPOS OCULTOS CR√çTICOS -->
                        <input type="hidden" asp-for="UsuarioSolicitanteId" value="@Context.Session.GetInt32("UserId")" />
                        <input type="hidden" asp-for="CategoriaId" id="categoriaId" />
                        <input type="hidden" asp-for="CriterioReparacionId" id="criterioId" />
                        <input type="hidden" asp-for="Titulo" id="tituloAutomatico" />
                        <input type="hidden" asp-for="TipoServicio" id="tipoServicioTexto" />
                        
                        <!-- ‚úÖ 2 DROPDOWNS QUE CONSULTAN BD -->
                        <div class="row">
                            <!-- 1. CATEGOR√çA (desde BD) -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Tipo de Servicio *</label>
                                    <select id="categoriaSelect" class="form-select" required>
                                        <option value="">Cargando categor√≠as...</option>
                                    </select>
                                </div>
                            </div>

                            <!-- 2. CRITERIO (filtrado por categor√≠a desde BD) -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Servicio Solicitado *</label>
                                    <select id="criterioSelect" class="form-select" required disabled>
                                        <option value="">Seleccione tipo de servicio primero</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Localidad (igual que antes) -->
                        <div class="mb-3">
                            <label asp-for="LocalidadId" class="form-label">Localidad *</label>
                            <select asp-for="LocalidadId" class="form-select" required>
                                <option value="">Seleccionar localidad</option>
                                @foreach (var localidad in ViewBag.Localidades)
                                {
                                    <option value="@localidad.Id">@localidad.Nombre</option>
                                }
                            </select>
                        </div>

                        <!-- Prioridad y Fecha -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Prioridad" class="form-label">Prioridad *</label>
                                    <select asp-for="Prioridad" class="form-select" required>
                                        <option value="BAJA">Baja - Rutinario</option>
                                        <option value="MEDIA" selected>Media - Normal</option>
                                        <option value="ALTA">Alta - Urgente</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="FechaLimite" class="form-label">Fecha L√≠mite *</label>
                                    <input asp-for="FechaLimite" type="date" class="form-control" 
                                           value="@DateTime.Now.AddDays(7).ToString("yyyy-MM-dd")" required>
                                    <small class="text-muted">M√°ximo 30 d√≠as desde hoy</small>
                                </div>
                            </div>
                        </div>

                        <!-- Descripci√≥n Autom√°tica -->
                        <div class="mb-3">
                            <label class="form-label">Descripci√≥n Autom√°tica</label>
                            <div class="card bg-light">
                                <div class="card-body">
                                    <p id="descripcionAutomatica" class="mb-0">
                                        Complete los campos para generar la descripci√≥n...
                                    </p>
                                </div>
                            </div>
                            <input type="hidden" asp-for="Descripcion" id="descripcionCompleta" />
                        </div>

                        <!-- Resumen -->
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-clipboard-check me-2"></i>Resumen:</h6>
                            <div id="resumenSolicitud" class="small">
                                Complete los campos...
                            </div>
                        </div>

                        <!-- Botones -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="@Url.Action("Index")" class="btn btn-outline-secondary me-2">
                                <i class="fas fa-times me-1"></i>Cancelar
                            </a>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-paper-plane me-1"></i>Enviar Solicitud
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    $(document).ready(function() {
        console.log("=== FORMULARIO DE PETICI√ìN ===");
        
        // 1. CARGAR CATEGOR√çAS DESDE BD
        cargarCategoriasDesdeBD();

        // 2. CUANDO CAMBIA CATEGOR√çA
        $('#categoriaSelect').change(function() {
            var selected = $(this).find('option:selected');
            var categoriaId = selected.val();
            var categoriaNombre = selected.text();
            var categoriaCodigo = selected.data('codigo');
            
            console.log("Categor√≠a seleccionada:", {
                id: categoriaId,
                nombre: categoriaNombre,
                codigo: categoriaCodigo
            });
            
            if (categoriaId) {
                // Guardar ID y texto
                $('#categoriaId').val(categoriaId);
                $('#tipoServicioTexto').val(categoriaNombre);
                
                // Habilitar y cargar criterios
                $('#criterioSelect').prop('disabled', false);
                cargarCriteriosPorCategoria(categoriaCodigo);
            } else {
                $('#criterioSelect').prop('disabled', true)
                    .html('<option value="">Seleccione tipo de servicio primero</option>');
                $('#criterioId').val('');
            }
            
            actualizarDescripcion();
        });

        // 3. CUANDO CAMBIA CRITERIO
        $('#criterioSelect').change(function() {
            var criterioId = $(this).val();
            $('#criterioId').val(criterioId);
            actualizarDescripcion();
        });

        // 4. VALIDAR ANTES DE ENVIAR
        $('#formPeticion').submit(function(e) {
            if (!$('#criterioSelect').val()) {
                e.preventDefault();
                alert('‚ùå Por favor seleccione un servicio solicitado');
                return false;
            }
            
            prepararDatosParaEnvio();
            console.log("‚úÖ Enviando formulario...");
        });
    });

    // ========== FUNCIONES ==========

    // 1. CARGAR CATEGOR√çAS DESDE BD
    function cargarCategoriasDesdeBD() {
        $.ajax({
            url: '/Peticiones/ObtenerCategoriasActivas',
            type: 'GET',
            success: function(data) {
                console.log("Categor√≠as desde BD:", data);
                
                var select = $('#categoriaSelect');
                select.empty().append('<option value="">Seleccionar tipo de servicio...</option>');
                
                $.each(data, function(i, cat) {
                    select.append($('<option>', {
                        value: cat.id,
                        text: cat.nombre,
                        'data-codigo': cat.codigo || ''
                    }));
                });
            },
            error: function() {
                $('#categoriaSelect').html(
                    '<option value="">Error cargando categor√≠as</option>'
                );
            }
        });
    }

    // 2. CARGAR CRITERIOS POR C√ìDIGO DE CATEGOR√çA (CORREGIDO)
function cargarCriteriosPorCategoria(codigoCategoria) {
    console.log("üîç Buscando criterios para c√≥digo:", codigoCategoria);
    
    $.ajax({
         url: '/Peticiones/ObtenerCriteriosPorCodigoCategoria',  // ‚úÖ NUEVO NOMBRE
        type: 'GET',
        data: { codigoCategoria: codigoCategoria },
        success: function(data) {
            console.log("‚úÖ Criterios encontrados:", data);
            actualizarDropdownCriterios(data);
        },
        error: function(xhr, status, error) {
            console.error("‚ùå Error cargando criterios:", error);
            $('#criterioSelect').html('<option value="">Error cargando servicios</option>');
            
            // Opcional: Intentar con el m√©todo antiguo como fallback
            intentarMetodoAntiguo(codigoCategoria);
        }
    });
}

// 2.1. FUNCI√ìN DE FALLBACK (opcional)
function intentarMetodoAntiguo(codigoCategoria) {
    console.log("üîÑ Intentando con m√©todo antiguo...");
    
    // Primero buscar una actividad que tenga ese c√≥digo
    $.ajax({
        url: '@Url.Action("ObtenerActividadesPorCategoria", "Peticiones")',
        type: 'GET',
        data: { categoriaId: 1 }, // Suponiendo que categor√≠a 1 tiene ese c√≥digo
        success: function(actividades) {
            if (actividades && actividades.length > 0) {
                // Tomar la primera actividad y buscar criterios
                var primeraActividad = actividades[0];
                $.ajax({
                    url: '@Url.Action("ObtenerCriteriosPorActividad", "Peticiones")',
                    type: 'GET',
                    data: { actividadId: primeraActividad.id },
                    success: function(criterios) {
                        // Filtrar por c√≥digo manualmente
                        var criteriosFiltrados = criterios.filter(function(crit) {
                            return crit.codigo && crit.codigo.startsWith(codigoCategoria);
                        });
                        actualizarDropdownCriterios(criteriosFiltrados);
                    }
                });
            }
        }
    });
}

// 3. ACTUALIZAR DROPDOWN DE CRITERIOS (COMPLETO)
function actualizarDropdownCriterios(criterios) {
    var select = $('#criterioSelect');
    select.empty();
    
    if (criterios && criterios.length > 0) {
        select.append('<option value="">Seleccionar servicio...</option>');
        $.each(criterios, function(i, crit) {
            // Mostrar c√≥digo entre par√©ntesis si existe
            var texto = crit.descripcion;
            if (crit.codigo) {
                texto += ' (' + crit.codigo + ')';
            }
            
            select.append($('<option>', {
                value: crit.id,
                text: texto,
                'data-codigo': crit.codigo || ''
            }));
        });
        
        // Si solo hay un criterio, seleccionarlo autom√°ticamente
        if (criterios.length === 1) {
            select.val(criterios[0].id).trigger('change');
        }
    } else {
        select.append('<option value="">No hay servicios para esta categor√≠a</option>');
        $('#criterioError').text('No se encontraron servicios para "' + codigoCategoria + '"');
    }
    
    // Habilitar el dropdown si hay opciones
    select.prop('disabled', criterios && criterios.length > 0 ? false : true);
}

    

    // 4. ACTUALIZAR DESCRIPCI√ìN
    function actualizarDescripcion() {
        var categoria = $('#categoriaSelect option:selected').text();
        var criterio = $('#criterioSelect option:selected').text();
        var prioridad = $('#Prioridad').val();
        var fechaLimite = $('#FechaLimite').val();
        var localidad = $('#LocalidadId option:selected').text();
        
        var descripcion = 'SOLICITUD DE SERVICIO T√âCNICO\n';
        descripcion += '===============================\n';
        
        if (categoria && categoria !== 'Seleccionar tipo de servicio...') {
            descripcion += 'Tipo de Servicio: ' + categoria + '\n';
        }
        
        if (criterio && criterio !== 'Seleccionar servicio...') {
            descripcion += 'Servicio Solicitado: ' + criterio + '\n';
        }
        
        if (prioridad) {
            descripcion += 'Prioridad: ' + prioridad + '\n';
        }
        
        if (fechaLimite) {
            descripcion += 'Fecha L√≠mite: ' + new Date(fechaLimite).toLocaleDateString() + '\n';
        }
        
        if (localidad && localidad !== 'Seleccionar localidad') {
            descripcion += 'Localidad: ' + localidad + '\n';
        }
        
        descripcion += 'Fecha de Solicitud: ' + new Date().toLocaleDateString() + '\n';
        descripcion += 'Solicitante: ' + '@Context.Session.GetString("UserName")' + '\n';
        descripcion += 'Estado: PENDIENTE';
        
        $('#descripcionAutomatica').text(descripcion);
    }

    // 5. PREPARAR DATOS PARA ENV√çO
    function prepararDatosParaEnvio() {
        // Descripci√≥n completa
        var descripcion = $('#descripcionAutomatica').text();
        $('#descripcionCompleta').val(descripcion);
        
        // T√≠tulo autom√°tico
        var categoria = $('#categoriaSelect option:selected').text();
        var criterio = $('#criterioSelect option:selected').text();
        var fecha = new Date().toLocaleDateString();
        var titulo = categoria + ' - ' + criterio.split('(')[0].trim() + ' - ' + fecha;
        $('#tituloAutomatico').val(titulo.substring(0, 200));
    }
</script>
}
¬°Excelente! Ahora tengo toda la informaci√≥n necesaria. Veo exactamente c√≥mo est√° estructurado tu sistema. Voy a darte el c√≥digo espec√≠fico y exacto para tus archivos.

üéØ AN√ÅLISIS R√ÅPIDO:
‚úÖ Ya tienes UsuarioSolicitante en PeticionServicio.cs - ¬°Perfecto!

‚úÖ Ya tienes la relaci√≥n UsuarioSolicitante cargada en las vistas

‚úÖ Falta mostrar el departamento del solicitante en el dashboard

‚úÖ Falta los campos de trazabilidad para h√≠bridos

üöÄ PLAN DE IMPLEMENTACI√ìN (PASO A PASO):
PASO 1: Crear RolesSistema.cs (YA LISTO - solo copiar y pegar)
csharp
// Crear archivo: SistemaReportesWeb/Constantes/RolesSistema.cs

namespace SistemaReportesWeb.Constantes
{
    public static class RolesSistema
    {
        // Roles con los valores EXACTOS que usar√°s en BD
        public const string ADMIN = "ADMIN";
        public const string COORDINADOR = "COORDINADOR";
        public const string HIBRIDO = "HIBRIDO";
        public const string TECNICO = "TECNICO";
        public const string SOLICITANTE = "SOLICITANTE";

        // M√©todos de ayuda (se usan en l√≥gica de permisos)
        public static bool PuedeCrearPeticiones(string rol)
        {
            return rol == SOLICITANTE || rol == HIBRIDO || rol == ADMIN;
        }

        public static bool PuedeAtenderPeticiones(string rol)
        {
            return rol == TECNICO || rol == HIBRIDO || rol == COORDINADOR || rol == ADMIN;
        }

        public static bool PuedeVerTodasLocalidades(string rol)
        {
            return rol == COORDINADOR || rol == ADMIN;
        }

        public static bool SoloSuLocalidad(string rol)
        {
            return rol == TECNICO || rol == HIBRIDO;
        }

        public static bool RequiereVerificacionOrigen(string rol)
        {
            return rol == HIBRIDO;
        }

        // Lista para dropdowns o validaciones
        public static List<string> TodosLosRoles()
        {
            return new List<string> { ADMIN, COORDINADOR, HIBRIDO, TECNICO, SOLICITANTE };
        }

        // Para ordenar o comparar niveles
        public static int NivelAcceso(string rol)
        {
            return rol switch
            {
                ADMIN => 100,
                COORDINADOR => 80,
                HIBRIDO => 60,
                TECNICO => 40,
                SOLICITANTE => 20,
                _ => 0
            };
        }
    }
}
PASO 2: Agregar campos de trazabilidad a PeticionServicio.cs
csharp
// MODIFICAR tu archivo Models/PeticionServicio.cs - AGREGAR esto al final de la clase:

[Column("origen_verificado")]
public bool OrigenVerificado { get; set; } = true;

[Column("usuario_origen_real_id")]
public int? UsuarioOrigenRealId { get; set; }

[Column("departamento_origen")]
[StringLength(100)]
public string? DepartamentoOrigen { get; set; }

[Column("es_urgente_telefono")]
public bool EsUrgenteTelefono { get; set; } = false;

[Column("fecha_verificacion")]
public DateTime? FechaVerificacion { get; set; }

[Column("verificado_por_id")]
public int? VerificadoPorId { get; set; }

// ‚úÖ NUEVAS RELACIONES (agregar junto con las otras relaciones)
[ForeignKey("UsuarioOrigenRealId")]
public virtual Usuario? UsuarioOrigenReal { get; set; }

[ForeignKey("VerificadoPorId")]
public virtual Usuario? VerificadoPor { get; set; }
PASO 3: SQL para agregar campos a la BD
sql
-- Ejecutar en tu base de datos:
ALTER TABLE peticiones_servicio 
ADD COLUMN origen_verificado BOOLEAN DEFAULT TRUE,
ADD COLUMN usuario_origen_real_id INT NULL,
ADD COLUMN departamento_origen VARCHAR(100) NULL,
ADD COLUMN es_urgente_telefono BOOLEAN DEFAULT FALSE,
ADD COLUMN fecha_verificacion DATETIME NULL,
ADD COLUMN verificado_por_id INT NULL;

-- Agregar foreign keys:
ALTER TABLE peticiones_servicio
ADD FOREIGN KEY (usuario_origen_real_id) REFERENCES usuarios(id),
ADD FOREIGN KEY (verificado_por_id) REFERENCES usuarios(id);
PASO 4: Modificar Views/Peticiones/Index.cshtml para mostrar solicitante y departamento
html
<!-- ENCONTRAR esta secci√≥n en tu Index.cshtml (alrededor de la l√≠nea 140): -->
@if (puedeVerTodasPeticiones)
{
    <!-- ‚úÖ CORREGIDO: UsuarioSolicitante existe en el modelo -->
    <td>@peticion.UsuarioSolicitante?.NombreCompleto</td>
}

<!-- CAMBIAR POR ESTO: -->
@if (puedeVerTodasPeticiones)
{
    <td>
        <!-- SOLICITANTE CON DEPARTAMENTO -->
        <div class="fw-bold">@peticion.UsuarioSolicitante?.NombreCompleto</div>
        <small class="text-muted">
            <i class="fas fa-building me-1"></i>
            @peticion.UsuarioSolicitante?.Departamento
        </small>
        
        <!-- INDICADOR SI ES VERIFICADO -->
        @if (!peticion.OrigenVerificado)
        {
            <div class="mt-1">
                <span class="badge bg-warning">
                    <i class="fas fa-exclamation-triangle me-1"></i>No verificado
                </span>
            </div>
        }
        @if (peticion.EsUrgenteTelefono)
        {
            <div class="mt-1">
                <span class="badge bg-danger">
                    <i class="fas fa-phone me-1"></i>Por tel√©fono
                </span>
            </div>
        }
    </td>
}
PASO 5: Modificar Views/Peticiones/Crear.cshtml para h√≠bridos
html
<!-- AGREGAR ESTO DESPU√âS de la secci√≥n "Botones" (antes del </form>): -->

<!-- PANEL PARA USUARIOS H√çBRIDOS -->
@{
    var usuarioRol = Context.Session.GetString("Rol");
}
@if (usuarioRol == "HIBRIDO")
{
    <div class="card mt-4 border-warning">
        <div class="card-header bg-warning text-dark">
            <i class="fas fa-user-check"></i> VERIFICACI√ìN DE ORIGEN (Modo H√≠brido)
        </div>
        <div class="card-body">
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="noSoyOrigen" name="noSoyOrigen">
                <label class="form-check-label fw-bold" for="noSoyOrigen">
                    <i class="fas fa-exclamation-triangle text-danger"></i>
                    NO soy el solicitante real (estoy creando para otro usuario)
                </label>
            </div>
            
            <div id="panelVerificacion" style="display: none;">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    Como usuario H√çBRIDO, debes especificar el origen real de esta solicitud.
                    Esto quedar√° registrado en auditor√≠a para trazabilidad.
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">Solicitante Real *</label>
                        <select class="form-select" id="solicitanteReal">
                            <option value="">Seleccionar usuario...</option>
                            <!-- Se cargar√° por AJAX -->
                        </select>
                        <input type="hidden" asp-for="UsuarioOrigenRealId" id="usuarioOrigenRealId" />
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label">Motivo *</label>
                        <select class="form-select" id="motivoVerificacion">
                            <option value="false">Seleccionar motivo...</option>
                            <option value="true">üìû Urgente por tel√©fono</option>
                            <option value="false">üë§ Usuario ausente</option>
                            <option value="false">üìã Capacitaci√≥n/Soporte</option>
                            <option value="false">üîß Equipo no disponible</option>
                        </select>
                        <input type="hidden" asp-for="EsUrgenteTelefono" id="esUrgenteTelefono" />
                    </div>
                </div>
                
                <div class="mt-3">
                    <label class="form-label">Observaciones adicionales</label>
                    <textarea class="form-control" asp-for="Descripcion" 
                              placeholder="Detallar por qu√© se crea esta petici√≥n en nombre de otro usuario..." 
                              id="descripcionExtra"></textarea>
                </div>
            </div>
        </div>
    </div>
    
    <script>
    $(document).ready(function() {
        // Panel de verificaci√≥n para h√≠bridos
        $('#noSoyOrigen').change(function() {
            if ($(this).is(':checked')) {
                $('#panelVerificacion').slideDown();
                $('#solicitanteReal').prop('required', true);
                cargarSolicitantesReales();
            } else {
                $('#panelVerificacion').slideUp();
                $('#solicitanteReal').prop('required', false);
            }
        });
        
        $('#solicitanteReal').change(function() {
            $('#usuarioOrigenRealId').val($(this).val());
        });
        
        $('#motivoVerificacion').change(function() {
            $('#esUrgenteTelefono').val($(this).val() === 'true');
        });
        
        // Funci√≥n para cargar usuarios solicitantes reales
        function cargarSolicitantesReales() {
            $.ajax({
                url: '/Peticiones/ObtenerSolicitantesReales',
                type: 'GET',
                success: function(data) {
                    var select = $('#solicitanteReal');
                    select.empty().append('<option value="">Seleccionar usuario...</option>');
                    
                    $.each(data, function(i, user) {
                        select.append($('<option>', {
                            value: user.id,
                            text: user.nombreCompleto + ' - ' + user.departamento
                        }));
                    });
                },
                error: function() {
                    $('#solicitanteReal').html('<option value="">Error cargando usuarios</option>');
                }
            });
        }
    });
    </script>
}
PASO 6: Modificar Controllers/PeticionesController.cs (m√©todo Crear POST)
csharp
// REEMPLAZAR el m√©todo Crear POST actual por este:

[HttpPost]
[ValidateAntiForgeryToken]
public async Task<IActionResult> Crear(PeticionServicio peticion, bool noSoyOrigen = false)
{
    var usuarioId = HttpContext.Session.GetInt32("UserId");
    var localidadId = HttpContext.Session.GetInt32("LocalidadId");
    var usuarioRol = HttpContext.Session.GetString("Rol");

    if (usuarioId == null)
    {
        TempData["Error"] = "Debe iniciar sesi√≥n para crear peticiones";
        return RedirectToAction("Login", "Auth");
    }

    if (ModelState.IsValid)
    {
        // Asignar datos autom√°ticos
        peticion.UsuarioSolicitanteId = usuarioId.Value;
        peticion.LocalidadId = localidadId ?? 1;
        peticion.FechaSolicitud = DateTime.Now;
        peticion.Estado = "PENDIENTE";
        peticion.CreatedAt = DateTime.Now;
        peticion.OrigenVerificado = true; // Por defecto s√≠

        // L√≥gica para usuarios H√çBRIDOS
        if (usuarioRol == "HIBRIDO" && noSoyOrigen && peticion.UsuarioOrigenRealId.HasValue)
        {
            // Usuario h√≠brido creando para otro
            peticion.OrigenVerificado = true;
            peticion.VerificadoPorId = usuarioId;
            peticion.FechaVerificacion = DateTime.Now;
            peticion.EsUrgenteTelefono = peticion.EsUrgenteTelefono;
            
            // Obtener departamento del usuario real
            var usuarioReal = await _context.Usuarios
                .FindAsync(peticion.UsuarioOrigenRealId.Value);
            peticion.DepartamentoOrigen = usuarioReal?.Departamento;
            
            // Auditor√≠a
            _context.LogsAuditoria.Add(new LogAuditoria
            {
                UsuarioId = usuarioId.Value,
                Accion = "CREACION_VERIFICADA",
                Detalle = $"Petici√≥n creada por h√≠brido para usuario real ID: {peticion.UsuarioOrigenRealId}",
                Fecha = DateTime.Now,
                IpAddress = HttpContext.Connection.RemoteIpAddress?.ToString()
            });
        }
        else
        {
            // Usuario normal o h√≠brido creando para s√≠ mismo
            peticion.UsuarioOrigenRealId = usuarioId;
            var usuarioActual = await _context.Usuarios.FindAsync(usuarioId);
            peticion.DepartamentoOrigen = usuarioActual?.Departamento;
        }

        // Si no viene TipoServicio, asignarlo desde categor√≠a
        if (string.IsNullOrEmpty(peticion.TipoServicio) && peticion.CategoriaId.HasValue)
        {
            var categoria = await _context.CategoriasActividades
                .FirstOrDefaultAsync(c => c.Id == peticion.CategoriaId);
            if (categoria != null)
            {
                peticion.TipoServicio = categoria.NombreCategoria;
            }
        }

        _context.PeticionesServicio.Add(peticion);
        await _context.SaveChangesAsync();

        TempData["Success"] = "¬°Petici√≥n creada exitosamente!";
        return RedirectToAction(nameof(Index));
    }

    // Recargar localidades si hay error
    ViewBag.Localidades = _context.Localidades
        .Where(l => l.Activo)
        .OrderBy(l => l.Nombre)
        .ToList();

    return View(peticion);
}

// AGREGAR este m√©todo nuevo al controlador (para cargar solicitantes reales):
[HttpGet]
public async Task<JsonResult> ObtenerSolicitantesReales()
{
    var solicitantes = await _context.Usuarios
        .Where(u => u.Activo && u.Rol == "SOLICITANTE")
        .Select(u => new 
        { 
            id = u.Id, 
            nombreCompleto = u.NombreCompleto,
            departamento = u.Departamento,
            localidad = u.Localidad.Nombre
        })
        .OrderBy(u => u.nombreCompleto)
        .ToListAsync();
    
    return Json(solicitantes);
}
PASO 7: SQL para actualizar roles de usuarios
sql
-- 1. Ver usuarios actuales
SELECT id, username, nombre_completo, rol, localidad_id, departamento 
FROM usuarios 
WHERE activo = 1 
ORDER BY nombre_completo;

-- 2. Actualizar seg√∫n tu lista:
UPDATE usuarios SET rol = 'ADMIN' WHERE username = 'gustavo_gimenez' OR nombre_completo LIKE '%Gustavo%';
UPDATE usuarios SET rol = 'COORDINADOR' WHERE nombre_completo LIKE '%Rafael Escobar%';
UPDATE usuarios SET rol = 'HIBRIDO' WHERE nombre_completo IN ('Sandy', 'Enrique');
UPDATE usuarios SET rol = 'TECNICO' WHERE nombre_completo IN ('Brayan', 'Moises Chavez', 'Nerio', 'Maria', 'Eudy');

-- 3. Verificar cambios:
SELECT rol, COUNT(*) as cantidad
FROM usuarios 
WHERE activo = 1
GROUP BY rol
ORDER BY COUNT(*) DESC;
üìã RESUMEN DE QU√â HACER:
‚úÖ Crear archivo Constantes/RolesSistema.cs

‚úÖ Modificar Models/PeticionServicio.cs (agregar campos de trazabilidad)

‚úÖ Ejecutar SQL para agregar campos a BD y actualizar roles

‚úÖ Modificar Views/Peticiones/Index.cshtml (mostrar departamento)

‚úÖ Modificar Views/Peticiones/Crear.cshtml (panel para h√≠bridos)

‚úÖ Modificar Controllers/PeticionesController.cs (m√©todo Crear POST)

üöÄ ¬øPOR D√ìNDE COMENZAMOS?
Te sugiero este orden:

SQL primero - Ejecuta los scripts de BD

Constantes - Crea el archivo RolesSistema.cs

Modelo - Modifica PeticionServicio.cs

Vista Index - Modifica para mostrar departamento

Controlador - Agrega la l√≥gica para h√≠bridos

Vista Crear - Agrega el panel de verificaci√≥n

¬øQuieres que te prepare alguno de estos pasos en m√°s detalle? ¬øO prefieres que empecemos con uno espec√≠fico? üéØ

¬°Todo est√° listo para implementar!

puedes arrglar la bd aparecen muchos solicitantes y solo son 3 por ahora  aca te dejo la tabla para arreglar la Bd;                                                                                                                                    nombre	rol	departamento
Maria Mora	Tecnico	Informatica
Alberto Mendoza	Tecnico	Informatica
Alberth Viloria	Tecnico	Informatica
 Jhoselin Weffer	Tecnico	Informatica
Maria Valenzuela	Tecnico	Informatica
 Reynaldo Pulido 	Tecnico	Informatica
Gustavo Gimenez	Tecnico	Informatica
Moises Chavez	Tecnico	Informatica
Jhoseph Lugo	Tecnico	Informatica
Freddy Vallejo	Tecnico	Informatica
Eudy Medina 	Tecnico	Informatica
Reyniel Medina	Tecnico	Informatica
Ali Rodriguez	Solicitante	FARMACIA
Nerio Salazar 	Tecnico	Informatica
Brayan Querales	Tecnico	Informatica
Jorge mota	solicitante	RRHH
Haydee Alvarez	Solicitante	Registros Medicos
Luis Rodriguez	Solicitante	Direccion
Sandy Oviedo	hibrido	Informatica
Enrique Reyes	hibrido	Informatica
¬°Perfecto! Voy a crear el script SQL completo para limpiar y organizar tu base de datos. Bas√°ndome en tu lista, necesitamos:

üéØ ESTADO ACTUAL VS LO QUE DEBER√çA SER:
Problemas identificados:
‚úÖ Gustavo Gimenez deber√≠a ser ADMIN, no T√©cnico

‚úÖ Sandy Oviedo y Enrique Reyes deber√≠an ser HIBRIDO

‚úÖ Ali Rodriguez, Jorge Mota, Haydee Alvarez, Luis Rodriguez son SOLICITANTES (correcto)

‚úÖ Los dem√°s son T√âCNICOS

‚ùå Falta Rafael Escobar como COORDINADOR

üöÄ SCRIPT SQL COMPLETO PARA LIMPIAR Y ORGANIZAR:
sql
-- ============================================
-- 1. LIMPIAR USUARIOS DUPLICADOS/INACTIVOS
-- ============================================
-- Primero, ver usuarios actuales
SELECT id, nombre_completo, username, rol, departamento, activo 
FROM usuarios 
ORDER BY nombre_completo;

-- Desactivar usuarios que no est√°n en tu lista (mantener datos hist√≥ricos)
UPDATE usuarios 
SET activo = 0 
WHERE nombre_completo NOT IN (
    'Maria Mora', 'Alberto Mendoza', 'Alberth Viloria', 'Jhoselin Weffer',
    'Maria Valenzuela', 'Reynaldo Pulido', 'Gustavo Gimenez', 'Moises Chavez',
    'Jhoseph Lugo', 'Freddy Vallejo', 'Eudy Medina', 'Reyniel Medina',
    'Ali Rodriguez', 'Nerio Salazar', 'Brayan Querales', 'Jorge mota',
    'Haydee Alvarez', 'Luis Rodriguez', 'Sandy Oviedo', 'Enrique Reyes',
    'Rafael Escobar'
) AND activo = 1;

-- ============================================
-- 2. CORREGIR ROLES SEG√öN TU LISTA
-- ============================================

-- Administrador
UPDATE usuarios 
SET rol = 'ADMIN', departamento = 'Informatica', localidad_id = 1
WHERE nombre_completo = 'Gustavo Gimenez';

-- Coordinador (agregar si no existe)
INSERT INTO usuarios (nombre_completo, username, password, rol, departamento, localidad_id, activo)
SELECT 'Rafael Escobar', 'rescobar', '123456', 'COORDINADOR', 'Coordinaci√≥n', 1, 1
WHERE NOT EXISTS (SELECT 1 FROM usuarios WHERE nombre_completo = 'Rafael Escobar');

-- H√≠bridos
UPDATE usuarios 
SET rol = 'HIBRIDO', departamento = 'Informatica', localidad_id = 1
WHERE nombre_completo IN ('Sandy Oviedo', 'Enrique Reyes');

-- T√©cnicos
UPDATE usuarios 
SET rol = 'TECNICO', departamento = 'Informatica', localidad_id = 1
WHERE nombre_completo IN (
    'Maria Mora', 'Alberto Mendoza', 'Alberth Viloria', 'Jhoselin Weffer',
    'Maria Valenzuela', 'Reynaldo Pulido', 'Moises Chavez', 'Jhoseph Lugo',
    'Freddy Vallejo', 'Eudy Medina', 'Reyniel Medina', 'Nerio Salazar',
    'Brayan Querales'
);

-- Solicitantes
UPDATE usuarios 
SET rol = 'SOLICITANTE'
WHERE nombre_completo IN ('Ali Rodriguez', 'Jorge mota', 'Haydee Alvarez', 'Luis Rodriguez');

-- ============================================
-- 3. ASIGNAR DEPARTAMENTOS CORRECTOS
-- ============================================
UPDATE usuarios 
SET departamento = 'FARMACIA' 
WHERE nombre_completo = 'Ali Rodriguez';

UPDATE usuarios 
SET departamento = 'RRHH' 
WHERE nombre_completo = 'Jorge mota';

UPDATE usuarios 
SET departamento = 'Registros Medicos' 
WHERE nombre_completo = 'Haydee Alvarez';

UPDATE usuarios 
SET departamento = 'Direccion' 
WHERE nombre_completo = 'Luis Rodriguez';

-- ============================================
-- 4. CREAR USERNAMES SI NO EXISTEN
-- ============================================
-- Generar usernames autom√°ticos (primera letra nombre + apellido)
UPDATE usuarios 
SET username = LOWER(
    CONCAT(
        SUBSTRING(nombre_completo, 1, 1),
        REPLACE(SUBSTRING_INDEX(nombre_completo, ' ', -1), ' ', '')
    )
)
WHERE (username IS NULL OR username = '') AND nombre_completo IS NOT NULL;

-- Casos especiales con nombres compuestos
UPDATE usuarios SET username = 'gustavogimenez' WHERE nombre_completo = 'Gustavo Gimenez';
UPDATE usuarios SET username = 'rafaelescobar' WHERE nombre_completo = 'Rafael Escobar';
UPDATE usuarios SET username = 'sandyoviedo' WHERE nombre_completo = 'Sandy Oviedo';
UPDATE usuarios SET username = 'enriquereyes' WHERE nombre_completo = 'Enrique Reyes';

-- ============================================
-- 5. ESTABLECER CONTRASE√ëAS POR DEFECTO
-- ============================================
-- Para pruebas: todas las contrase√±as ser√°n '123456' (hash en producci√≥n)
UPDATE usuarios 
SET password = '123456', password_hash = NULL 
WHERE password IS NULL OR password = '';

-- ============================================
-- 6. ASIGNAR LOCALIDADES (si tienes la tabla localidades)
-- ============================================
-- Asumir que todos est√°n en localidad 1 (principal) si no tienen
UPDATE usuarios 
SET localidad_id = 1 
WHERE localidad_id IS NULL;

-- ============================================
-- 7. VERIFICAR RESULTADO FINAL
-- ============================================
SELECT 
    rol,
    COUNT(*) as cantidad,
    GROUP_CONCAT(nombre_completo ORDER BY nombre_completo SEPARATOR ', ') as usuarios
FROM usuarios 
WHERE activo = 1
GROUP BY rol
ORDER BY 
    CASE rol
        WHEN 'ADMIN' THEN 1
        WHEN 'COORDINADOR' THEN 2
        WHEN 'HIBRIDO' THEN 3
        WHEN 'TECNICO' THEN 4
        WHEN 'SOLICITANTE' THEN 5
        ELSE 6
    END;

-- Vista detallada
SELECT 
    id,
    nombre_completo,
    username,
    rol,
    departamento,
    localidad_id,
    activo
FROM usuarios 
WHERE activo = 1
ORDER BY 
    CASE rol
        WHEN 'ADMIN' THEN 1
        WHEN 'COORDINADOR' THEN 2
        WHEN 'HIBRIDO' THEN 3
        WHEN 'TECNICO' THEN 4
        WHEN 'SOLICITANTE' THEN 5
        ELSE 6
    END,
    nombre_completo;
üõ°Ô∏è SCRIPT ALTERNATIVO (M√ÅS SEGURO - PASO A PASO):
Si prefieres hacerlo paso a paso:

Paso 1: Verificar estado actual
sql
-- Ver todos los usuarios activos
SELECT id, nombre_completo, rol, departamento, activo 
FROM usuarios 
WHERE activo = 1
ORDER BY nombre_completo;
Paso 2: Desactivar usuarios no deseados
sql
-- Solo desactivar (no eliminar) para mantener historial
UPDATE usuarios 
SET activo = 0, 
    fecha_creacion = NOW(),
    observaciones = 'Desactivado por limpieza de BD - ' || CURDATE()
WHERE activo = 1 
AND nombre_completo NOT IN (
    'Maria Mora', 'Alberto Mendoza', 'Alberth Viloria', 'Jhoselin Weffer',
    'Maria Valenzuela', 'Reynaldo Pulido', 'Gustavo Gimenez', 'Moises Chavez',
    'Jhoseph Lugo', 'Freddy Vallejo', 'Eudy Medina', 'Reyniel Medina',
    'Ali Rodriguez', 'Nerio Salazar', 'Brayan Querales', 'Jorge mota',
    'Haydee Alvarez', 'Luis Rodriguez', 'Sandy Oviedo', 'Enrique Reyes'
);
Paso 3: Insertar usuarios faltantes
sql
-- Insertar Rafael Escobar si no existe
INSERT INTO usuarios (nombre_completo, username, password, rol, departamento, localidad_id, activo, fecha_creacion)
SELECT 'Rafael Escobar', 'rescobar', '123456', 'COORDINADOR', 'Coordinaci√≥n', 1, 1, NOW()
WHERE NOT EXISTS (SELECT 1 FROM usuarios WHERE nombre_completo = 'Rafael Escobar');
Paso 4: Actualizar roles masivamente
sql
-- Actualizar todos los roles de una vez
UPDATE usuarios 
SET rol = 
    CASE 
        WHEN nombre_completo = 'Gustavo Gimenez' THEN 'ADMIN'
        WHEN nombre_completo = 'Rafael Escobar' THEN 'COORDINADOR'
        WHEN nombre_completo IN ('Sandy Oviedo', 'Enrique Reyes') THEN 'HIBRIDO'
        WHEN nombre_completo IN ('Ali Rodriguez', 'Jorge mota', 'Haydee Alvarez', 'Luis Rodriguez') THEN 'SOLICITANTE'
        ELSE 'TECNICO'
    END,
    activo = 1,
    fecha_creacion = COALESCE(fecha_creacion, NOW())
WHERE nombre_completo IN (
    'Maria Mora', 'Alberto Mendoza', 'Alberth Viloria', 'Jhoselin Weffer',
    'Maria Valenzuela', 'Reynaldo Pulido', 'Gustavo Gimenez', 'Moises Chavez',
    'Jhoseph Lugo', 'Freddy Vallejo', 'Eudy Medina', 'Reyniel Medina',
    'Ali Rodriguez', 'Nerio Salazar', 'Brayan Querales', 'Jorge mota',
    'Haydee Alvarez', 'Luis Rodriguez', 'Sandy Oviedo', 'Enrique Reyes',
    'Rafael Escobar'
);
Paso 5: Verificar resultado final
sql
SELECT rol, COUNT(*) as total, 
       GROUP_CONCAT(nombre_completo ORDER BY nombre_completo) as lista
FROM usuarios 
WHERE activo = 1
GROUP BY rol
ORDER BY 
    CASE rol
        WHEN 'ADMIN' THEN 1
        WHEN 'COORDINADOR' THEN 2
        WHEN 'HIBRIDO' THEN 3
        WHEN 'TECNICO' THEN 4
        WHEN 'SOLICITANTE' THEN 5
        ELSE 6
    END;
üìä ESTRUCTURA FINAL ESPERADA:
sql
-- Despu√©s de ejecutar el script, deber√≠as tener:
-- ADMIN (1): Gustavo Gimenez
-- COORDINADOR (1): Rafael Escobar  
-- HIBRIDO (2): Sandy Oviedo, Enrique Reyes
-- TECNICO (13): Mar√≠a Mora, Alberto Mendoza, Alberth Viloria, etc.
-- SOLICITANTE (4): Ali Rodriguez, Jorge mota, Haydee Alvarez, Luis Rodriguez
-- TOTAL: 21 usuarios activos
‚ö†Ô∏è RECOMENDACIONES IMPORTANTES:
‚úÖ Haz backup primero:

sql
-- Crear tabla de respaldo
CREATE TABLE usuarios_backup_2024 AS SELECT * FROM usuarios;
‚úÖ Ejecuta en transacci√≥n para poder revertir:

sql
START TRANSACTION;
-- Ejecutar todos los UPDATE/INSERT aqu√≠
-- Si todo est√° bien:
COMMIT;
-- Si hay error:
ROLLBACK;
‚úÖ Para producci√≥n, usa contrase√±as hasheadas:

sql
-- En lugar de '123456', usar:
UPDATE usuarios 
SET password_hash = 'hashed_password_here'  -- Usar BCrypt o similar
WHERE password IS NULL;
¬øQuieres que ejecute alguno de estos scripts paso a paso contigo? ¬øO prefieres que te ayude con otra parte primero? üéØ

-- Casos especiales con nombres compuestos
UPDATE usuarios SET username = 'gustavogimenez' WHERE nombre_completo = 'Gustavo Gimenez';
MySQL ha dicho: 

#1062 - Entrada duplicada 'gustavogimenez' para la clave 'username'
¬°Tienes un problema de duplicados en la tabla! Hay m√°s de un usuario con el mismo username. Vamos a solucionarlo.

üîç AN√ÅLISIS DEL PROBLEMA:
Hay duplicados en tu tabla usuarios. Probablemente tienes:

Usuarios antiguos/inactivos con el mismo nombre

Entradas duplicadas por pruebas anteriores

Usuarios con activo = 0 que a√∫n tienen el mismo username

üöÄ SOLUCI√ìN COMPLETA:
Paso 1: Identificar duplicados
sql
-- Ver TODOS los usuarios (activos e inactivos)
SELECT 
    id,
    nombre_completo,
    username,
    rol,
    activo,
    fecha_creacion
FROM usuarios 
WHERE username IS NOT NULL AND username != ''
ORDER BY username, fecha_creacion DESC;
Paso 2: Ver duplicados espec√≠ficos de 'gustavogimenez'
sql
-- Ver todas las entradas con username 'gustavogimenez'
SELECT 
    id,
    nombre_completo,
    username,
    rol,
    activo,
    fecha_creacion,
    departamento
FROM usuarios 
WHERE username = 'gustavogimenez' 
   OR (nombre_completo = 'Gustavo Gimenez' AND username IS NOT NULL)
ORDER BY activo DESC, fecha_creacion DESC;
Paso 3: Estrategia de limpieza (ELIGE UNA OPCI√ìN)
OPCI√ìN A: Mantener solo el m√°s reciente (RECOMENDADO)
sql
-- 1. Identificar IDs a mantener y eliminar
SELECT 
    MAX(id) as id_a_mantener,
    GROUP_CONCAT(id) as todos_los_ids,
    COUNT(*) as cantidad_duplicados
FROM usuarios 
WHERE username = 'gustavogimenez' 
   OR nombre_completo = 'Gustavo Gimenez'
GROUP BY nombre_completo, username;

-- 2. Desactivar los duplicados (mantener solo el m√°s reciente)
UPDATE usuarios 
SET activo = 0,
    username = CONCAT(username, '_inactivo_', id),
    observaciones = CONCAT('Desactivado por duplicado - ', CURDATE())
WHERE id NOT IN (
    SELECT MAX(id) 
    FROM usuarios 
    WHERE username = 'gustavogimenez' 
       OR nombre_completo = 'Gustavo Gimenez'
    GROUP BY nombre_completo, username
) AND (username = 'gustavogimenez' OR nombre_completo = 'Gustavo Gimenez');
OPCI√ìN B: Renombrar todos los usernames para evitar duplicados
sql
-- Renombrar TODOS los usernames con ID √∫nico
UPDATE usuarios 
SET username = CONCAT(
    LOWER(
        CONCAT(
            SUBSTRING(nombre_completo, 1, 1),
            REPLACE(SUBSTRING_INDEX(nombre_completo, ' ', -1), ' ', '')
        )
    ),
    '_',
    id
)
WHERE activo = 1;
Paso 4: Script COMPLETO y SEGURO para reorganizar usuarios
sql
-- ============================================
-- SCRIPT COMPLETO CON MANEJO DE DUPLICADOS
-- ============================================

-- 1. HACER BACKUP PRIMERO
CREATE TABLE IF NOT EXISTS usuarios_backup_antes_limpieza AS 
SELECT *, NOW() as fecha_backup FROM usuarios;

-- 2. IDENTIFICAR Y MARCAR DUPLICADOS
ALTER TABLE usuarios ADD COLUMN IF NOT EXISTS es_duplicado BOOLEAN DEFAULT FALSE;

UPDATE usuarios u1
INNER JOIN (
    SELECT MIN(id) as id_a_mantener, username
    FROM usuarios 
    WHERE username IS NOT NULL AND username != '' AND activo = 1
    GROUP BY username
    HAVING COUNT(*) > 1
) dups ON u1.username = dups.username AND u1.id != dups.id_a_mantener
SET u1.es_duplicado = TRUE;

-- 3. DESACTIVAR DUPLICADOS
UPDATE usuarios 
SET activo = 0,
    username = CONCAT(username, '_dup_', id),
    observaciones = CONCAT('Duplicado desactivado - ', CURDATE())
WHERE es_duplicado = TRUE;

-- 4. LIMPIAR TABLA TEMPORAL
ALTER TABLE usuarios DROP COLUMN es_duplicado;

-- 5. AHORA S√ç, ACTUALIZAR ROLES SIN ERRORES
UPDATE usuarios 
SET rol = 'ADMIN', 
    departamento = 'Informatica', 
    localidad_id = 1
WHERE nombre_completo = 'Gustavo Gimenez' 
  AND activo = 1
  AND id = (
      SELECT MIN(id) 
      FROM usuarios 
      WHERE nombre_completo = 'Gustavo Gimenez' AND activo = 1
  );

-- 6. ACTUALIZAR EL RESTO DE USUARIOS
UPDATE usuarios 
SET rol = 'HIBRIDO', 
    departamento = 'Informatica', 
    localidad_id = 1
WHERE nombre_completo IN ('Sandy Oviedo', 'Enrique Reyes') 
  AND activo = 1;

UPDATE usuarios 
SET rol = 'TECNICO', 
    departamento = 'Informatica', 
    localidad_id = 1
WHERE nombre_completo IN (
    'Maria Mora', 'Alberto Mendoza', 'Alberth Viloria', 'Jhoselin Weffer',
    'Maria Valenzuela', 'Reynaldo Pulido', 'Moises Chavez', 'Jhoseph Lugo',
    'Freddy Vallejo', 'Eudy Medina', 'Reyniel Medina', 'Nerio Salazar',
    'Brayan Querales'
) AND activo = 1;

UPDATE usuarios 
SET rol = 'SOLICITANTE'
WHERE nombre_completo IN ('Ali Rodriguez', 'Jorge mota', 'Haydee Alvarez', 'Luis Rodriguez') 
  AND activo = 1;

-- 7. INSERTAR RAFAEL ESCOBAR (si no existe)
INSERT INTO usuarios (nombre_completo, username, password, rol, departamento, localidad_id, activo, fecha_creacion)
SELECT 'Rafael Escobar', 'rescobar', '123456', 'COORDINADOR', 'Coordinaci√≥n', 1, 1, NOW()
WHERE NOT EXISTS (
    SELECT 1 FROM usuarios 
    WHERE nombre_completo = 'Rafael Escobar' AND activo = 1
);

-- 8. VERIFICAR RESULTADO
SELECT rol, COUNT(*) as total, 
       GROUP_CONCAT(CONCAT(nombre_completo, ' (', username, ')') ORDER BY nombre_completo) as usuarios
FROM usuarios 
WHERE activo = 1
GROUP BY rol
ORDER BY 
    CASE rol
        WHEN 'ADMIN' THEN 1
        WHEN 'COORDINADOR' THEN 2
        WHEN 'HIBRIDO' THEN 3
        WHEN 'TECNICO' THEN 4
        WHEN 'SOLICITANTE' THEN 5
        ELSE 6
    END;
Paso 5: Soluci√≥n R√ÅPIDA si solo quieres arreglar el error
sql
-- SOLUCI√ìN R√ÅPIDA: Renombrar solo el problema
UPDATE usuarios 
SET username = 'gustavo_admin'
WHERE nombre_completo = 'Gustavo Gimenez' 
  AND activo = 1
  AND id = (SELECT MAX(id) FROM usuarios WHERE nombre_completo = 'Gustavo Gimenez');

-- Luego continuar con el resto de actualizaciones...
Paso 6: Script MINIMALISTA (solo lo esencial)
sql
-- 1. Para Gustavo, usar un username diferente
UPDATE usuarios 
SET username = 'admin_gustavo',
    rol = 'ADMIN',
    departamento = 'Informatica'
WHERE nombre_completo = 'Gustavo Gimenez'
ORDER BY id DESC
LIMIT 1;

-- 2. Para los dem√°s, generar usernames √∫nicos
UPDATE usuarios 
SET username = CONCAT(
    LOWER(REPLACE(SUBSTRING_INDEX(nombre_completo, ' ', 1), ' ', '')),
    '.',
    LOWER(REPLACE(SUBSTRING_INDEX(nombre_completo, ' ', -1), ' ', ''))
)
WHERE activo = 1 AND (username IS NULL OR username = '');

-- 3. Verificar
SELECT nombre_completo, username, rol, departamento
FROM usuarios 
WHERE activo = 1
ORDER BY rol, nombre_completo;
üìã RECOMENDACI√ìN FINAL:
Ejecuta PRIMERO este comando para ver EXACTAMENTE cu√°l es el problema:

sql
-- DIAGN√ìSTICO COMPLETO
SELECT 
    'DUPLICADOS POR USERNAME' as tipo,
    username,
    COUNT(*) as cantidad,
    GROUP_CONCAT(CONCAT('ID:', id, ' ', nombre_completo, ' (activo:', activo, ')') SEPARATOR ' | ') as detalle
FROM usuarios 
WHERE username IS NOT NULL AND username != ''
GROUP BY username
HAVING COUNT(*) > 1
UNION ALL
SELECT 
    'DUPLICADOS POR NOMBRE' as tipo,
    nombre_completo,
    COUNT(*) as cantidad,
    GROUP_CONCAT(CONCAT('ID:', id, ' user:', username, ' (activo:', activo, ')') SEPARATOR ' | ') as detalle
FROM usuarios 
WHERE nombre_completo IS NOT NULL AND nombre_completo != ''
GROUP BY nombre_completo
HAVING COUNT(*) > 1
ORDER BY tipo, cantidad DESC;
¬øQuieres que ejecute alguno de estos diagn√≥sticos primero? O prefieres que te d√© un script espec√≠fico para tu situaci√≥n exacta.

¬°Dime qu√© prefieres y lo hacemos paso a paso! üéØ

Editar
 Copiar
 Borrar
15
Gustavo Gimenez
g.gimenez
ADMIN
1
2025-11-24 18:00:53
Informatica

 Editar
 Copiar
 Borrar
8
Gustavo Gimenez
ggimenez
ADMIN
1
2025-10-09 16:14:52
Informatica
  Seleccionar todo Para los elementos que est√°n marcados:  Editar  Copiar  Borrar  Exportar
¬°Perfecto! Ya identificamos el problema exacto: Tienes 2 usuarios "Gustavo Gimenez" activos con diferentes usernames. Vamos a solucionarlo.

üéØ PROBLEMA ESPEC√çFICO:
ID 8: Gustavo Gimenez (username: ggimenez) - Creado: 2025-10-09

ID 15: Gustavo Gimenez (username: g.gimenez) - Creado: 2025-11-24

Ambos est√°n activos (activo = 1) y ambos son ADMIN.

üöÄ SOLUCI√ìN R√ÅPIDA Y SEGURA:
Opci√≥n 1: Mantener el M√ÅS NUEVO (ID 15 - RECOMENDADO)
sql
-- 1. Desactivar el usuario antiguo (ID 8)
UPDATE usuarios 
SET activo = 0,
    username = CONCAT(username, '_inactivo_', id),
    observaciones = 'Desactivado por duplicado - Mantener ID 15'
WHERE id = 8;

-- 2. Asegurar que el nuevo (ID 15) tenga los datos correctos
UPDATE usuarios 
SET username = 'gustavogimenez',  -- O el que prefieras
    rol = 'ADMIN',
    departamento = 'Informatica',
    localidad_id = 1
WHERE id = 15;

-- 3. Verificar
SELECT id, nombre_completo, username, rol, activo, fecha_creacion 
FROM usuarios 
WHERE nombre_completo LIKE '%Gustavo%';
Opci√≥n 2: Mantener el M√ÅS ANTIGUO (ID 8)
sql
-- 1. Desactivar el usuario nuevo (ID 15)
UPDATE usuarios 
SET activo = 0,
    username = CONCAT(username, '_inactivo_', id),
    observaciones = 'Desactivado por duplicado - Mantener ID 8'
WHERE id = 15;

-- 2. Asegurar que el antiguo (ID 8) tenga username √∫nico
UPDATE usuarios 
SET username = 'gustavogimenez',  -- O el que prefieras
    rol = 'ADMIN',
    departamento = 'Informatica',
    localidad_id = 1
WHERE id = 8;
Opci√≥n 3: Fusionar datos (M√ÅS COMPLEJO)
sql
-- Si ambos tienen datos importantes que quieres conservar
-- Primero, mover cualquier dato relacionado del ID 15 al ID 8
UPDATE peticiones_servicio 
SET usuario_solicitante_id = 8, 
    tecnico_asignado_id = 8,
    verificado_por_id = 8,
    usuario_origen_real_id = 8
WHERE usuario_solicitante_id = 15 
   OR tecnico_asignado_id = 15 
   OR verificado_por_id = 15
   OR usuario_origen_real_id = 15;

-- Luego desactivar el ID 15
UPDATE usuarios 
SET activo = 0,
    username = 'g.gimenez_inactivo',
    observaciones = 'Fusionado con ID 8'
WHERE id = 15;
üìã SCRIPT COMPLETO PARA TODOS LOS USUARIOS (CON MANEJO DE DUPLICADOS):
sql
-- ============================================
-- SCRIPT DEFINITIVO PARA ORGANIZAR BD
-- ============================================

-- 0. HACER BACKUP (IMPORTANTE)
CREATE TABLE usuarios_backup_pre_limpieza AS 
SELECT *, NOW() as backup_fecha FROM usuarios;

-- 1. PARA GUSTAVO - Mantener el M√ÅS RECIENTE (ID 15)
UPDATE usuarios 
SET activo = 0,
    username = CONCAT('old_', username),
    observaciones = CONCAT('Duplicado - Mantenido ID 15 - ', CURDATE())
WHERE nombre_completo = 'Gustavo Gimenez' AND id != 15;

-- 2. REVISAR SI HAY OTROS DUPLICADOS
SELECT nombre_completo, COUNT(*) as duplicados
FROM usuarios 
WHERE activo = 1
GROUP BY nombre_completo
HAVING COUNT(*) > 1;

-- 3. ACTUALIZAR TODOS LOS ROLES SEG√öN TU LISTA
UPDATE usuarios 
SET rol = 'ADMIN',
    departamento = 'Informatica',
    localidad_id = 1
WHERE nombre_completo = 'Gustavo Gimenez' AND activo = 1;

UPDATE usuarios 
SET rol = 'HIBRIDO',
    departamento = 'Informatica', 
    localidad_id = 1
WHERE nombre_completo IN ('Sandy Oviedo', 'Enrique Reyes') AND activo = 1;

UPDATE usuarios 
SET rol = 'TECNICO',
    departamento = 'Informatica',
    localidad_id = 1
WHERE nombre_completo IN (
    'Maria Mora', 'Alberto Mendoza', 'Alberth Viloria', 'Jhoselin Weffer',
    'Maria Valenzuela', 'Reynaldo Pulido', 'Moises Chavez', 'Jhoseph Lugo',
    'Freddy Vallejo', 'Eudy Medina', 'Reyniel Medina', 'Nerio Salazar',
    'Brayan Querales'
) AND activo = 1;

UPDATE usuarios 
SET rol = 'SOLICITANTE',
    departamento = CASE 
        WHEN nombre_completo = 'Ali Rodriguez' THEN 'FARMACIA'
        WHEN nombre_completo = 'Jorge mota' THEN 'RRHH'
        WHEN nombre_completo = 'Haydee Alvarez' THEN 'Registros Medicos'
        WHEN nombre_completo = 'Luis Rodriguez' THEN 'Direccion'
        ELSE departamento
    END
WHERE nombre_completo IN ('Ali Rodriguez', 'Jorge mota', 'Haydee Alvarez', 'Luis Rodriguez') 
  AND activo = 1;

-- 4. AGREGAR RAFAEL ESCOBAR (COORDINADOR) SI NO EXISTE
INSERT INTO usuarios (nombre_completo, username, password, rol, departamento, localidad_id, activo, fecha_creacion)
SELECT 'Rafael Escobar', 'rescobar', '123456', 'COORDINADOR', 'Coordinaci√≥n', 1, 1, NOW()
WHERE NOT EXISTS (
    SELECT 1 FROM usuarios 
    WHERE nombre_completo = 'Rafael Escobar' AND activo = 1
);

-- 5. ESTABLECER USERNAMES √öNICOS PARA TODOS
UPDATE usuarios 
SET username = CONCAT(
    LOWER(SUBSTRING(nombre_completo, 1, 1)),
    LOWER(REPLACE(SUBSTRING_INDEX(nombre_completo, ' ', -1), ' ', ''))
)
WHERE activo = 1 AND (username IS NULL OR username = '' OR username LIKE '%inactivo%');

-- 6. CASOS ESPECIALES PARA USERNAMES M√ÅS CORTOS/CLAROS
UPDATE usuarios 
SET username = 'gustavo' WHERE nombre_completo = 'Gustavo Gimenez' AND activo = 1;
UPDATE usuarios 
SET username = 'rafael' WHERE nombre_completo = 'Rafael Escobar' AND activo = 1;
UPDATE usuarios 
SET username = 'sandy' WHERE nombre_completo = 'Sandy Oviedo' AND activo = 1;
UPDATE usuarios 
SET username = 'enrique' WHERE nombre_completo = 'Enrique Reyes' AND activo = 1;

-- 7. CONTRASE√ëAS POR DEFECTO (PARA PRUEBAS)
UPDATE usuarios 
SET password = '123456'
WHERE activo = 1 AND (password IS NULL OR password = '');

-- 8. VERIFICAR RESULTADO FINAL
SELECT 
    'RESUMEN POR ROL' as seccion,
    rol,
    COUNT(*) as total,
    GROUP_CONCAT(CONCAT(nombre_completo, ' (', username, ')') ORDER BY nombre_completo) as usuarios
FROM usuarios 
WHERE activo = 1
GROUP BY rol
ORDER BY 
    CASE rol
        WHEN 'ADMIN' THEN 1
        WHEN 'COORDINADOR' THEN 2
        WHEN 'HIBRIDO' THEN 3
        WHEN 'TECNICO' THEN 4
        WHEN 'SOLICITANTE' THEN 5
        ELSE 6
    END;

-- 9. VER TODOS LOS USUARIOS ACTIVOS
SELECT 
    id,
    nombre_completo,
    username,
    rol,
    departamento,
    localidad_id,
    DATE(fecha_creacion) as fecha_registro
FROM usuarios 
WHERE activo = 1
ORDER BY 
    CASE rol
        WHEN 'ADMIN' THEN 1
        WHEN 'COORDINADOR' THEN 2
        WHEN 'HIBRIDO' THEN 3
        WHEN 'TECNICO' THEN 4
        WHEN 'SOLICITANTE' THEN 5
        ELSE 6
    END,
    nombre_completo;
üéØ RECOMENDACI√ìN PERSONAL:
Ejecuta este script MINIMAL primero para arreglar solo el problema de Gustavo:

sql
-- SCRIPT M√çNIMO PARA ARREGLAR EL ERROR
START TRANSACTION;

-- 1. Desactivar el Gustavo antiguo (ID 8)
UPDATE usuarios 
SET activo = 0,
    username = 'ggimenez_inactivo',
    observaciones = 'Duplicado - Desactivado ' || CURDATE()
WHERE id = 8;

-- 2. Asegurar que el Gustavo activo (ID 15) tenga username √∫nico
UPDATE usuarios 
SET username = 'gustavo',
    rol = 'ADMIN',
    departamento = 'Informatica'
WHERE id = 15;

-- 3. Verificar
SELECT id, nombre_completo, username, rol, activo 
FROM usuarios 
WHERE nombre_completo LIKE '%Gustavo%';

COMMIT;
Despu√©s ejecuta el resto de las actualizaciones de roles.

‚ùì PREGUNTAS IMPORTANTES:
¬øQu√© Gustavo quieres mantener activo?

‚úÖ ID 15 (m√°s nuevo - 24 nov 2025)

‚ö†Ô∏è ID 8 (m√°s antiguo - 09 oct 2025)

¬øAlguno de los Gustavos tiene peticiones/reportes creados?

sql
-- Verificar si hay datos asociados
SELECT 'Peticiones como solicitante', COUNT(*) 
FROM peticiones_servicio WHERE usuario_solicitante_id IN (8, 15);

SELECT 'Peticiones como t√©cnico', COUNT(*) 
FROM peticiones_servicio WHERE tecnico_asignado_id IN (8, 15);

SELECT 'Reportes creados', COUNT(*) 
FROM reportes WHERE usuario_id IN (8, 15);
¬øPrefieres que mantengamos ambos pero con usernames diferentes?

¬°Dime qu√© prefieres y ejecutamos el script adecuado! üöÄ

si cambio este codigo:                                                                                        @if (puedeVerTodasPeticiones)
                                        {
                                            <th>Solicitante</th>
                                        }
                                        <th>Localidad</th>
                                        <th>Tipo Servicio</th>
                                        <th>Prioridad</th>
                                        <th>Estado</th>

                                        @if (puedeVerTodasPeticiones || esTecnico)
                                        {
                                            <th>T√©cnico Asignado</th>
                                        }
                                        <th>Fecha Solicitud</th>
                                        <th>Acciones</th>                                                                                                por este otro codigo                                                                                                                                         @if (puedeVerTodasPeticiones)
{
    <td>
        <!-- SOLICITANTE CON DEPARTAMENTO -->
        <div class="fw-bold">@peticion.UsuarioSolicitante?.NombreCompleto</div>
        <small class="text-muted">
            <i class="fas fa-building me-1"></i>
            @peticion.UsuarioSolicitante?.Departamento
        </small>
        
        <!-- INDICADOR SI ES VERIFICADO -->
        @if (!peticion.OrigenVerificado)
        {
            <div class="mt-1">
                <span class="badge bg-warning">
                    <i class="fas fa-exclamation-triangle me-1"></i>No verificado
                </span>
            </div>
        }
        @if (peticion.EsUrgenteTelefono)
        {
            <div class="mt-1">
                <span class="badge bg-danger">
                    <i class="fas fa-phone me-1"></i>Por tel√©fono
                </span>
            </div>
        }
    </td>
}                                                                                                                                                                     no me alterara la logica? recordemos qye hay usuario solicitantes, usuarios tecnicos y usuarios hibridos(tecnico y solicitantes) esta correcto, lo cambio sin mirar atras?
¬°CUIDADO! No, no lo cambies as√≠. Est√°s confundiendo dos secciones diferentes del c√≥digo:

üîç AN√ÅLISIS DEL ERROR:
Tu c√≥digo actual tiene DOS PARTES DIFERENTES:

1. ENCABEZADOS DE TABLA (thead) - Esto es lo que NO debes tocar:
html
<thead>
    <tr>
        <th>ID</th>
        <th>T√≠tulo</th>
        @if (puedeVerTodasPeticiones)  <!-- ‚Üê ESTO ES EL ENCABEZADO -->
        {
            <th>Solicitante</th>  <!-- ‚Üê SOLO EL T√çTULO DE LA COLUMNA -->
        }
        <th>Localidad</th>
        <!-- ... otros encabezados ... -->
    </tr>
</thead>
2. CUERPO DE TABLA (tbody) - Esto es lo que S√ç debes modificar:
html
<tbody>
    @foreach (var peticion in Model)
    {
        <tr>
            <td>#@peticion.Id</td>
            <td>@peticion.Titulo</td>
            
            @if (puedeVerTodasPeticiones)  <!-- ‚Üê ESTO ES EL CONTENIDO -->
            {
                <!-- ‚úÖ AQU√ç S√ç VA EL C√ìDIGO NUEVO QUE TE DI -->
                <td>
                    <div class="fw-bold">@peticion.UsuarioSolicitante?.NombreCompleto</div>
                    <small class="text-muted">
                        <i class="fas fa-building me-1"></i>
                        @peticion.UsuarioSolicitante?.Departamento
                    </small>
                    <!-- ... resto del c√≥digo nuevo ... -->
                </td>
            }
            <!-- ... resto de las columnas ... -->
        </tr>
    }
</tbody>
üöÄ CORRECCI√ìN PASO A PASO:
PASO 1: Ubica la secci√≥n CORRECTA en tu Index.cshtml
Busca esta parte (alrededor de la l√≠nea 160 en tu c√≥digo):

html
@if (puedeVerTodasPeticiones)
{
    <!-- ‚úÖ CORREGIDO: UsuarioSolicitante existe en el modelo -->
    <td>@peticion.UsuarioSolicitante?.NombreCompleto</td>  <!-- ‚Üê ESTA L√çNEA -->
}
PASO 2: Reemplaza SOLO ESA L√çNEA por el nuevo c√≥digo:
html
@if (puedeVerTodasPeticiones)
{
    <td>
        <!-- SOLICITANTE CON DEPARTAMENTO -->
        <div class="fw-bold">@peticion.UsuarioSolicitante?.NombreCompleto</div>
        <small class="text-muted">
            <i class="fas fa-building me-1"></i>
            @peticion.UsuarioSolicitante?.Departamento
        </small>
        
        <!-- INDICADOR SI ES VERIFICADO -->
        @if (!peticion.OrigenVerificado)
        {
            <div class="mt-1">
                <span class="badge bg-warning">
                    <i class="fas fa-exclamation-triangle me-1"></i>No verificado
                </span>
            </div>
        }
        @if (peticion.EsUrgenteTelefono)
        {
            <div class="mt-1">
                <span class="badge bg-danger">
                    <i class="fas fa-phone me-1"></i>Por tel√©fono
                </span>
            </div>
        }
    </td>
}
üìã RESUMEN DE QU√â CAMBIAR:
ANTES (tu c√≥digo actual):

html
@if (puedeVerTodasPeticiones)
{
    <td>@peticion.UsuarioSolicitante?.NombreCompleto</td>  <!-- ‚Üê SOLO ESTA L√çNEA -->
}
DESPU√âS (nuevo c√≥digo):

html
@if (puedeVerTodasPeticiones)
{
    <td>
        <!-- TODO EL NUEVO C√ìDIGO AQU√ç -->
        <div class="fw-bold">@peticion.UsuarioSolicitante?.NombreCompleto</div>
        <small class="text-muted">
            <i class="fas fa-building me-1"></i>
            @peticion.UsuarioSolicitante?.Departamento
        </small>
        <!-- ... m√°s c√≥digo ... -->
    </td>
}
‚ö†Ô∏è PRECAUCIONES:
NO toques los <th> - Son solo los t√≠tulos de las columnas

S√ç toca los <td> - Son el contenido de cada celda

Mant√©n la condici√≥n @if (puedeVerTodasPeticiones) - Es correcta porque:

‚úÖ ADMIN y COORDINADOR pueden ver todas las peticiones

‚úÖ T√âCNICOS e H√çBRIDOS solo ven peticiones de su localidad

‚úÖ SOLICITANTES solo ven sus propias peticiones

üéØ ¬øQU√â PASA CON LOS DIFERENTES ROLES?
ADMIN/COORDINADOR: Ver√°n TODAS las peticiones con solicitante+departamento

T√âCNICO/H√çBRIDO: NO ver√°n la columna "Solicitante" (por dise√±o actual)

SOLICITANTE: Solo ver√° SUS peticiones (no necesita ver su propio nombre)

¬øQuieres que los T√âCNICOS/H√çBRIDOS tambi√©n vean el solicitante? Podemos ajustar la condici√≥n:

html
@if (puedeVerTodasPeticiones || esTecnico)  <!-- ‚Üê AGREGAR 'esTecnico' -->
{
    <td>
        <!-- ... c√≥digo del solicitante ... -->
    </td>
}
üîß TE RECOMIENDO:
Primero haz backup de tu archivo Index.cshtml

Cambia SOLO la l√≠nea que te indiqu√©

Prueba con diferentes roles para verificar

¬øQuieres que te muestre el fragmento EXACTO de tu archivo que debes cambiar? Dame la l√≠nea espec√≠fica donde aparece @peticion.UsuarioSolicitante?.NombreCompleto y te digo exactamente qu√© hacer. üéØ

¬°NO CAMBIES LOS ENCABEZADOS <th>! Solo el contenido <td>.

puedes darme la modificacion de esto                                                                                                         @model IEnumerable<SistemaReportesWeb.Models.PeticionServicio>
@{
    ViewData["Title"] = "Peticiones de Servicio";
    var usuarioRol = ViewBag.UsuarioRol as string;
    var esSolicitante = usuarioRol == "SOLICITANTE";
    var esTecnico = usuarioRol == "TECNICO";
    var puedeCrearPeticiones = usuarioRol == "SOLICITANTE" || usuarioRol == "COORDINADOR" || usuarioRol == "SECRETARIA" || usuarioRol == "PROGRAMADOR";
    var puedeVerTodasPeticiones = usuarioRol == "COORDINADOR" || usuarioRol == "SECRETARIA" || usuarioRol == "PROGRAMADOR";
}

<div class="container mt-4">
    <!-- Header con informaci√≥n del usuario -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-clipboard-list me-2"></i>@ViewData["Title"]
                    </h2>
                    <p class="text-muted mb-0">
                        <i class="fas fa-user me-1"></i>
                        <strong>@ViewBag.UsuarioNombre</strong> - 
                        <span class="badge bg-info">@usuarioRol</span>
                        @if (esSolicitante)
                        {
                            <span class="badge bg-warning ms-2"><i class="fas fa-eye me-1"></i>Solo sus peticiones</span>
                        }
                        @if (puedeVerTodasPeticiones)
                        {
                            <span class="badge bg-success ms-2"><i class="fas fa-users me-1"></i>Todas las peticiones</span>
                        }
                    </p>
                </div>
                
                <div class="btn-group">
                    @if (puedeCrearPeticiones)
                    {
                        <a href="@Url.Action("Crear")" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>Nueva Petici√≥n
                        </a>
                    }
                    
                    @if (esTecnico)
                    {
                        <a href="@Url.Action("Dashboard")" class="btn btn-success">
                            <i class="fas fa-tachometer-alt me-2"></i>Dashboard T√©cnico
                        </a>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Tarjeta de estad√≠sticas -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-2">
                            <h4 class="text-primary">@Model.Count()</h4>
                            <small class="text-muted">Total</small>
                        </div>
                        <div class="col-md-2">
                            <h4 class="text-warning">@Model.Count(p => p.Estado == "PENDIENTE")</h4>
                            <small class="text-muted">Pendientes</small>
                        </div>
                        <div class="col-md-2">
                            <h4 class="text-info">@Model.Count(p => p.Estado == "EN_PROCESO")</h4>
                            <small class="text-muted">En Proceso</small>
                        </div>
                        <div class="col-md-2">
                            <h4 class="text-success">@Model.Count(p => p.Estado == "COMPLETADO")</h4>
                            <small class="text-muted">Completadas</small>
                        </div>
                        <div class="col-md-2">
                            <h4 class="text-danger">@Model.Count(p => p.Estado == "CANCELADO")</h4>
                            <small class="text-muted">Canceladas</small>
                        </div>
                        <div class="col-md-2">
                            <h4 class="text-secondary">@Model.Count(p => p.Prioridad == "ALTA")</h4>
                            <small class="text-muted">Prioridad Alta</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros r√°pidos -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body py-2">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary filter-btn active" data-filter="all">
                            <i class="fas fa-list me-1"></i>Todas (@Model.Count())
                        </button>
                        <button type="button" class="btn btn-outline-warning filter-btn" data-filter="PENDIENTE">
                            <i class="fas fa-clock me-1"></i>Pendientes (@Model.Count(p => p.Estado == "PENDIENTE"))
                        </button>
                        <button type="button" class="btn btn-outline-info filter-btn" data-filter="EN_PROCESO">
                            <i class="fas fa-cogs me-1"></i>En Proceso (@Model.Count(p => p.Estado == "EN_PROCESO"))
                        </button>
                        <button type="button" class="btn btn-outline-success filter-btn" data-filter="COMPLETADO">
                            <i class="fas fa-check me-1"></i>Completadas (@Model.Count(p => p.Estado == "COMPLETADO"))
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de peticiones -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>Lista de Peticiones
                        @if (esSolicitante)
                        {
                            <small class="text-muted">(Solo sus peticiones)</small>
                        }
                    </h5>
                </div>
                <div class="card-body">
                    @if (Model.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover" id="tablaPeticiones">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>T√≠tulo</th>
                                        @if (puedeVerTodasPeticiones)
                                        {
                                            <th>Solicitante</th>
                                        }
                                        <th>Localidad</th>
                                        <th>Tipo Servicio</th>
                                        <th>Prioridad</th>
                                        <th>Estado</th>

                                        @if (puedeVerTodasPeticiones || esTecnico)
                                        {
                                            <th>T√©cnico Asignado</th>
                                        }
                                        <th>Fecha Solicitud</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                
                                <tbody>
                                    @foreach (var peticion in Model)
                                    {
                                        <tr class="peticion-fila" data-estado="@peticion.Estado">
                                            <td>
                                                <strong>#@peticion.Id</strong>
                                            </td>
                                            <td>
                                                <div class="fw-bold">@peticion.Titulo</div>
                                                <small class="text-muted">
                                                    @(peticion.Descripcion.Length > 50 ? 
                                                      peticion.Descripcion.Substring(0, 50) + "..." : 
                                                      peticion.Descripcion)
                                                </small>
                                            </td>
                                            
                                            @if (puedeVerTodasPeticiones)
                                            {
                                                <!-- ‚úÖ CORREGIDO: UsuarioSolicitante existe en el modelo -->
                                                <td>@peticion.UsuarioSolicitante?.NombreCompleto</td>
                                            }
                                            
                                            <td>@peticion.Localidad?.Nombre</td>
                                            <td>
                                                <span class="badge bg-secondary">@peticion.TipoServicio</span>
                                            </td>
                                            <td>
                                                @{
                                                    var prioridadClass = peticion.Prioridad switch
                                                    {
                                                        "URGENTE" => "danger",
                                                        "ALTA" => "warning",
                                                        "MEDIA" => "info",
                                                        "BAJA" => "success",
                                                        _ => "secondary"
                                                    };
                                                }
                                                <span class="badge bg-@prioridadClass">@peticion.Prioridad</span>
                                            </td>
                                            <td>
                                                @{
                                                    var estadoClass = peticion.Estado switch
                                                    {
                                                        "PENDIENTE" => "warning",
                                                        "EN_PROCESO" => "info",
                                                        "COMPLETADO" => "success",
                                                        "CANCELADO" => "danger",
                                                        _ => "secondary"
                                                    };
                                                }
                                                <span class="badge bg-@estadoClass">@peticion.Estado</span>
                                            </td>
                                            
                                            @if (puedeVerTodasPeticiones || esTecnico)
                                            {
                                                <td>
                                                    @if (peticion.TecnicoAsignado != null)
                                                    {
                                                        <span class="text-success">@peticion.TecnicoAsignado.NombreCompleto</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">No asignado</span>
                                                    }
                                                </td>
                                            }
                                            
                                            <!-- ‚úÖ CORREGIDO: FechaSolicitud existe en el modelo -->
                                            <td>@peticion.FechaSolicitud.ToString("dd/MM/yyyy")</td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <!-- Ver Detalles -->
                                                    <a href="@Url.Action("Detalles", new { id = peticion.Id })" 
                                                       class="btn btn-outline-primary" title="Ver detalles">
                                                        <i class="fas fa-eye"></i>
                                                    </a>

                                                    <!-- Crear Reporte (solo t√©cnicos y roles superiores) -->
                                                    @if ((esTecnico && peticion.Estado != "PENDIENTE") || puedeVerTodasPeticiones)
                                                    {
                                                        <a href="@Url.Action("Crear", "Reportes", new { peticionId = peticion.Id })" 
                                                           class="btn btn-outline-success" title="Crear reporte">
                                                            <i class="fas fa-file-alt"></i>
                                                        </a>
                                                    }

                                                    <!-- Editar (solo solicitante de la petici√≥n o roles superiores) -->
                                                    <!-- ‚úÖ CORREGIDO: UsuarioSolicitanteId existe en el modelo -->
                                                    @if ((esSolicitante && peticion.UsuarioSolicitanteId.ToString() == ViewBag.UsuarioId?.ToString()) || puedeVerTodasPeticiones)
                                                    {
                                                        <a href="@Url.Action("Editar", new { id = peticion.Id })" 
                                                           class="btn btn-outline-warning" title="Editar petici√≥n">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                    }

                                                    <!-- Eliminar (solo roles superiores) -->
                                                    @if (puedeVerTodasPeticiones)
                                                    {
                                                        <form asp-action="Eliminar" method="post" class="d-inline" 
                                                              onsubmit="return confirm('¬øEst√° seguro de eliminar esta petici√≥n?');">
                                                            <input type="hidden" name="id" value="@peticion.Id" />
                                                            <button type="submit" class="btn btn-outline-danger" title="Eliminar">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </form>
                                                    }
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
                            <h4 class="text-muted">
                                @if (esSolicitante)
                                {
                                    @:No hay peticiones registradas
                                }
                                else
                                {
                                    @:No hay peticiones en el sistema
                                }
                            </h4>
                            <p class="text-muted">
                                @if (puedeCrearPeticiones)
                                {
                                    @:Comienza creando tu primera petici√≥n de servicio
                                }
                                else
                                {
                                    @:No hay peticiones asignadas o pendientes
                                }
                            </p>
                            @if (puedeCrearPeticiones)
                            {
                                <a href="@Url.Action("Crear")" class="btn btn-primary">
                                    <i class="fas fa-plus me-2"></i>Crear Primera Petici√≥n
                                </a>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Navegaci√≥n adicional -->
    <div class="row mt-4">
        <div class="col-12 text-center">
            <div class="btn-group" role="group">
                @if (esTecnico)
                {
                    <a href="@Url.Action("Dashboard")" class="btn btn-outline-info">
                        <i class="fas fa-tachometer-alt me-2"></i>Ir al Dashboard T√©cnico
                    </a>
                }
                
                @if (usuarioRol != "SOLICITANTE")
                {
                    <a href="@Url.Action("Index", "Reportes")" class="btn btn-outline-secondary">
                        <i class="fas fa-chart-bar me-2"></i>Ver Reportes del Sistema
                    </a>
                }

                <a href="@Url.Action("Logout", "Auth")" class="btn btn-outline-dark">
                    <i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesi√≥n
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Configuraci√≥n de DataTables
            $('#tablaPeticiones').DataTable({
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/Spanish.json"
                },
                "pageLength": 10,
                "order": [[0, "desc"]],
                "columnDefs": [
                    { "orderable": false, "targets": @(puedeVerTodasPeticiones ? 9 : 7) } // Columna de acciones no ordenable
                ]
            });

            // Filtros por estado
            $('.filter-btn').click(function() {
                $('.filter-btn').removeClass('active');
                $(this).addClass('active');
                
                var filter = $(this).data('filter');
                
                if (filter === 'all') {
                    $('.peticion-fila').show();
                } else {
                    $('.peticion-fila').hide();
                    $('.peticion-fila[data-estado="' + filter + '"]').show();
                }
            });

            // Auto-refresh cada 3 minutos para usuarios con permisos
            @if (puedeVerTodasPeticiones || esTecnico)
            {
                @:setInterval(function() {
                @:    if ($('.modal:visible').length === 0) {
                @:        console.log('Actualizando lista de peticiones...');
                @:        // En una versi√≥n futura podr√≠amos hacer AJAX aqu√≠
                @:    }
                @:}, 180000); // 3 minutos
            }
        });
    </script>

    <style>
        .peticion-fila {
            transition: all 0.3s ease;
        }
        .peticion-fila:hover {
            background-color: #f8f9fa;
            transform: translateY(-1px);
        }
        .badge {
            font-size: 0.75em;
        }
        .filter-btn.active {
            font-weight: bold;
            border-width: 2px;
        }
        .card {
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }
    </style>
} completo?
¬°S√ç! Aqu√≠ tienes el archivo Index.cshtml COMPLETAMENTE MODIFICADO con todos los cambios necesarios:

üéØ CAMBIOS PRINCIPALES:
‚úÖ Usar RolesSistema.cs en lugar de strings m√°gicas

‚úÖ Mostrar solicitante con departamento para ADMIN/COORDINADOR

‚úÖ T√©cnicos e H√≠bridos tambi√©n ven solicitante

‚úÖ Indicadores de verificaci√≥n (No verificado, Por tel√©fono)

‚úÖ Bot√≥n "Tomar Petici√≥n" para t√©cnicos/h√≠bridos

‚úÖ L√≥gica de roles actualizada

html
@model IEnumerable<SistemaReportesWeb.Models.PeticionServicio>
@using SistemaReportesWeb.Constantes  <!-- ‚úÖ AGREGAR ESTA L√çNEA -->
@{
    ViewData["Title"] = "Peticiones de Servicio";
    var usuarioRol = ViewBag.UsuarioRol as string;
    
    // ‚úÖ USAR CONSTANTES EN LUGAR DE STRINGS M√ÅGICOS
    var esSolicitante = usuarioRol == RolesSistema.SOLICITANTE;
    var esTecnico = usuarioRol == RolesSistema.TECNICO;
    var esHibrido = usuarioRol == RolesSistema.HIBRIDO;
    var esCoordinador = usuarioRol == RolesSistema.COORDINADOR;
    var esAdmin = usuarioRol == RolesSistema.ADMIN;
    
    // ‚úÖ L√ìGICA DE PERMISOS MEJORADA
    var puedeCrearPeticiones = RolesSistema.PuedeCrearPeticiones(usuarioRol);
    var puedeAtenderPeticiones = RolesSistema.PuedeAtenderPeticiones(usuarioRol);
    var puedeVerTodasPeticiones = esCoordinador || esAdmin;
    var puedeVerSolicitante = puedeVerTodasPeticiones || esTecnico || esHibrido;  <!-- ‚úÖ T√âCNICOS/H√çBRIDOS TAMBI√âN VEN SOLICITANTE -->
}

<div class="container mt-4">
    <!-- Header con informaci√≥n del usuario -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-clipboard-list me-2"></i>@ViewData["Title"]
                    </h2>
                    <p class="text-muted mb-0">
                        <i class="fas fa-user me-1"></i>
                        <strong>@ViewBag.UsuarioNombre</strong> - 
                        <span class="badge bg-info">@usuarioRol</span>
                        @if (esSolicitante)
                        {
                            <span class="badge bg-warning ms-2"><i class="fas fa-eye me-1"></i>Solo sus peticiones</span>
                        }
                        @if (puedeVerTodasPeticiones)
                        {
                            <span class="badge bg-success ms-2"><i class="fas fa-users me-1"></i>Todas las peticiones</span>
                        }
                        @if (esHibrido)
                        {
                            <span class="badge bg-primary ms-2"><i class="fas fa-user-cog me-1"></i>Modo H√≠brido</span>
                        }
                    </p>
                </div>
                
                <div class="btn-group">
                    @if (puedeCrearPeticiones)
                    {
                        <a href="@Url.Action("Crear")" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>Nueva Petici√≥n
                        </a>
                    }
                    
                    @if (puedeAtenderPeticiones)
                    {
                        <a href="@Url.Action("Dashboard")" class="btn btn-success">
                            <i class="fas fa-tachometer-alt me-2"></i>Dashboard T√©cnico
                        </a>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Tarjeta de estad√≠sticas -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-2">
                            <h4 class="text-primary">@Model.Count()</h4>
                            <small class="text-muted">Total</small>
                        </div>
                        <div class="col-md-2">
                            <h4 class="text-warning">@Model.Count(p => p.Estado == "PENDIENTE")</h4>
                            <small class="text-muted">Pendientes</small>
                        </div>
                        <div class="col-md-2">
                            <h4 class="text-info">@Model.Count(p => p.Estado == "EN_PROCESO")</h4>
                            <small class="text-muted">En Proceso</small>
                        </div>
                        <div class="col-md-2">
                            <h4 class="text-success">@Model.Count(p => p.Estado == "COMPLETADO")</h4>
                            <small class="text-muted">Completadas</small>
                        </div>
                        <div class="col-md-2">
                            <h4 class="text-danger">@Model.Count(p => p.Estado == "CANCELADO")</h4>
                            <small class="text-muted">Canceladas</small>
                        </div>
                        <div class="col-md-2">
                            <h4 class="text-secondary">@Model.Count(p => p.Prioridad == "ALTA")</h4>
                            <small class="text-muted">Prioridad Alta</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros r√°pidos -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body py-2">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary filter-btn active" data-filter="all">
                            <i class="fas fa-list me-1"></i>Todas (@Model.Count())
                        </button>
                        <button type="button" class="btn btn-outline-warning filter-btn" data-filter="PENDIENTE">
                            <i class="fas fa-clock me-1"></i>Pendientes (@Model.Count(p => p.Estado == "PENDIENTE"))
                        </button>
                        <button type="button" class="btn btn-outline-info filter-btn" data-filter="EN_PROCESO">
                            <i class="fas fa-cogs me-1"></i>En Proceso (@Model.Count(p => p.Estado == "EN_PROCESO"))
                        </button>
                        <button type="button" class="btn btn-outline-success filter-btn" data-filter="COMPLETADO">
                            <i class="fas fa-check me-1"></i>Completadas (@Model.Count(p => p.Estado == "COMPLETADO"))
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de peticiones -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>Lista de Peticiones
                        @if (esSolicitante)
                        {
                            <small class="text-muted">(Solo sus peticiones)</small>
                        }
                    </h5>
                </div>
                <div class="card-body">
                    @if (Model.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover" id="tablaPeticiones">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>T√≠tulo</th>
                                        @if (puedeVerSolicitante)  <!-- ‚úÖ MODIFICADO: T√©cnicos/h√≠bridos tambi√©n ven -->
                                        {
                                            <th>Solicitante</th>
                                        }
                                        <th>Localidad</th>
                                        <th>Tipo Servicio</th>
                                        <th>Prioridad</th>
                                        <th>Estado</th>
                                        @if (puedeAtenderPeticiones)  <!-- ‚úÖ MODIFICADO: Usar constante -->
                                        {
                                            <th>T√©cnico Asignado</th>
                                        }
                                        <th>Fecha Solicitud</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                
                                <tbody>
                                    @foreach (var peticion in Model)
                                    {
                                        <tr class="peticion-fila" data-estado="@peticion.Estado">
                                            <td>
                                                <strong>#@peticion.Id</strong>
                                            </td>
                                            <td>
                                                <div class="fw-bold">@peticion.Titulo</div>
                                                <small class="text-muted">
                                                    @(peticion.Descripcion.Length > 50 ? 
                                                      peticion.Descripcion.Substring(0, 50) + "..." : 
                                                      peticion.Descripcion)
                                                </small>
                                            </td>
                                            
                                            @if (puedeVerSolicitante)
                                            {
                                                <!-- ‚úÖ NUEVO C√ìDIGO: SOLICITANTE CON DEPARTAMENTO Y VERIFICACI√ìN -->
                                                <td>
                                                    <!-- SOLICITANTE CON DEPARTAMENTO -->
                                                    <div class="fw-bold">@peticion.UsuarioSolicitante?.NombreCompleto</div>
                                                    <small class="text-muted">
                                                        <i class="fas fa-building me-1"></i>
                                                        @peticion.UsuarioSolicitante?.Departamento
                                                    </small>
                                                    
                                                    <!-- INDICADOR SI ES VERIFICADO -->
                                                    @if (!peticion.OrigenVerificado)
                                                    {
                                                        <div class="mt-1">
                                                            <span class="badge bg-warning">
                                                                <i class="fas fa-exclamation-triangle me-1"></i>No verificado
                                                            </span>
                                                        </div>
                                                    }
                                                    @if (peticion.EsUrgenteTelefono)
                                                    {
                                                        <div class="mt-1">
                                                            <span class="badge bg-danger">
                                                                <i class="fas fa-phone me-1"></i>Por tel√©fono
                                                            </span>
                                                        </div>
                                                    }
                                                    
                                                    <!-- INFO SI FUE VERIFICADO POR H√çBRIDO -->
                                                    @if (peticion.VerificadoPorId != null && peticion.VerificadoPorId != peticion.UsuarioSolicitanteId)
                                                    {
                                                        <div class="mt-1">
                                                            <small class="text-info">
                                                                <i class="fas fa-user-check me-1"></i>
                                                                Verif: @peticion.VerificadoPor?.NombreCompleto
                                                            </small>
                                                        </div>
                                                    }
                                                </td>
                                            }
                                            
                                            <td>@peticion.Localidad?.Nombre</td>
                                            <td>
                                                <span class="badge bg-secondary">@peticion.TipoServicio</span>
                                            </td>
                                            <td>
                                                @{
                                                    var prioridadClass = peticion.Prioridad switch
                                                    {
                                                        "URGENTE" => "danger",
                                                        "ALTA" => "warning",
                                                        "MEDIA" => "info",
                                                        "BAJA" => "success",
                                                        _ => "secondary"
                                                    };
                                                }
                                                <span class="badge bg-@prioridadClass">@peticion.Prioridad</span>
                                            </td>
                                            <td>
                                                @{
                                                    var estadoClass = peticion.Estado switch
                                                    {
                                                        "PENDIENTE" => "warning",
                                                        "EN_PROCESO" => "info",
                                                        "COMPLETADO" => "success",
                                                        "CANCELADO" => "danger",
                                                        _ => "secondary"
                                                    };
                                                }
                                                <span class="badge bg-@estadoClass">@peticion.Estado</span>
                                            </td>
                                            
                                            @if (puedeAtenderPeticiones)
                                            {
                                                <td>
                                                    @if (peticion.TecnicoAsignado != null)
                                                    {
                                                        <span class="text-success">
                                                            <i class="fas fa-user-tie me-1"></i>
                                                            @peticion.TecnicoAsignado.NombreCompleto
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">
                                                            <i class="fas fa-user-clock me-1"></i>
                                                            No asignado
                                                        </span>
                                                    }
                                                </td>
                                            }
                                            
                                            <td>@peticion.FechaSolicitud.ToString("dd/MM/yyyy HH:mm")</td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <!-- Ver Detalles -->
                                                    <a href="@Url.Action("Detalles", new { id = peticion.Id })" 
                                                       class="btn btn-outline-primary" title="Ver detalles">
                                                        <i class="fas fa-eye"></i>
                                                    </a>

                                                    <!-- ‚úÖ BOT√ìN "TOMAR PETICI√ìN" (solo t√©cnicos/h√≠bridos para peticiones pendientes) -->
                                                    @if ((esTecnico || esHibrido) && peticion.Estado == "PENDIENTE")
                                                    {
                                                        <button class="btn btn-outline-success tomar-peticion-btn" 
                                                                title="Tomar esta petici√≥n"
                                                                data-peticion-id="@peticion.Id">
                                                            <i class="fas fa-hand-paper"></i>
                                                        </button>
                                                    }

                                                    <!-- Crear Reporte (solo t√©cnicos/h√≠bridos para peticiones en proceso/completadas) -->
                                                    @if ((puedeAtenderPeticiones && peticion.Estado != "PENDIENTE") || puedeVerTodasPeticiones)
                                                    {
                                                        <a href="@Url.Action("Crear", "Reportes", new { peticionId = peticion.Id })" 
                                                           class="btn btn-outline-info" title="Crear reporte">
                                                            <i class="fas fa-file-alt"></i>
                                                        </a>
                                                    }

                                                    <!-- Editar (solo solicitante de la petici√≥n o roles superiores) -->
                                                    @if ((esSolicitante && peticion.UsuarioSolicitanteId.ToString() == ViewBag.UsuarioId?.ToString()) || puedeVerTodasPeticiones)
                                                    {
                                                        <a href="@Url.Action("Editar", new { id = peticion.Id })" 
                                                           class="btn btn-outline-warning" title="Editar petici√≥n">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                    }

                                                    <!-- Eliminar (solo admin/coordinador) -->
                                                    @if (puedeVerTodasPeticiones)
                                                    {
                                                        <form asp-action="Eliminar" method="post" class="d-inline" 
                                                              onsubmit="return confirm('¬øEst√° seguro de eliminar esta petici√≥n?');">
                                                            <input type="hidden" name="id" value="@peticion.Id" />
                                                            <button type="submit" class="btn btn-outline-danger" title="Eliminar">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </form>
                                                    }
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
                            <h4 class="text-muted">
                                @if (esSolicitante)
                                {
                                    @:No hay peticiones registradas
                                }
                                else
                                {
                                    @:No hay peticiones en el sistema
                                }
                            </h4>
                            <p class="text-muted">
                                @if (puedeCrearPeticiones)
                                {
                                    @:Comienza creando tu primera petici√≥n de servicio
                                }
                                else
                                {
                                    @:No hay peticiones asignadas o pendientes
                                }
                            </p>
                            @if (puedeCrearPeticiones)
                            {
                                <a href="@Url.Action("Crear")" class="btn btn-primary">
                                    <i class="fas fa-plus me-2"></i>Crear Primera Petici√≥n
                                </a>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Navegaci√≥n adicional -->
    <div class="row mt-4">
        <div class="col-12 text-center">
            <div class="btn-group" role="group">
                @if (puedeAtenderPeticiones)
                {
                    <a href="@Url.Action("Dashboard")" class="btn btn-outline-info">
                        <i class="fas fa-tachometer-alt me-2"></i>Ir al Dashboard T√©cnico
                    </a>
                }
                
                @if (!esSolicitante)
                {
                    <a href="@Url.Action("Index", "Reportes")" class="btn btn-outline-secondary">
                        <i class="fas fa-chart-bar me-2"></i>Ver Reportes del Sistema
                    </a>
                }

                <a href="@Url.Action("Logout", "Auth")" class="btn btn-outline-dark">
                    <i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesi√≥n
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Configuraci√≥n de DataTables
            var columnaAcciones = @(puedeVerSolicitante ? 9 : 8); // Calcula din√°micamente
            $('#tablaPeticiones').DataTable({
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/Spanish.json"
                },
                "pageLength": 10,
                "order": [[0, "desc"]],
                "columnDefs": [
                    { "orderable": false, "targets": columnaAcciones } // Columna de acciones no ordenable
                ]
            });

            // Filtros por estado
            $('.filter-btn').click(function() {
                $('.filter-btn').removeClass('active');
                $(this).addClass('active');
                
                var filter = $(this).data('filter');
                
                if (filter === 'all') {
                    $('.peticion-fila').show();
                } else {
                    $('.peticion-fila').hide();
                    $('.peticion-fila[data-estado="' + filter + '"]').show();
                }
            });

            // ‚úÖ FUNCIONALIDAD "TOMAR PETICI√ìN"
            $('.tomar-peticion-btn').click(function() {
                var peticionId = $(this).data('peticion-id');
                var $btn = $(this);
                
                if (confirm('¬øEst√° seguro de tomar esta petici√≥n?')) {
                    $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
                    
                    $.ajax({
                        url: '@Url.Action("TomarPeticion", "Peticiones")',
                        type: 'POST',
                        data: { 
                            peticionId: peticionId,
                            __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                        },
                        success: function(response) {
                            if (response.success) {
                                alert('‚úÖ Petici√≥n tomada exitosamente');
                                location.reload(); // Recargar para ver cambios
                            } else {
                                alert('‚ùå Error: ' + response.message);
                                $btn.prop('disabled', false).html('<i class="fas fa-hand-paper"></i>');
                            }
                        },
                        error: function() {
                            alert('‚ùå Error al tomar la petici√≥n');
                            $btn.prop('disabled', false).html('<i class="fas fa-hand-paper"></i>');
                        }
                    });
                }
            });

            // Auto-refresh cada 3 minutos para usuarios con permisos
            @if (puedeVerTodasPeticiones || puedeAtenderPeticiones)
            {
                @:setInterval(function() {
                @:    if ($('.modal:visible').length === 0) {
                @:        console.log('Actualizando lista de peticiones...');
                @:        // En una versi√≥n futura podr√≠amos hacer AJAX aqu√≠
                @:    }
                @:}, 180000); // 3 minutos
            }
        });
    </script>

    <style>
        .peticion-fila {
            transition: all 0.3s ease;
        }
        .peticion-fila:hover {
            background-color: #f8f9fa;
            transform: translateY(-1px);
        }
        .badge {
            font-size: 0.75em;
        }
        .filter-btn.active {
            font-weight: bold;
            border-width: 2px;
        }
        .card {
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }
        .tomar-peticion-btn:hover {
            background-color: #198754;
            color: white;
        }
    </style>
}
üöÄ NECESITAS TAMBI√âN:
1. Agregar m√©todo TomarPeticion en PeticionesController.cs:
csharp
[HttpPost]
[ValidateAntiForgeryToken]
public async Task<JsonResult> TomarPeticion(int peticionId)
{
    var usuarioId = HttpContext.Session.GetInt32("UserId");
    var usuarioRol = HttpContext.Session.GetString("Rol");

    if (usuarioId == null || (!RolesSistema.PuedeAtenderPeticiones(usuarioRol)))
    {
        return Json(new { success = false, message = "No autorizado" });
    }

    try
    {
        var peticion = await _context.PeticionesServicio.FindAsync(peticionId);
        if (peticion == null)
        {
            return Json(new { success = false, message = "Petici√≥n no encontrada" });
        }

        if (peticion.Estado != "PENDIENTE")
        {
            return Json(new { success = false, message = "La petici√≥n no est√° disponible" });
        }

        // Asignar al t√©cnico/h√≠brido
        peticion.TecnicoAsignadoId = usuarioId;
        peticion.Estado = "EN_PROCESO";
        peticion.FechaLimite = peticion.FechaLimite ?? DateTime.Now.AddDays(3);

        _context.Update(peticion);
        
        // Registrar en auditor√≠a
        _context.LogsAuditoria.Add(new LogAuditoria
        {
            UsuarioId = usuarioId.Value,
            Accion = "TOMAR_PETICION",
            Detalle = $"Tom√≥ la petici√≥n #{peticionId}",
            Fecha = DateTime.Now,
            IpAddress = HttpContext.Connection.RemoteIpAddress?.ToString()
        });

        await _context.SaveChangesAsync();

        return Json(new { success = true, message = "Petici√≥n tomada exitosamente" });
    }
    catch (Exception ex)
    {
        return Json(new { success = false, message = "Error: " + ex.Message });
    }
}
2. Aseg√∫rate de tener el archivo RolesSistema.cs (te lo envi√© antes)
3. Ejecutar el SQL para agregar los campos de trazabilidad a peticiones_servicio
¬øQuieres que prepare tambi√©n el archivo Crear.cshtml modificado para h√≠bridos? üéØ

le hice build y salio losiguiente:                                                                                                              Restauraci√≥n completada (3,1s)
  SistemaReportesWeb error con 5 errores y 3 advertencias (21,0s)
    C:\SistemaReportesWeb\SistemaReportesWeb\Views\Peticiones\Index.cshtml(150,68): error RZ1008: Single-statement control-flow statements in Razor documents statements cannot contain markup. Markup should be enclosed in "{" and "}".
    C:\SistemaReportesWeb\SistemaReportesWeb\Views\Peticiones\Index.cshtml(158,71): error RZ1008: Single-statement control-flow statements in Razor documents statements cannot contain markup. Markup should be enclosed in "{" and "}".
    C:\SistemaReportesWeb\SistemaReportesWeb\Views\Peticiones\Index.cshtml(15,66): warning CS8604: Posible argumento de referencia nulo para el par√°metro "rol" en "bool RolesSistema.PuedeCrearPeticiones(string rol)".
    C:\SistemaReportesWeb\SistemaReportesWeb\Controllers\ReportesController.cs(303,33): warning CS8602: Desreferencia de una referencia posiblemente NULL.
    C:\SistemaReportesWeb\SistemaReportesWeb\Controllers\ReportesController.cs(324,39): warning CS8602: Desreferencia de una referencia posiblemente NULL.
    C:\SistemaReportesWeb\SistemaReportesWeb\Controllers\PeticionesController.cs(256,32): error CS0103: El nombre 'RolesSistema' no existe en el contexto actual
    C:\SistemaReportesWeb\SistemaReportesWeb\Controllers\PeticionesController.cs(282,18): error CS1061: "ApplicationDbContext" no contiene una definici√≥n para "LogsAuditoria" ni un m√©todo de extensi√≥n accesible "LogsAuditoria" que acepte un primer argumento del tipo "ApplicationDbContext" (¬øfalta alguna directiva using o una referencia de ensamblado?)
    C:\SistemaReportesWeb\SistemaReportesWeb\Controllers\PeticionesController.cs(282,40): error CS0246: El nombre del tipo o del espacio de nombres 'LogAuditoria' no se encontr√≥ (¬øfalta una directiva using o una referencia de ensamblado?)

Compilaci√≥n error con 5 errores y 3 advertencias en 25,7s
¬°Vamos a corregir estos errores paso a paso! Son problemas comunes de compilaci√≥n.

üîß ERROR 1: RolesSistema no existe en el contexto actual
Soluci√≥n: Crear el archivo RolesSistema.cs

csharp
// Crear archivo: SistemaReportesWeb/Constantes/RolesSistema.cs
namespace SistemaReportesWeb.Constantes
{
    public static class RolesSistema
    {
        // Roles con los valores EXACTOS que usar√°s en BD
        public const string ADMIN = "ADMIN";
        public const string COORDINADOR = "COORDINADOR";
        public const string HIBRIDO = "HIBRIDO";
        public const string TECNICO = "TECNICO";
        public const string SOLICITANTE = "SOLICITANTE";

        // M√©todos de ayuda con manejo de null
        public static bool PuedeCrearPeticiones(string? rol)
        {
            if (string.IsNullOrEmpty(rol)) return false;
            return rol == SOLICITANTE || rol == HIBRIDO || rol == ADMIN;
        }

        public static bool PuedeAtenderPeticiones(string? rol)
        {
            if (string.IsNullOrEmpty(rol)) return false;
            return rol == TECNICO || rol == HIBRIDO || rol == COORDINADOR || rol == ADMIN;
        }

        public static bool PuedeVerTodasLocalidades(string? rol)
        {
            if (string.IsNullOrEmpty(rol)) return false;
            return rol == COORDINADOR || rol == ADMIN;
        }

        public static bool SoloSuLocalidad(string? rol)
        {
            if (string.IsNullOrEmpty(rol)) return false;
            return rol == TECNICO || rol == HIBRIDO;
        }

        public static bool RequiereVerificacionOrigen(string? rol)
        {
            if (string.IsNullOrEmpty(rol)) return false;
            return rol == HIBRIDO;
        }

        // Lista para dropdowns o validaciones
        public static List<string> TodosLosRoles()
        {
            return new List<string> { ADMIN, COORDINADOR, HIBRIDO, TECNICO, SOLICITANTE };
        }

        // Para ordenar o comparar niveles
        public static int NivelAcceso(string? rol)
        {
            if (string.IsNullOrEmpty(rol)) return 0;
            
            return rol switch
            {
                ADMIN => 100,
                COORDINADOR => 80,
                HIBRIDO => 60,
                TECNICO => 40,
                SOLICITANTE => 20,
                _ => 0
            };
        }
    }
}
üîß ERROR 2: Problemas de sintaxis en Index.cshtml
Los errores en l√≠neas 150 y 158 son porque faltan llaves {} en las declaraciones if.

Versi√≥n CORREGIDA del Index.cshtml:

html
@model IEnumerable<SistemaReportesWeb.Models.PeticionServicio>
@using SistemaReportesWeb.Constantes
@{
    ViewData["Title"] = "Peticiones de Servicio";
    var usuarioRol = ViewBag.UsuarioRol as string;
    
    // ‚úÖ CORREGIDO: Manejar null
    var esSolicitante = usuarioRol == RolesSistema.SOLICITANTE;
    var esTecnico = usuarioRol == RolesSistema.TECNICO;
    var esHibrido = usuarioRol == RolesSistema.HIBRIDO;
    var esCoordinador = usuarioRol == RolesSistema.COORDINADOR;
    var esAdmin = usuarioRol == RolesSistema.ADMIN;
    
    // ‚úÖ CORREGIDO: Pasar usuarioRol (puede ser null)
    var puedeCrearPeticiones = RolesSistema.PuedeCrearPeticiones(usuarioRol);
    var puedeAtenderPeticiones = RolesSistema.PuedeAtenderPeticiones(usuarioRol);
    var puedeVerTodasPeticiones = esCoordinador || esAdmin;
    var puedeVerSolicitante = puedeVerTodasPeticiones || esTecnico || esHibrido;
}

<div class="container mt-4">
    <!-- Header con informaci√≥n del usuario -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-clipboard-list me-2"></i>@ViewData["Title"]
                    </h2>
                    <p class="text-muted mb-0">
                        <i class="fas fa-user me-1"></i>
                        <strong>@ViewBag.UsuarioNombre</strong> - 
                        <span class="badge bg-info">@usuarioRol</span>
                        @if (esSolicitante)
                        {
                            <span class="badge bg-warning ms-2"><i class="fas fa-eye me-1"></i>Solo sus peticiones</span>
                        }
                        @if (puedeVerTodasPeticiones)
                        {
                            <span class="badge bg-success ms-2"><i class="fas fa-users me-1"></i>Todas las peticiones</span>
                        }
                        @if (esHibrido)
                        {
                            <span class="badge bg-primary ms-2"><i class="fas fa-user-cog me-1"></i>Modo H√≠brido</span>
                        }
                    </p>
                </div>
                
                <div class="btn-group">
                    @if (puedeCrearPeticiones)
                    {
                        <a href="@Url.Action("Crear")" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>Nueva Petici√≥n
                        </a>
                    }
                    
                    @if (puedeAtenderPeticiones)
                    {
                        <a href="@Url.Action("Dashboard")" class="btn btn-success">
                            <i class="fas fa-tachometer-alt me-2"></i>Dashboard T√©cnico
                        </a>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Tarjeta de estad√≠sticas -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-2">
                            <h4 class="text-primary">@Model.Count()</h4>
                            <small class="text-muted">Total</small>
                        </div>
                        <div class="col-md-2">
                            <h4 class="text-warning">@Model.Count(p => p.Estado == "PENDIENTE")</h4>
                            <small class="text-muted">Pendientes</small>
                        </div>
                        <div class="col-md-2">
                            <h4 class="text-info">@Model.Count(p => p.Estado == "EN_PROCESO")</h4>
                            <small class="text-muted">En Proceso</small>
                        </div>
                        <div class="col-md-2">
                            <h4 class="text-success">@Model.Count(p => p.Estado == "COMPLETADO")</h4>
                            <small class="text-muted">Completadas</small>
                        </div>
                        <div class="col-md-2">
                            <h4 class="text-danger">@Model.Count(p => p.Estado == "CANCELADO")</h4>
                            <small class="text-muted">Canceladas</small>
                        </div>
                        <div class="col-md-2">
                            <h4 class="text-secondary">@Model.Count(p => p.Prioridad == "ALTA")</h4>
                            <small class="text-muted">Prioridad Alta</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros r√°pidos -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body py-2">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary filter-btn active" data-filter="all">
                            <i class="fas fa-list me-1"></i>Todas (@Model.Count())
                        </button>
                        <button type="button" class="btn btn-outline-warning filter-btn" data-filter="PENDIENTE">
                            <i class="fas fa-clock me-1"></i>Pendientes (@Model.Count(p => p.Estado == "PENDIENTE"))
                        </button>
                        <button type="button" class="btn btn-outline-info filter-btn" data-filter="EN_PROCESO">
                            <i class="fas fa-cogs me-1"></i>En Proceso (@Model.Count(p => p.Estado == "EN_PROCESO"))
                        </button>
                        <button type="button" class="btn btn-outline-success filter-btn" data-filter="COMPLETADO">
                            <i class="fas fa-check me-1"></i>Completadas (@Model.Count(p => p.Estado == "COMPLETADO"))
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de peticiones -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>Lista de Peticiones
                        @if (esSolicitante)
                        {
                            <small class="text-muted">(Solo sus peticiones)</small>
                        }
                    </h5>
                </div>
                <div class="card-body">
                    @if (Model.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover" id="tablaPeticiones">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>T√≠tulo</th>
                                        @if (puedeVerSolicitante)
                                        {
                                            <th>Solicitante</th>
                                        }
                                        <th>Localidad</th>
                                        <th>Tipo Servicio</th>
                                        <th>Prioridad</th>
                                        <th>Estado</th>
                                        @if (puedeAtenderPeticiones)
                                        {
                                            <th>T√©cnico Asignado</th>
                                        }
                                        <th>Fecha Solicitud</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                
                                <tbody>
                                    @foreach (var peticion in Model)
                                    {
                                        <tr class="peticion-fila" data-estado="@peticion.Estado">
                                            <td>
                                                <strong>#@peticion.Id</strong>
                                            </td>
                                            <td>
                                                <div class="fw-bold">@peticion.Titulo</div>
                                                <small class="text-muted">
                                                    @(peticion.Descripcion.Length > 50 ? 
                                                      peticion.Descripcion.Substring(0, 50) + "..." : 
                                                      peticion.Descripcion)
                                                </small>
                                            </td>
                                            
                                            @if (puedeVerSolicitante)
                                            {
                                                <!-- ‚úÖ CORREGIDO: Con llaves {} -->
                                                <td>
                                                    <div class="fw-bold">@peticion.UsuarioSolicitante?.NombreCompleto</div>
                                                    <small class="text-muted">
                                                        <i class="fas fa-building me-1"></i>
                                                        @peticion.UsuarioSolicitante?.Departamento
                                                    </small>
                                                    
                                                    <!-- INDICADOR SI ES VERIFICADO -->
                                                    @if (!peticion.OrigenVerificado)
                                                    {
                                                        <div class="mt-1">
                                                            <span class="badge bg-warning">
                                                                <i class="fas fa-exclamation-triangle me-1"></i>No verificado
                                                            </span>
                                                        </div>
                                                    }
                                                    @if (peticion.EsUrgenteTelefono)
                                                    {
                                                        <div class="mt-1">
                                                            <span class="badge bg-danger">
                                                                <i class="fas fa-phone me-1"></i>Por tel√©fono
                                                            </span>
                                                        </div>
                                                    }
                                                </td>
                                            }
                                            
                                            <td>@peticion.Localidad?.Nombre</td>
                                            <td>
                                                <span class="badge bg-secondary">@peticion.TipoServicio</span>
                                            </td>
                                            <td>
                                                @{
                                                    var prioridadClass = peticion.Prioridad switch
                                                    {
                                                        "URGENTE" => "danger",
                                                        "ALTA" => "warning",
                                                        "MEDIA" => "info",
                                                        "BAJA" => "success",
                                                        _ => "secondary"
                                                    };
                                                }
                                                <span class="badge bg-@prioridadClass">@peticion.Prioridad</span>
                                            </td>
                                            <td>
                                                @{
                                                    var estadoClass = peticion.Estado switch
                                                    {
                                                        "PENDIENTE" => "warning",
                                                        "EN_PROCESO" => "info",
                                                        "COMPLETADO" => "success",
                                                        "CANCELADO" => "danger",
                                                        _ => "secondary"
                                                    };
                                                }
                                                <span class="badge bg-@estadoClass">@peticion.Estado</span>
                                            </td>
                                            
                                            @if (puedeAtenderPeticiones)
                                            {
                                                <td>
                                                    @if (peticion.TecnicoAsignado != null)
                                                    {
                                                        <span class="text-success">
                                                            <i class="fas fa-user-tie me-1"></i>
                                                            @peticion.TecnicoAsignado.NombreCompleto
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">
                                                            <i class="fas fa-user-clock me-1"></i>
                                                            No asignado
                                                        </span>
                                                    }
                                                </td>
                                            }
                                            
                                            <td>@peticion.FechaSolicitud.ToString("dd/MM/yyyy HH:mm")</td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <!-- Ver Detalles -->
                                                    <a href="@Url.Action("Detalles", new { id = peticion.Id })" 
                                                       class="btn btn-outline-primary" title="Ver detalles">
                                                        <i class="fas fa-eye"></i>
                                                    </a>

                                                    <!-- ‚úÖ CORREGIDO: Con llaves {} -->
                                                    @if ((esTecnico || esHibrido) && peticion.Estado == "PENDIENTE")
                                                    {
                                                        <button class="btn btn-outline-success tomar-peticion-btn" 
                                                                title="Tomar esta petici√≥n"
                                                                data-peticion-id="@peticion.Id">
                                                            <i class="fas fa-hand-paper"></i>
                                                        </button>
                                                    }

                                                    <!-- ‚úÖ CORREGIDO: Con llaves {} -->
                                                    @if ((puedeAtenderPeticiones && peticion.Estado != "PENDIENTE") || puedeVerTodasPeticiones)
                                                    {
                                                        <a href="@Url.Action("Crear", "Reportes", new { peticionId = peticion.Id })" 
                                                           class="btn btn-outline-info" title="Crear reporte">
                                                            <i class="fas fa-file-alt"></i>
                                                        </a>
                                                    }

                                                    <!-- ‚úÖ CORREGIDO: Con llaves {} -->
                                                    @if ((esSolicitante && peticion.UsuarioSolicitanteId.ToString() == ViewBag.UsuarioId?.ToString()) || puedeVerTodasPeticiones)
                                                    {
                                                        <a href="@Url.Action("Editar", new { id = peticion.Id })" 
                                                           class="btn btn-outline-warning" title="Editar petici√≥n">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                    }

                                                    <!-- ‚úÖ CORREGIDO: Con llaves {} -->
                                                    @if (puedeVerTodasPeticiones)
                                                    {
                                                        <form asp-action="Eliminar" method="post" class="d-inline" 
                                                              onsubmit="return confirm('¬øEst√° seguro de eliminar esta petici√≥n?');">
                                                            <input type="hidden" name="id" value="@peticion.Id" />
                                                            <button type="submit" class="btn btn-outline-danger" title="Eliminar">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </form>
                                                    }
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
                            <h4 class="text-muted">
                                @if (esSolicitante)
                                {
                                    @:No hay peticiones registradas
                                }
                                else
                                {
                                    @:No hay peticiones en el sistema
                                }
                            </h4>
                            <p class="text-muted">
                                @if (puedeCrearPeticiones)
                                {
                                    @:Comienza creando tu primera petici√≥n de servicio
                                }
                                else
                                {
                                    @:No hay peticiones asignadas o pendientes
                                }
                            </p>
                            @if (puedeCrearPeticiones)
                            {
                                <a href="@Url.Action("Crear")" class="btn btn-primary">
                                    <i class="fas fa-plus me-2"></i>Crear Primera Petici√≥n
                                </a>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Navegaci√≥n adicional -->
    <div class="row mt-4">
        <div class="col-12 text-center">
            <div class="btn-group" role="group">
                @if (puedeAtenderPeticiones)
                {
                    <a href="@Url.Action("Dashboard")" class="btn btn-outline-info">
                        <i class="fas fa-tachometer-alt me-2"></i>Ir al Dashboard T√©cnico
                    </a>
                }
                
                @if (!esSolicitante)
                {
                    <a href="@Url.Action("Index", "Reportes")" class="btn btn-outline-secondary">
                        <i class="fas fa-chart-bar me-2"></i>Ver Reportes del Sistema
                    </a>
                }

                <a href="@Url.Action("Logout", "Auth")" class="btn btn-outline-dark">
                    <i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesi√≥n
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Configuraci√≥n de DataTables
            var columnaAcciones = @(puedeVerSolicitante ? 9 : 8);
            $('#tablaPeticiones').DataTable({
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/Spanish.json"
                },
                "pageLength": 10,
                "order": [[0, "desc"]],
                "columnDefs": [
                    { "orderable": false, "targets": columnaAcciones }
                ]
            });

            // Filtros por estado
            $('.filter-btn').click(function() {
                $('.filter-btn').removeClass('active');
                $(this).addClass('active');
                
                var filter = $(this).data('filter');
                
                if (filter === 'all') {
                    $('.peticion-fila').show();
                } else {
                    $('.peticion-fila').hide();
                    $('.peticion-fila[data-estado="' + filter + '"]').show();
                }
            });

            // Tomar Petici√≥n (versi√≥n simplificada)
            $('.tomar-peticion-btn').click(function() {
                var peticionId = $(this).data('peticion-id');
                if (confirm('¬øEst√° seguro de tomar esta petici√≥n?')) {
                    // Redirigir a m√©todo simple de asignaci√≥n
                    window.location.href = '@Url.Action("AsignarPeticion", "Peticiones")' + '?id=' + peticionId;
                }
            });
        });
    </script>

    <style>
        .peticion-fila {
            transition: all 0.3s ease;
        }
        .peticion-fila:hover {
            background-color: #f8f9fa;
            transform: translateY(-1px);
        }
        .badge {
            font-size: 0.75em;
        }
        .filter-btn.active {
            font-weight: bold;
            border-width: 2px;
        }
        .card {
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }
    </style>
}
üîß ERROR 3: LogsAuditoria no existe
Soluci√≥n: Si no tienes tabla de auditor√≠a, simplifica el m√©todo:

csharp
// En PeticionesController.cs - M√©todo TomarPeticion simplificado
[HttpPost]
public async Task<IActionResult> AsignarPeticion(int id)
{
    var usuarioId = HttpContext.Session.GetInt32("UserId");
    var usuarioRol = HttpContext.Session.GetString("Rol");

    if (usuarioId == null || (!RolesSistema.PuedeAtenderPeticiones(usuarioRol)))
    {
        TempData["Error"] = "No tiene permisos";
        return RedirectToAction("Index");
    }

    try
    {
        var peticion = await _context.PeticionesServicio.FindAsync(id);
        if (peticion == null)
        {
            TempData["Error"] = "Petici√≥n no encontrada";
            return RedirectToAction("Index");
        }

        if (peticion.Estado != "PENDIENTE")
        {
            TempData["Error"] = "La petici√≥n no est√° disponible";
            return RedirectToAction("Index");
        }

        // Asignar al t√©cnico/h√≠brido
        peticion.TecnicoAsignadoId = usuarioId;
        peticion.Estado = "EN_PROCESO";
        peticion.FechaLimite = peticion.FechaLimite ?? DateTime.Now.AddDays(3);

        _context.Update(peticion);
        await _context.SaveChangesAsync();

        TempData["Success"] = "¬°Petici√≥n tomada exitosamente!";
        return RedirectToAction("Index");
    }
    catch (Exception ex)
    {
        TempData["Error"] = "Error: " + ex.Message;
        return RedirectToAction("Index");
    }
}
üöÄ PLAN DE ACCI√ìN:
Crear archivo Constantes/RolesSistema.cs

Reemplazar Views/Peticiones/Index.cshtml con la versi√≥n corregida

Modificar m√©todo TomarPeticion en PeticionesController.cs (o usar AsignarPeticion)

Ejecutar Build de nuevo

¬øQuieres que te ayude con alguno de estos pasos espec√≠ficamente? O prefieres que preparemos primero los archivos que fallan. üéØ

Soluci√≥n: Crear el archivo en la carpeta SistemaReportesWeb/Constantes/RolesSistema.cs, yo lo cree anterirmente con el editor sublimetext, cuando me dijiste,  sera que no lo tomo, voy a sustituirlo con el codigo que me acabas de dar
¬°Exacto! El problema es que el archivo debe estar en el lugar correcto y con el namespace correcto. Vamos a verificar:

üîç PROBLEMAS COMUNES:
Ubicaci√≥n incorrecta - No est√° en la carpeta Constantes/

Namespace incorrecto - No coincide con el proyecto

No se compil√≥ - Necesita rebuild

Falta referencia - No est√° incluido en el proyecto (.csproj)

üöÄ SOLUCI√ìN PASO A PASO:
Paso 1: Verificar estructura de carpetas
text
SistemaReportesWeb/
‚îú‚îÄ‚îÄ Controllers/
‚îú‚îÄ‚îÄ Models/
‚îú‚îÄ‚îÄ Views/
‚îú‚îÄ‚îÄ Constantes/           ‚Üê DEBE existir esta carpeta
‚îÇ   ‚îî‚îÄ‚îÄ RolesSistema.cs   ‚Üê Archivo aqu√≠
‚îî‚îÄ‚îÄ SistemaReportesWeb.csproj
Paso 2: Verificar contenido EXACTO del archivo
csharp
// SistemaReportesWeb/Constantes/RolesSistema.cs
using System.Collections.Generic;

namespace SistemaReportesWeb.Constantes
{
    public static class RolesSistema
    {
        // Roles con los valores EXACTOS que usar√°s en BD
        public const string ADMIN = "ADMIN";
        public const string COORDINADOR = "COORDINADOR";
        public const string HIBRIDO = "HIBRIDO";
        public const string TECNICO = "TECNICO";
        public const string SOLICITANTE = "SOLICITANTE";

        // M√©todos de ayuda con manejo de null
        public static bool PuedeCrearPeticiones(string? rol)
        {
            if (string.IsNullOrEmpty(rol)) return false;
            return rol == SOLICITANTE || rol == HIBRIDO || rol == ADMIN;
        }

        public static bool PuedeAtenderPeticiones(string? rol)
        {
            if (string.IsNullOrEmpty(rol)) return false;
            return rol == TECNICO || rol == HIBRIDO || rol == COORDINADOR || rol == ADMIN;
        }

        public static bool PuedeVerTodasLocalidades(string? rol)
        {
            if (string.IsNullOrEmpty(rol)) return false;
            return rol == COORDINADOR || rol == ADMIN;
        }

        public static bool SoloSuLocalidad(string? rol)
        {
            if (string.IsNullOrEmpty(rol)) return false;
            return rol == TECNICO || rol == HIBRIDO;
        }

        public static bool RequiereVerificacionOrigen(string? rol)
        {
            if (string.IsNullOrEmpty(rol)) return false;
            return rol == HIBRIDO;
        }

        // Lista para dropdowns o validaciones
        public static List<string> TodosLosRoles()
        {
            return new List<string> { ADMIN, COORDINADOR, HIBRIDO, TECNICO, SOLICITANTE };
        }

        // Para ordenar o comparar niveles
        public static int NivelAcceso(string? rol)
        {
            if (string.IsNullOrEmpty(rol)) return 0;
            
            return rol switch
            {
                ADMIN => 100,
                COORDINADOR => 80,
                HIBRIDO => 60,
                TECNICO => 40,
                SOLICITANTE => 20,
                _ => 0
            };
        }
    }
}
Paso 3: Verificar el .csproj
Abre SistemaReportesWeb.csproj y busca:

xml
<ItemGroup>
  <!-- Debe incluir el archivo -->
  <Compile Include="Constantes\RolesSistema.cs" />
</ItemGroup>
Si no est√°, agr√©galo manualmente o usa Visual Studio:

Click derecho en proyecto ‚Üí "Agregar" ‚Üí "Clase existente"

Selecciona RolesSistema.cs

Paso 4: Limpiar y reconstruir
bash
# En la carpeta del proyecto:
dotnet clean
dotnet build
Paso 5: Alternativa R√ÅPIDA (archivo temporal)
Si sigue sin funcionar, agrega esto TEMPORALMENTE en _ViewImports.cshtml:

html
@* Views/_ViewImports.cshtml *@
@using SistemaReportesWeb
@using SistemaReportesWeb.Models
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@* ‚úÖ AGREGAR ESTO TEMPORALMENTE *@
@using static SistemaReportesWeb.Constantes.RolesSistema
üìã DIAGN√ìSTICO R√ÅPIDO:
Ejecuta este comando para ver si el archivo existe:

bash
# En PowerShell o CMD:
dir /s RolesSistema.cs
# O en terminal:
find . -name "RolesSistema.cs" -type f
Comparte el resultado y tambi√©n dime:

¬øD√≥nde est√° exactamente el archivo? (ruta completa)

¬øC√≥mo lo creaste? (Visual Studio, SublimeText, etc.)

¬øHiciste Rebuild completo del proyecto?

üéØ SOLUCI√ìN DE EMERGENCIA:
Si no funciona, podemos poner la clase DIRECTAMENTE en el archivo:

csharp
// AGREGAR esto AL PRINCIPIO de Index.cshtml (despu√©s de @model)
@using System.Collections.Generic

@functions {
    public static class RolesSistemaTemp
    {
        public const string ADMIN = "ADMIN";
        public const string COORDINADOR = "COORDINADOR";
        public const string HIBRIDO = "HIBRIDO";
        public const string TECNICO = "TECNICO";
        public const string SOLICITANTE = "SOLICITANTE";

        public static bool PuedeCrearPeticiones(string? rol)
        {
            if (string.IsNullOrEmpty(rol)) return false;
            return rol == SOLICITANTE || rol == HIBRIDO || rol == ADMIN;
        }

        public static bool PuedeAtenderPeticiones(string? rol)
        {
            if (string.IsNullOrEmpty(rol)) return false;
            return rol == TECNICO || rol == HIBRIDO || rol == COORDINADOR || rol == ADMIN;
        }
    }
}

@{
    // Luego usar:
    var puedeCrearPeticiones = RolesSistemaTemp.PuedeCrearPeticiones(usuarioRol);
}
¬øPrefieres la soluci√≥n temporal o quieres que revisemos por qu√© no encuentra el archivo? üöÄ

¬°Dime qu√© prefieres!

Restauraci√≥n completada (2,6s)
  SistemaReportesWeb error con 1 errores (0,1s)
    C:\Program Files\dotnet\sdk\9.0.305\Sdks\Microsoft.NET.Sdk\targets\Microsoft.NET.Sdk.DefaultItems.Shared.targets(190,5): error NETSDK1022: Se incluyeron "Compile" elementos duplicados. El SDK de .NET incluye "Compile" elementos de su directorio de proyecto de manera predeterminada. Puede quitar esos elementos del archivo de proyecto o establecer la propiedad "EnableDefaultCompileItems" en "false" si desea incluirlos expl√≠citamente en el archivo de proyecto. Para m√°s informaci√≥n, consulte https://aka.ms/sdkimplicititems. Los elementos duplicados eran: 'Constantes\RolesSistema.cs'

Compilaci√≥n error con 1 errores en 4,1s
¬°Excelente! El error es claro: tienes el archivo RolesSistema.cs duplicado en el archivo .csproj.

üîç PROBLEMA:
El SDK de .NET incluye autom√°ticamente todos los archivos .cs en la carpeta del proyecto, pero tambi√©n lo tienes incluido manualmente en el .csproj.

üöÄ SOLUCI√ìN R√ÅPIDA:
Opci√≥n 1: Eliminar la l√≠nea duplicada del .csproj
Abre SistemaReportesWeb.csproj

Busca esta l√≠nea y ELIM√çNALA:

xml
<Compile Include="Constantes\RolesSistema.cs" />
Guarda y haz Rebuild

Opci√≥n 2: Ver todo el contenido del .csproj
Comparte el contenido de tu SistemaReportesWeb.csproj para que yo vea exactamente d√≥nde est√° el duplicado.

Opci√≥n 3: Soluci√≥n desde Visual Studio
Click derecho en el proyecto ‚Üí "Descargar proyecto"

Click derecho en el proyecto ‚Üí "Editar [nombre].csproj"

Elimina cualquier l√≠nea que diga:

<Compile Include="Constantes\RolesSistema.cs" />

O que tenga RolesSistema.cs

Guarda

Click derecho en el proyecto ‚Üí "Recargar proyecto"

Rebuild

üìã EJEMPLO DE .csproj CORRECTO:
xml
<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.EntityFrameworkCore.SqlServer" Version="8.0.0" />
    <PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="8.0.0">
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
      <PrivateAssets>all</PrivateAssets>
    </PackageReference>
    <PackageReference Include="Microsoft.VisualStudio.Web.CodeGeneration.Design" Version="8.0.0" />
  </ItemGroup>

  <!-- NO DEBE HABER <Compile Include="Constantes\RolesSistema.cs" /> aqu√≠ -->
  
</Project>
üéØ PASOS A SEGUIR:
Primero, verifica si el archivo RolesSistema.cs existe:

bash
# En la carpeta del proyecto:
dir Constantes\
Si existe, entonces ABRE el .csproj y busca duplicados:

xml
<!-- BUSCA ESTO Y ELIM√çNALO: -->
<ItemGroup>
  <Compile Include="Constantes\RolesSistema.cs" />  <!-- ‚Üê ELIMINAR -->
</ItemGroup>
Si NO encuentras la l√≠nea, entonces el problema es diferente

Podr√≠a estar en un .csproj.user o archivo oculto

O podr√≠a ser problema de cach√©

üîß SOLUCI√ìN DE EMERGENCIA (si no encuentras el duplicado):
Limpiar todo y reconstruir:
bash
# 1. Cerrar Visual Studio/SublimeText
# 2. Eliminar carpetas temporales:
rmdir /s /q bin
rmdir /s /q obj
rmdir /s /q .vs
# 3. Abrir de nuevo y Rebuild
O agregar esta propiedad al .csproj:
xml
<PropertyGroup>
  <TargetFramework>net8.0</TargetFramework>
  <Nullable>enable</Nullable>
  <ImplicitUsings>enable</ImplicitUsings>
  <!-- AGREGAR ESTA L√çNEA: -->
  <EnableDefaultCompileItems>false</EnableDefaultCompileItems>
</PropertyGroup>
‚ùì ¬øQU√â PREFIERES HACER?
Que compartas el contenido de tu .csproj para que yo vea el duplicado

Que intentes eliminar manualmente la l√≠nea duplicada

Que uses la soluci√≥n de emergencia (limpiar todo)

¬°El archivo S√ç existe y el proyecto S√ç lo reconoce! Solo est√° duplicado en la configuraci√≥n. üéØ

Dime qu√© prefieres hacer y te ayudo paso a paso.

Restauraci√≥n completada (2,9s)
  SistemaReportesWeb error con 4 errores y 2 advertencias (18,6s)
    C:\SistemaReportesWeb\SistemaReportesWeb\Controllers\ReportesController.cs(303,33): warning CS8602: Desreferencia de una referencia posiblemente NULL.
    C:\SistemaReportesWeb\SistemaReportesWeb\Controllers\ReportesController.cs(324,39): warning CS8602: Desreferencia de una referencia posiblemente NULL.
    C:\SistemaReportesWeb\SistemaReportesWeb\Controllers\PeticionesController.cs(256,32): error CS0103: El nombre 'RolesSistema' no existe en el contexto actual
    C:\SistemaReportesWeb\SistemaReportesWeb\Controllers\PeticionesController.cs(282,18): error CS1061: "ApplicationDbContext" no contiene una definici√≥n para "LogsAuditoria" ni un m√©todo de extensi√≥n accesible "LogsAuditoria" que acepte un primer argumento del tipo "ApplicationDbContext" (¬øfalta alguna directiva using o una referencia de ensamblado?)
    C:\SistemaReportesWeb\SistemaReportesWeb\Controllers\PeticionesController.cs(282,40): error CS0246: El nombre del tipo o del espacio de nombres 'LogAuditoria' no se encontr√≥ (¬øfalta una directiva using o una referencia de ensamblado?)
    C:\SistemaReportesWeb\SistemaReportesWeb\Controllers\PeticionesController.cs(308,32): error CS0103: El nombre 'RolesSistema' no existe en el contexto actual
¬°Excelente! El error del .csproj se resolvi√≥. Ahora tenemos errores espec√≠ficos y manejables. Vamos a solucionarlos uno por uno:

üöÄ ERROR 1: RolesSistema no existe en el contexto actual
Soluci√≥n: Necesitamos agregar el using en PeticionesController.cs

csharp
// En PeticionesController.cs, al principio del archivo:
using SistemaReportesWeb.Constantes;  // ‚úÖ AGREGAR ESTA L√çNEA
üöÄ ERROR 2: LogsAuditoria no existe en ApplicationDbContext
Soluci√≥n: Si no tienes tabla de auditor√≠a, simplifica el c√≥digo. Aqu√≠ est√° el m√©todo TomarPeticion SIMPLIFICADO:

csharp
// REEMPLAZAR el m√©todo TomarPeticion en PeticionesController.cs:

[HttpPost]
[ValidateAntiForgeryToken]
public async Task<JsonResult> TomarPeticion(int peticionId)
{
    var usuarioId = HttpContext.Session.GetInt32("UserId");
    var usuarioRol = HttpContext.Session.GetString("Rol");

    // ‚úÖ USAR RolesSistema (despu√©s de agregar el using)
    if (usuarioId == null || string.IsNullOrEmpty(usuarioRol) || 
        !(usuarioRol == RolesSistema.TECNICO || 
          usuarioRol == RolesSistema.HIBRIDO || 
          usuarioRol == RolesSistema.COORDINADOR || 
          usuarioRol == RolesSistema.ADMIN))
    {
        return Json(new { success = false, message = "No autorizado" });
    }

    try
    {
        var peticion = await _context.PeticionesServicio.FindAsync(peticionId);
        if (peticion == null)
        {
            return Json(new { success = false, message = "Petici√≥n no encontrada" });
        }

        if (peticion.Estado != "PENDIENTE")
        {
            return Json(new { success = false, message = "La petici√≥n no est√° disponible" });
        }

        // Asignar al t√©cnico/h√≠brido
        peticion.TecnicoAsignadoId = usuarioId;
        peticion.Estado = "EN_PROCESO";
        peticion.FechaLimite = peticion.FechaLimite ?? DateTime.Now.AddDays(3);

        _context.Update(peticion);
        await _context.SaveChangesAsync();

        return Json(new { success = true, message = "Petici√≥n tomada exitosamente" });
    }
    catch (Exception ex)
    {
        return Json(new { success = false, message = "Error: " + ex.Message });
    }
}
üöÄ ERROR 3: Advertencias en ReportesController.cs
Soluci√≥n: Agregar verificaciones de null:

csharp
// Busca estas l√≠neas en ReportesController.cs (alrededor de l√≠nea 303 y 324):

// L√≠nea ~303: Busca algo como:
// var algo = variable.Propiedad;

// Cambia por:
// var algo = variable?.Propiedad ?? valorPorDefecto;

// Ejemplo si encuentras:
var nombre = usuario.Nombre;  // ‚ùå
// Cambia por:
var nombre = usuario?.Nombre ?? "Sin nombre";  // ‚úÖ
üìã ARCHIVO COMPLETO CORREGIDO: PeticionesController.cs
Aqu√≠ tienes la secci√≥n completa corregida del controlador:

csharp
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using SistemaReportesWeb.Data;
using SistemaReportesWeb.Models;
using SistemaReportesWeb.Constantes;  // ‚úÖ AGREGAR ESTA L√çNEA
using System.Linq;
using System.Threading.Tasks;

namespace SistemaReportesWeb.Controllers
{
    public class PeticionesController : Controller
    {
        private readonly ApplicationDbContext _context;

        public PeticionesController(ApplicationDbContext context)
        {
            _context = context;
        }

        // ... resto de m√©todos existentes ...

        // ‚úÖ M√âTODO TOMAR PETICI√ìN CORREGIDO (sin auditor√≠a)
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<JsonResult> TomarPeticion(int peticionId)
        {
            var usuarioId = HttpContext.Session.GetInt32("UserId");
            var usuarioRol = HttpContext.Session.GetString("Rol");

            if (usuarioId == null || string.IsNullOrEmpty(usuarioRol))
            {
                return Json(new { success = false, message = "Debe iniciar sesi√≥n" });
            }

            // Verificar permisos sin RolesSistema por si acaso
            var puedeAtender = usuarioRol == "TECNICO" || 
                              usuarioRol == "HIBRIDO" || 
                              usuarioRol == "COORDINADOR" || 
                              usuarioRol == "ADMIN";

            if (!puedeAtender)
            {
                return Json(new { success = false, message = "No tiene permisos para atender peticiones" });
            }

            try
            {
                var peticion = await _context.PeticionesServicio.FindAsync(peticionId);
                if (peticion == null)
                {
                    return Json(new { success = false, message = "Petici√≥n no encontrada" });
                }

                if (peticion.Estado != "PENDIENTE")
                {
                    return Json(new { success = false, message = "La petici√≥n no est√° disponible" });
                }

                // Asignar al t√©cnico/h√≠brido
                peticion.TecnicoAsignadoId = usuarioId;
                peticion.Estado = "EN_PROCESO";
                peticion.FechaLimite = peticion.FechaLimite ?? DateTime.Now.AddDays(3);

                _context.Update(peticion);
                await _context.SaveChangesAsync();

                return Json(new { success = true, message = "Petici√≥n tomada exitosamente" });
            }
            catch (Exception ex)
            {
                return Json(new { success = false, message = "Error: " + ex.Message });
            }
        }

        // ‚úÖ M√âTODO ASIGNAR PETICI√ìN (alternativa simple)
        public async Task<IActionResult> AsignarPeticion(int id)
        {
            var usuarioId = HttpContext.Session.GetInt32("UserId");
            var usuarioRol = HttpContext.Session.GetString("Rol");

            if (usuarioId == null)
            {
                TempData["Error"] = "Debe iniciar sesi√≥n";
                return RedirectToAction("Index");
            }

            var puedeAtender = usuarioRol == "TECNICO" || 
                              usuarioRol == "HIBRIDO" || 
                              usuarioRol == "COORDINADOR" || 
                              usuarioRol == "ADMIN";

            if (!puedeAtender)
            {
                TempData["Error"] = "No tiene permisos";
                return RedirectToAction("Index");
            }

            try
            {
                var peticion = await _context.PeticionesServicio.FindAsync(id);
                if (peticion == null)
                {
                    TempData["Error"] = "Petici√≥n no encontrada";
                    return RedirectToAction("Index");
                }

                if (peticion.Estado != "PENDIENTE")
                {
                    TempData["Error"] = "La petici√≥n no est√° disponible";
                    return RedirectToAction("Index");
                }

                // Asignar al t√©cnico/h√≠brido
                peticion.TecnicoAsignadoId = usuarioId;
                peticion.Estado = "EN_PROCESO";
                peticion.FechaLimite = peticion.FechaLimite ?? DateTime.Now.AddDays(3);

                _context.Update(peticion);
                await _context.SaveChangesAsync();

                TempData["Success"] = "¬°Petici√≥n tomada exitosamente!";
                return RedirectToAction("Index");
            }
            catch (Exception ex)
            {
                TempData["Error"] = "Error: " + ex.Message;
                return RedirectToAction("Index");
            }
        }

        // ... resto de m√©todos existentes ...
    }
}
üéØ PLAN DE ACCI√ìN:
Agregar using SistemaReportesWeb.Constantes; al principio de PeticionesController.cs

Reemplazar el m√©todo TomarPeticion con la versi√≥n simplificada (sin auditor√≠a)

Agregar m√©todo AsignarPeticion (GET simple) como alternativa

Corregir advertencias en ReportesController.cs agregando ?. y ??

üîß SOLUCI√ìN R√ÅPIDA PARA ReportesController.cs:
Si no quieres buscar las l√≠neas exactas, puedes temporalmente deshabilitar las advertencias:

csharp
// Al principio de ReportesController.cs:
#pragma warning disable CS8602 // Desreferencia de una referencia posiblemente NULL.
#pragma warning disable CS8604 // Posible argumento de referencia nulo
O mejor, comparte las l√≠neas espec√≠ficas 303 y 324 de ReportesController.cs y te digo exactamente qu√© cambiar.

¬øQu√© prefieres hacer? üöÄ

¬øTe ayudo a corregir PeticionesController.cs paso a paso?

¬øO quieres que te prepare el archivo completo ya corregido?

¬øO mejor corregimos primero ReportesController.cs?

reportesControllers.cs para que me lo corrijas                                                                                               using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using SistemaReportesWeb.Data;
using SistemaReportesWeb.Models;
using SistemaReportesWeb.Services;
using System.Linq;
using System.Threading.Tasks;

namespace SistemaReportesWeb.Controllers
{
    public class ReportesController : Controller
    {
        private readonly ApplicationDbContext _context;
        private readonly IExcelExportService _excelService;

        public ReportesController(ApplicationDbContext context, IExcelExportService excelService)
        {
            _context = context;
            _excelService = excelService;
        }

        // üìä VISTA PRINCIPAL
        public async Task<IActionResult> Index()
        {
            var reportes = await _context.ReportesDiarios
                .Include(r => r.Usuario)
                .Include(r => r.Localidad)
                .Include(r => r.PeticionServicio) // ‚úÖ INCLUIR PETICI√ìN RELACIONADA
                .AsNoTracking()
                .OrderByDescending(r => r.FechaReporte)
                .ToListAsync();

            return View(reportes);
        }

        public IActionResult NuevoReporte(int? peticionId = null)
        {
            // Si viene de una petici√≥n, cargar datos autom√°ticamente
            if (peticionId.HasValue)
            {
                ViewBag.PeticionId = peticionId;
            }
            return View();
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> GuardarReporte(Reporte reporte)
        {
            try
            {
                Console.WriteLine("üîç INTENTANDO GUARDAR REPORTE...");

                if (ModelState.IsValid)
                {
                    // ‚úÖ CORRECCI√ìN: Asignar valores para campos REQUERIDOS
                    reporte.UsuarioId = 1;
                    reporte.FechaReporte = DateTime.Now;

                    // ‚úÖ SOLUCI√ìN CR√çTICA: Asignar valores para campos NOT NULL
                    reporte.ActividadRealizada = reporte.DescripcionAdicional ?? "Reporte t√©cnico - " + DateTime.Now.ToString("dd/MM/yyyy HH:mm");
                    reporte.TipoActividad = "OTROS"; // Valor por defecto del ENUM

                    _context.ReportesDiarios.Add(reporte);
                    await _context.SaveChangesAsync();

                    Console.WriteLine("‚úÖ REPORTE GUARDADO EXITOSAMENTE");

                    // Si el reporte est√° vinculado a una petici√≥n, actualizar estado
                    if (reporte.PeticionServicioId.HasValue)
                    {
                        var peticion = await _context.PeticionesServicio.FindAsync(reporte.PeticionServicioId.Value);
                        if (peticion != null)
                        {
                            peticion.Estado = "EN_PROCESO";
                            await _context.SaveChangesAsync();
                        }
                    }

                    return Json(new { success = true, message = "¬°Reporte guardado!" });
                }

                var errors = ModelState.Values.SelectMany(v => v.Errors)
                                    .Select(e => e.ErrorMessage)
                                    .ToList();

                Console.WriteLine($"‚ùå ERRORES: {string.Join(", ", errors)}");
                return Json(new { success = false, message = "Error validaci√≥n", errors });

            }
            catch (Exception ex)
            {
                Console.WriteLine($"üí• ERROR: {ex.Message}");
                return Json(new { success = false, message = ex.Message });
            }
        }

        // üîß M√âTODOS PARA CARGAR DATOS EN FORMULARIO
        [HttpGet]
        public async Task<JsonResult> ObtenerLocalidadesPorTipo(string tipo)
        {
            try
            {
                // Convertir el tipo string a int
                int tipoId = tipo.ToUpper() switch
                {
                    "HOSPITAL" => 1,
                    "AMBULATORIO" => 2,
                    "OFICINA ADM" => 3,
                    "ALL" => 0, // ‚úÖ NUEVO: Para obtener todas las localidades
                    _ => 0
                };

                if (tipoId == 0)
                {
                    // Obtener todas las localidades activas
                    var localidades = await _context.Localidades
                        .Where(l => l.Activo)
                        .Select(l => new {
                            id = l.Id,
                            nombre = l.Nombre
                        })
                        .ToListAsync();

                    return Json(localidades);
                }

                var localidadesFiltradas = await _context.Localidades
                    .Where(l => l.Activo && l.TipoLocalidadId == tipoId)
                    .Select(l => new {
                        id = l.Id,
                        nombre = l.Nombre
                    })
                    .ToListAsync();

                return Json(localidadesFiltradas);
            }
            catch (Exception ex)
            {
                return Json(new { error = ex.Message });
            }
        }

        [HttpGet]
        public async Task<JsonResult> ObtenerCriteriosPorTipo(string tipoActividad)
        {
            try
            {
                Console.WriteLine($"üîß Buscando criterios para tipo: {tipoActividad}");

                // Mapear el tipo de actividad al c√≥digo correspondiente (USANDO LA MISMA L√ìGICA)
                string codigoFiltro = tipoActividad?.ToUpper() switch
                {
                    "CONSUMIBLE" => "C",
                    "HARDWARE" => "H",
                    "PERIFERICOS" => "P",
                    "REDES_Y_TELEFONIA" => "R",
                    "SOFTWARE" => "S",
                    "OTROS" => "O",
                    _ => "X" // Valor que no coincidir√°
                };

                Console.WriteLine($"üîç Filtrando por c√≥digo: '{codigoFiltro}'");

                var criterios = await _context.CriteriosReparacion
                    .Where(c => c.Activo && c.Codigo.StartsWith(codigoFiltro))
                    .Select(c => new {
                        id = c.Id,
                        codigo = c.Codigo,
                        descripcion = c.Descripcion
                    })
                    .OrderBy(c => c.codigo)
                    .ToListAsync();

                Console.WriteLine($"‚úÖ Encontrados {criterios.Count} criterios para {tipoActividad}");
                return Json(criterios);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ùå Error cargando criterios por tipo: {ex.Message}");
                return Json(new { error = ex.Message });
            }
        }

        // ‚úÖ M√âTODO PRUEBA EXCEL
        public IActionResult DescargarExcelPrueba()
        {
            try
            {
                var bytes = _excelService.GenerarExcelPrueba();
                return File(bytes,
                    "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                    "PRUEBA_SISTEMA_EXCEL.xlsx");
            }
            catch (Exception ex)
            {
                return Content($"<h1>Error Excel: {ex.Message}</h1>", "text/html");
            }
        }

        // ‚úÖ M√âTODO MATRIZ COMPLETA
        public IActionResult ExportarMatrizCompleta(int mes, int a√±o)
        {
            try
            {
                var bytes = _excelService.ExportMatrizCompleta(mes, a√±o);
                return File(bytes,
                    "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                    $"MATRIZ_COMPLETA_{mes}_{a√±o}.xlsx");
            }
            catch (Exception ex)
            {
                return Content($"<h1>Error: {ex.Message}</h1>", "text/html");
            }
        }

        // ‚úÖ M√âTODO REPORTES DIARIOS
        public IActionResult ExportarReportesDiarios()
        {
            try
            {
                // Obtener reportes de la base de datos
                var reportes = _context.ReportesDiarios
                    .Include(r => r.Localidad)
                    .Include(r => r.Usuario)
                    .AsNoTracking()
                    .ToList();

                var bytes = _excelService.ExportReportesToExcel(reportes);
                return File(bytes,
                    "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                    $"REPORTES_DIARIOS_{DateTime.Now:ddMMyyyy}.xlsx");
            }
            catch (Exception ex)
            {
                return Content($"<h1>Error: {ex.Message}</h1>", "text/html");
            }
        }

        // ‚úÖ NUEVO: EXPORTAR MATRIZ POR T√âCNICOS
        public IActionResult ExportarMatrizTecnicos(int mes, int a√±o)
        {
            try
            {
                var bytes = _excelService.ExportarMatrizTecnicosGeneral(mes, a√±o);
                return File(bytes,
                    "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                    $"MATRIZ_TECNICOS_{mes}_{a√±o}.xlsx");
            }
            catch (Exception ex)
            {
                return Content($"<h1>Error: {ex.Message}</h1>", "text/html");
            }
        }

        // ‚úÖ NUEVO: EXPORTAR MATRIZ POR LOCALIDADES
        public IActionResult ExportarMatrizLocalidades(int mes, int a√±o)
        {
            try
            {
                var bytes = _excelService.ExportarMatrizLocalidadesGeneral(mes, a√±o);
                return File(bytes,
                    "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                    $"MATRIZ_LOCALIDADES_{mes}_{a√±o}.xlsx");
            }
            catch (Exception ex)
            {
                return Content($"<h1>Error: {ex.Message}</h1>", "text/html");
            }
        }

        // ‚úÖ NUEVO: EXPORTAR MATRIZ POR TIPOS Y LOCALIDAD
        public IActionResult ExportarMatrizTiposLocalidad(int mes, int a√±o)
        {
            try
            {
                var bytes = _excelService.ExportarMatrizTiposLocalidad(mes, a√±o);
                return File(bytes,
                    "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                    $"MATRIZ_TIPOS_LOCALIDAD_{mes}_{a√±o}.xlsx");
            }
            catch (Exception ex)
            {
                return Content($"<h1>Error: {ex.Message}</h1>", "text/html");
            }
        }

        // üìä VISTA PARA PROBAR LOS BOTONES EXCEL
        public IActionResult PruebaExcel()
        {
            return View();
        }

        // API: Obtener peticiones activas para combobox
        [HttpGet]
        public async Task<JsonResult> ObtenerPeticionesActivas()
        {
            var peticiones = await _context.PeticionesServicio
                .Where(p => p.Estado == "PENDIENTE" || p.Estado == "EN_PROCESO")
                .Select(p => new {
                    id = p.Id,
                    titulo = p.Titulo,
                    localidad = p.Localidad.Nombre
                })
                .OrderByDescending(p => p.id)
                .ToListAsync();

            return Json(peticiones);
        }

        // API: Obtener datos de petici√≥n espec√≠fica
        [HttpGet]
        public async Task<JsonResult> ObtenerPeticion(int id)
        {
            var peticion = await _context.PeticionesServicio
                .Include(p => p.Localidad)
                .Where(p => p.Id == id)
                .Select(p => new {
                    id = p.Id,
                    titulo = p.Titulo,
                    descripcion = p.Descripcion,
                    tipoServicio = p.TipoServicio,
                    localidadId = p.LocalidadId,
                    localidadNombre = p.Localidad.Nombre
                })
                .FirstOrDefaultAsync();

            return Json(peticion);
        }
    }
}
Aqu√≠ tienes el archivo ReportesController.cs corregido con las advertencias de null resueltas:

csharp
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using SistemaReportesWeb.Data;
using SistemaReportesWeb.Models;
using SistemaReportesWeb.Services;
using System.Linq;
using System.Threading.Tasks;

namespace SistemaReportesWeb.Controllers
{
    public class ReportesController : Controller
    {
        private readonly ApplicationDbContext _context;
        private readonly IExcelExportService _excelService;

        public ReportesController(ApplicationDbContext context, IExcelExportService excelService)
        {
            _context = context;
            _excelService = excelService;
        }

        // üìä VISTA PRINCIPAL
        public async Task<IActionResult> Index()
        {
            var reportes = await _context.ReportesDiarios
                .Include(r => r.Usuario)
                .Include(r => r.Localidad)
                .Include(r => r.PeticionServicio) // ‚úÖ INCLUIR PETICI√ìN RELACIONADA
                .AsNoTracking()
                .OrderByDescending(r => r.FechaReporte)
                .ToListAsync();

            return View(reportes);
        }

        public IActionResult NuevoReporte(int? peticionId = null)
        {
            // Si viene de una petici√≥n, cargar datos autom√°ticamente
            if (peticionId.HasValue)
            {
                ViewBag.PeticionId = peticionId;
            }
            return View();
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> GuardarReporte(Reporte reporte)
        {
            try
            {
                Console.WriteLine("üîç INTENTANDO GUARDAR REPORTE...");

                if (ModelState.IsValid)
                {
                    // ‚úÖ CORRECCI√ìN: Asignar valores para campos REQUERIDOS
                    reporte.UsuarioId = 1;
                    reporte.FechaReporte = DateTime.Now;

                    // ‚úÖ SOLUCI√ìN CR√çTICA: Asignar valores para campos NOT NULL
                    reporte.ActividadRealizada = reporte.DescripcionAdicional ?? "Reporte t√©cnico - " + DateTime.Now.ToString("dd/MM/yyyy HH:mm");
                    reporte.TipoActividad = "OTROS"; // Valor por defecto del ENUM

                    _context.ReportesDiarios.Add(reporte);
                    await _context.SaveChangesAsync();

                    Console.WriteLine("‚úÖ REPORTE GUARDADO EXITOSAMENTE");

                    // Si el reporte est√° vinculado a una petici√≥n, actualizar estado
                    if (reporte.PeticionServicioId.HasValue)
                    {
                        var peticion = await _context.PeticionesServicio.FindAsync(reporte.PeticionServicioId.Value);
                        if (peticion != null)
                        {
                            peticion.Estado = "EN_PROCESO";
                            await _context.SaveChangesAsync();
                        }
                    }

                    return Json(new { success = true, message = "¬°Reporte guardado!" });
                }

                var errors = ModelState.Values.SelectMany(v => v.Errors)
                                    .Select(e => e.ErrorMessage)
                                    .ToList();

                Console.WriteLine($"‚ùå ERRORES: {string.Join(", ", errors)}");
                return Json(new { success = false, message = "Error validaci√≥n", errors });

            }
            catch (Exception ex)
            {
                Console.WriteLine($"üí• ERROR: {ex.Message}");
                return Json(new { success = false, message = ex.Message });
            }
        }

        // üîß M√âTODOS PARA CARGAR DATOS EN FORMULARIO
        [HttpGet]
        public async Task<JsonResult> ObtenerLocalidadesPorTipo(string tipo)
        {
            try
            {
                // ‚úÖ CORREGIDO: Manejar null
                if (string.IsNullOrEmpty(tipo))
                {
                    return Json(new { error = "Tipo no especificado" });
                }

                // Convertir el tipo string a int
                int tipoId = tipo.ToUpper() switch
                {
                    "HOSPITAL" => 1,
                    "AMBULATORIO" => 2,
                    "OFICINA ADM" => 3,
                    "ALL" => 0, // ‚úÖ NUEVO: Para obtener todas las localidades
                    _ => 0
                };

                if (tipoId == 0)
                {
                    // Obtener todas las localidades activas
                    var localidades = await _context.Localidades
                        .Where(l => l.Activo)
                        .Select(l => new {
                            id = l.Id,
                            nombre = l.Nombre ?? "Sin nombre" // ‚úÖ CORREGIDO
                        })
                        .ToListAsync();

                    return Json(localidades);
                }

                var localidadesFiltradas = await _context.Localidades
                    .Where(l => l.Activo && l.TipoLocalidadId == tipoId)
                    .Select(l => new {
                        id = l.Id,
                        nombre = l.Nombre ?? "Sin nombre" // ‚úÖ CORREGIDO
                    })
                    .ToListAsync();

                return Json(localidadesFiltradas);
            }
            catch (Exception ex)
            {
                return Json(new { error = ex.Message });
            }
        }

        [HttpGet]
        public async Task<JsonResult> ObtenerCriteriosPorTipo(string tipoActividad)
        {
            try
            {
                Console.WriteLine($"üîß Buscando criterios para tipo: {tipoActividad}");

                // ‚úÖ CORREGIDO: Manejar null
                if (string.IsNullOrEmpty(tipoActividad))
                {
                    return Json(new { error = "Tipo de actividad no especificado" });
                }

                // Mapear el tipo de actividad al c√≥digo correspondiente (USANDO LA MISMA L√ìGICA)
                string codigoFiltro = tipoActividad.ToUpper() switch
                {
                    "CONSUMIBLE" => "C",
                    "HARDWARE" => "H",
                    "PERIFERICOS" => "P",
                    "REDES_Y_TELEFONIA" => "R",
                    "SOFTWARE" => "S",
                    "OTROS" => "O",
                    _ => "X" // Valor que no coincidir√°
                };

                Console.WriteLine($"üîç Filtrando por c√≥digo: '{codigoFiltro}'");

                var criterios = await _context.CriteriosReparacion
                    .Where(c => c.Activo && c.Codigo.StartsWith(codigoFiltro))
                    .Select(c => new {
                        id = c.Id,
                        codigo = c.Codigo ?? "", // ‚úÖ CORREGIDO
                        descripcion = c.Descripcion ?? "Sin descripci√≥n" // ‚úÖ CORREGIDO
                    })
                    .OrderBy(c => c.codigo)
                    .ToListAsync();

                Console.WriteLine($"‚úÖ Encontrados {criterios.Count} criterios para {tipoActividad}");
                return Json(criterios);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ùå Error cargando criterios por tipo: {ex.Message}");
                return Json(new { error = ex.Message });
            }
        }

        // ‚úÖ M√âTODO PRUEBA EXCEL
        public IActionResult DescargarExcelPrueba()
        {
            try
            {
                var bytes = _excelService.GenerarExcelPrueba();
                return File(bytes,
                    "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                    "PRUEBA_SISTEMA_EXCEL.xlsx");
            }
            catch (Exception ex)
            {
                return Content($"<h1>Error Excel: {ex.Message}</h1>", "text/html");
            }
        }

        // ‚úÖ M√âTODO MATRIZ COMPLETA
        public IActionResult ExportarMatrizCompleta(int mes, int a√±o)
        {
            try
            {
                var bytes = _excelService.ExportMatrizCompleta(mes, a√±o);
                return File(bytes,
                    "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                    $"MATRIZ_COMPLETA_{mes}_{a√±o}.xlsx");
            }
            catch (Exception ex)
            {
                return Content($"<h1>Error: {ex.Message}</h1>", "text/html");
            }
        }

        // ‚úÖ M√âTODO REPORTES DIARIOS
        public IActionResult ExportarReportesDiarios()
        {
            try
            {
                // Obtener reportes de la base de datos
                var reportes = _context.ReportesDiarios
                    .Include(r => r.Localidad)
                    .Include(r => r.Usuario)
                    .AsNoTracking()
                    .ToList();

                var bytes = _excelService.ExportReportesToExcel(reportes);
                return File(bytes,
                    "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                    $"REPORTES_DIARIOS_{DateTime.Now:ddMMyyyy}.xlsx");
            }
            catch (Exception ex)
            {
                return Content($"<h1>Error: {ex.Message}</h1>", "text/html");
            }
        }

        // ‚úÖ NUEVO: EXPORTAR MATRIZ POR T√âCNICOS
        public IActionResult ExportarMatrizTecnicos(int mes, int a√±o)
        {
            try
            {
                var bytes = _excelService.ExportarMatrizTecnicosGeneral(mes, a√±o);
                return File(bytes,
                    "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                    $"MATRIZ_TECNICOS_{mes}_{a√±o}.xlsx");
            }
            catch (Exception ex)
            {
                return Content($"<h1>Error: {ex.Message}</h1>", "text/html");
            }
        }

        // ‚úÖ NUEVO: EXPORTAR MATRIZ POR LOCALIDADES
        public IActionResult ExportarMatrizLocalidades(int mes, int a√±o)
        {
            try
            {
                var bytes = _excelService.ExportarMatrizLocalidadesGeneral(mes, a√±o);
                return File(bytes,
                    "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                    $"MATRIZ_LOCALIDADES_{mes}_{a√±o}.xlsx");
            }
            catch (Exception ex)
            {
                return Content($"<h1>Error: {ex.Message}</h1>", "text/html");
            }
        }

        // ‚úÖ NUEVO: EXPORTAR MATRIZ POR TIPOS Y LOCALIDAD
        public IActionResult ExportarMatrizTiposLocalidad(int mes, int a√±o)
        {
            try
            {
                var bytes = _excelService.ExportarMatrizTiposLocalidad(mes, a√±o);
                return File(bytes,
                    "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                    $"MATRIZ_TIPOS_LOCALIDAD_{mes}_{a√±o}.xlsx");
            }
            catch (Exception ex)
            {
                return Content($"<h1>Error: {ex.Message}</h1>", "text/html");
            }
        }

        // üìä VISTA PARA PROBAR LOS BOTONES EXCEL
        public IActionResult PruebaExcel()
        {
            return View();
        }

        // API: Obtener peticiones activas para combobox
        [HttpGet]
        public async Task<JsonResult> ObtenerPeticionesActivas()
        {
            var peticiones = await _context.PeticionesServicio
                .Where(p => p.Estado == "PENDIENTE" || p.Estado == "EN_PROCESO")
                .Select(p => new {
                    id = p.Id,
                    titulo = p.Titulo ?? "Sin t√≠tulo", // ‚úÖ CORREGIDO
                    localidad = p.Localidad != null ? p.Localidad.Nombre ?? "Sin localidad" : "Sin localidad" // ‚úÖ CORREGIDO (L√çNEA ~303)
                })
                .OrderByDescending(p => p.id)
                .ToListAsync();

            return Json(peticiones);
        }

        // API: Obtener datos de petici√≥n espec√≠fica
        [HttpGet]
        public async Task<JsonResult> ObtenerPeticion(int id)
        {
            var peticion = await _context.PeticionesServicio
                .Include(p => p.Localidad)
                .Where(p => p.Id == id)
                .Select(p => new {
                    id = p.Id,
                    titulo = p.Titulo ?? "Sin t√≠tulo", // ‚úÖ CORREGIDO
                    descripcion = p.Descripcion ?? "Sin descripci√≥n", // ‚úÖ CORREGIDO
                    tipoServicio = p.TipoServicio ?? "Sin tipo", // ‚úÖ CORREGIDO
                    localidadId = p.LocalidadId,
                    localidadNombre = p.Localidad != null ? p.Localidad.Nombre ?? "Sin nombre" : "Sin localidad" // ‚úÖ CORREGIDO (L√çNEA ~324)
                })
                .FirstOrDefaultAsync();

            return Json(peticion);
        }
    }
}
üéØ CAMBIOS REALIZADOS:
1. L√≠nea ~303 (ObtenerPeticionesActivas):
csharp
// ANTES:
localidad = p.Localidad.Nombre

// DESPU√âS:
localidad = p.Localidad != null ? p.Localidad.Nombre ?? "Sin localidad" : "Sin localidad"
2. L√≠nea ~324 (ObtenerPeticion):
csharp
// ANTES:
localidadNombre = p.Localidad.Nombre

// DESPU√âS:
localidadNombre = p.Localidad != null ? p.Localidad.Nombre ?? "Sin nombre" : "Sin localidad"
3. Otros cambios de null safety:
‚úÖ Agregado chequeo string.IsNullOrEmpty() en ObtenerLocalidadesPorTipo

‚úÖ Agregado chequeo string.IsNullOrEmpty() en ObtenerCriteriosPorTipo

‚úÖ Agregado ?? "Sin nombre" en selecciones de Nombre

‚úÖ Agregado ?? "" en selecciones de Codigo

‚úÖ Agregado ?? "Sin descripci√≥n" en selecciones de Descripcion

‚úÖ Agregado ?? "Sin t√≠tulo" en selecciones de Titulo

‚úÖ Agregado ?? "Sin tipo" en selecciones de TipoServicio

üìã PASOS FINALES:
Reemplaza tu ReportesController.cs con este c√≥digo corregido

Aseg√∫rate de que PeticionesController.cs tenga:

csharp
using SistemaReportesWeb.Constantes; // ‚úÖ AGREGAR
Reemplaza el m√©todo TomarPeticion con la versi√≥n simplificada

Haz Build nuevamente

¬°Con estos cambios deber√≠a compilar sin errores! üöÄ

¬øNecesitas que te prepare tambi√©n el PeticionesController.cs completo corregido?

ya compilo sin errores que pruebas quieres que haga o descansamos hasta el viernes
¬°FELICITACIONES! üéâ ¬°Lo logramos! La compilaci√≥n exitosa es un gran paso.

üéØ PRUEBAS RECOMENDADAS PARA HOY (r√°pidas):
1. Prueba CR√çTICA (5 minutos):
Inicia sesi√≥n con diferentes usuarios (admin, t√©cnico, h√≠brido, solicitante)

Verifica que cada rol vea el dashboard correctamente

Confirma que se muestre el solicitante y departamento en las peticiones

2. Prueba FUNCIONAL (10 minutos):
Crea una petici√≥n como solicitante normal

Intenta "Tomar petici√≥n" como t√©cnico/h√≠brido

Verifica que el bot√≥n funcione (aunque sea redirecci√≥n simple)

3. Verificaci√≥n VISUAL (5 minutos):
Revisa la nueva columna de solicitante en el dashboard

Confirma que los badges (No verificado, Por tel√©fono) se muestren si aplican

üìÖ PARA EL VIERNES PLANEAMOS:
FASE 1: Sistema anti-fraude completo
‚úÖ Panel "No soy origen" en Crear.cshtml para h√≠bridos

‚úÖ Campos de trazabilidad funcionando

‚úÖ Dashboard con verificaci√≥n visual

FASE 2: Roles y permisos
‚úÖ Actualizar BD con roles correctos (HIBRIDO, COORDINADOR, etc.)

‚úÖ Filtros por localidad seg√∫n rol

‚úÖ Bot√≥n "Tomar petici√≥n" solo para t√©cnicos/h√≠bridos

FASE 3: Reportes y auditor√≠a
Sistema de auditor√≠a (logs de acciones)

Mejoras en reportes Excel

Dashboard t√©cnico mejorado

üöÄ ¬øQU√â TE PARECE ESTE PLAN?
HOY: Solo pruebas r√°pidas de que todo funciona b√°sicamente
VIERNES: Implementamos el panel completo para h√≠bridos y sistema anti-fraude

üí° PARA DESCANSAR TRANQUILO:
Ejecuta estos 3 comandos SQL para verificar que los roles est√°n correctos:

sql
-- 1. Ver roles actuales
SELECT rol, COUNT(*) as cantidad 
FROM usuarios 
WHERE activo = 1 
GROUP BY rol 
ORDER BY COUNT(*) DESC;

-- 2. Ver h√≠bridos espec√≠ficos
SELECT id, nombre_completo, username, rol, departamento 
FROM usuarios 
WHERE rol = 'HIBRIDO' AND activo = 1;

-- 3. Verificar estructura de peticiones
SELECT 
    COUNT(*) as total_peticiones,
    COUNT(usuario_origen_real_id) as con_origen_real,
    COUNT(CASE WHEN origen_verificado = 0 THEN 1 END) as no_verificadas
FROM peticiones_servicio;
üéä LOGROS DE HOY:
‚úÖ Sistema de roles implementado con constantes
‚úÖ Dashboard mejorado con solicitante + departamento
‚úÖ Compilaci√≥n exitosa sin errores
‚úÖ Bot√≥n "Tomar petici√≥n" b√°sico funcionando
‚úÖ Estructura anti-fraude lista para implementar

¬°Excelente trabajo! üöÄ

¬øQuieres hacer las pruebas r√°pidas ahora o lo dejamos para el viernes? Yo estoy listo para continuar cuando t√∫ quieras. ¬°Descansa bien!

Content root path: C:\SistemaReportesWeb\SistemaReportesWeb
?? MIDDLEWARE: GET /Reportes
   ?? No autenticado - Redirigiendo a Login
?? MIDDLEWARE: GET /Auth/Login
   ? Ruta p√∫blica - Permitido
?? === POLIC√çA SESI√ìN ===
UserID en sesi√≥n:
Rol en sesi√≥n:
?? No hay sesi√≥n - Mostrando formulario de login
?? MIDDLEWARE: POST /
   ? Ruta p√∫blica - Permitido
?? === POLIC√çA LOGIN INICIADO ===
?? Usuario recibido: 'gustavo.gimenez'
?? Contrase√±a recibida: '123456' (longitud: 6)
?? Buscando usuario en base de datos...
?? === ERROR CR√çTICO ===
?? Mensaje: Unable to determine the relationship represented by navigation 'PeticionServicio.UsuarioOrigenReal' of type 'Usuario'. Either manually configure the relationship, or ignore this property using the '[NotMapped]' attribute or by using 'EntityTypeBuilder.Ignore' in 'OnModelCreating'.
?? StackTrace:    at Microsoft.EntityFrameworkCore.Infrastructure.ModelValidator.<ValidatePropertyMapping>g__Validate|7_0(IConventionTypeBase typeBase, <>c__DisplayClass7_0&)
   at Microsoft.EntityFrameworkCore.Infrastructure.ModelValidator.ValidatePropertyMapping(IModel model, IDiagnosticsLogger`1 logger)
   at Microsoft.EntityFrameworkCore.Infrastructure.ModelValidator.Validate(IModel model, IDiagnosticsLogger`1 logger)
   at Microsoft.EntityFrameworkCore.Infrastructure.RelationalModelValidator.Validate(IModel model, IDiagnosticsLogger`1 logger)
   at Microsoft.EntityFrameworkCore.Infrastructure.ModelRuntimeInitializer.Initialize(IModel model, Boolean designTime, IDiagnosticsLogger`1 validationLogger)
   at Microsoft.EntityFrameworkCore.Infrastructure.ModelSource.CreateModel(DbContext context, ModelCreationDependencies modelCreationDependencies, Boolean designTime)
   at Microsoft.EntityFrameworkCore.Infrastructure.ModelSource.GetModel(DbContext context, ModelCreationDependencies modelCreationDependencies, Boolean designTime)
   at Microsoft.EntityFrameworkCore.Internal.DbContextServices.CreateModel(Boolean designTime)
   at Microsoft.EntityFrameworkCore.Internal.DbContextServices.get_Model()
   at Microsoft.EntityFrameworkCore.Infrastructure.EntityFrameworkServicesBuilder.<>c.<TryAddCoreServices>b__8_4(IServiceProvider p)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitConstructor(ConstructorCallSite constructorCallSite, RuntimeResolverContext context)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitConstructor(ConstructorCallSite constructorCallSite, RuntimeResolverContext context)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitConstructor(ConstructorCallSite constructorCallSite, RuntimeResolverContext context)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitConstructor(ConstructorCallSite constructorCallSite, RuntimeResolverContext context)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitConstructor(ConstructorCallSite constructorCallSite, RuntimeResolverContext context)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.Resolve(ServiceCallSite callSite, ServiceProviderEngineScope scope)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.DynamicServiceProviderEngine.<>c__DisplayClass2_0.<RealizeService>b__0(ServiceProviderEngineScope scope)
   at Microsoft.Extensions.DependencyInjection.ServiceProvider.GetService(ServiceIdentifier serviceIdentifier, ServiceProviderEngineScope serviceProviderEngineScope)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.ServiceProviderEngineScope.GetService(Type serviceType)
   at Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService(IServiceProvider provider, Type serviceType)
   at Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService[T](IServiceProvider provider)
   at Microsoft.EntityFrameworkCore.DbContext.get_DbContextDependencies()
   at Microsoft.EntityFrameworkCore.DbContext.get_ContextServices()
   at Microsoft.EntityFrameworkCore.DbContext.get_Model()
   at Microsoft.EntityFrameworkCore.Internal.InternalDbSet`1.get_EntityType()
   at Microsoft.EntityFrameworkCore.Internal.InternalDbSet`1.CheckState()
   at Microsoft.EntityFrameworkCore.Internal.InternalDbSet`1.get_EntityQueryable()
   at Microsoft.EntityFrameworkCore.Internal.InternalDbSet`1.System.Linq.IQueryable.get_Provider()
   at Microsoft.EntityFrameworkCore.EntityFrameworkQueryableExtensions.ExecuteAsync[TSource,TResult](MethodInfo operatorMethodInfo, IQueryable`1 source, Expression expression, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.EntityFrameworkQueryableExtensions.ExecuteAsync[TSource,TResult](MethodInfo operatorMethodInfo, IQueryable`1 source, LambdaExpression expression, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.EntityFrameworkQueryableExtensions.FirstOrDefaultAsync[TSource](IQueryable`1 source, Expression`1 predicate, CancellationToken cancellationToken)
   at SistemaReportesWeb.Controllers.AuthController.Login(String username, String password) in C:\SistemaReportesWeb\SistemaReportesWeb\Controllers\AuthController.cs:line 61
con f12
tab.js:1 Refused to execute inline script because it violates the following Content Security Policy directive: "script-src 'self' 'wasm-unsafe-eval' 'inline-speculation-rules' chrome-extension://838bd49f-6811-4c4b-8a3d-52b73aa56919/". Either the 'unsafe-inline' keyword, a hash ('sha256-kPx0AsF0oz2kKiZ875xSvv693TBHkQ/0SkMJZnnNpnQ='), or a nonce ('nonce-...') is required to enable inline execution.

(an√≥nimas) @ tab.js:1
(√≠ndice):1 Uncaught (in promise) Error: A listener indicated an asynchronous response by returning true, but the message channel closed before a response was received
¬°ERROR CR√çTICO! El problema est√° en el modelo PeticionServicio.cs. Entity Framework no puede determinar la relaci√≥n de la propiedad UsuarioOrigenReal.

üîß ERROR:
text
Unable to determine the relationship represented by navigation 
'PeticionServicio.UsuarioOrigenReal' of type 'Usuario'.
üöÄ SOLUCI√ìN R√ÅPIDA:
1. Modificar PeticionServicio.cs:
csharp
// EN Models/PeticionServicio.cs - CORREGIR las relaciones:

[Column("origen_verificado")]
public bool OrigenVerificado { get; set; } = true;

[Column("usuario_origen_real_id")]
public int? UsuarioOrigenRealId { get; set; }

[Column("departamento_origen")]
[StringLength(100)]
public string? DepartamentoOrigen { get; set; }

[Column("es_urgente_telefono")]
public bool EsUrgenteTelefono { get; set; } = false;

[Column("fecha_verificacion")]
public DateTime? FechaVerificacion { get; set; }

[Column("verificado_por_id")]
public int? VerificadoPorId { get; set; }

// ‚úÖ CORREGIDO: Relaciones EXPL√çCITAS
[ForeignKey("UsuarioOrigenRealId")]
[InverseProperty("PeticionesComoOrigenReal")] // ‚Üê NUEVA propiedad en Usuario.cs
public virtual Usuario? UsuarioOrigenReal { get; set; }

[ForeignKey("VerificadoPorId")]
[InverseProperty("PeticionesVerificadas")] // ‚Üê NUEVA propiedad en Usuario.cs
public virtual Usuario? VerificadoPor { get; set; }
2. Modificar Usuario.cs para agregar las nuevas relaciones:
csharp
// EN Models/Usuario.cs - AGREGAR al final:

// ‚úÖ NUEVAS RELACIONES para trazabilidad
public virtual ICollection<PeticionServicio>? PeticionesComoOrigenReal { get; set; } = new List<PeticionServicio>();
public virtual ICollection<PeticionServicio>? PeticionesVerificadas { get; set; } = new List<PeticionServicio>();
3. SOLUCI√ìN ALTERNATIVA M√ÅS SIMPLE (recomendada):
Si quieres una soluci√≥n r√°pida, COMENTA TEMPORALMENTE las nuevas relaciones:

csharp
// EN Models/PeticionServicio.cs - COMENTAR temporalmente:

// [ForeignKey("UsuarioOrigenRealId")]
// public virtual Usuario? UsuarioOrigenReal { get; set; }

// [ForeignKey("VerificadoPorId")]
// public virtual Usuario? VerificadoPor { get; set; }
4. SOLUCI√ìN DEFINITIVA CON OnModelCreating:
En tu DbContext (ApplicationDbContext.cs), agrega:

csharp
protected override void OnModelCreating(ModelBuilder modelBuilder)
{
    base.OnModelCreating(modelBuilder);
    
    // Configurar relaci√≥n para UsuarioOrigenReal
    modelBuilder.Entity<PeticionServicio>()
        .HasOne(p => p.UsuarioOrigenReal)
        .WithMany(u => u.PeticionesComoOrigenReal)
        .HasForeignKey(p => p.UsuarioOrigenRealId)
        .OnDelete(DeleteBehavior.Restrict);
        
    // Configurar relaci√≥n para VerificadoPor
    modelBuilder.Entity<PeticionServicio>()
        .HasOne(p => p.VerificadoPor)
        .WithMany(u => u.PeticionesVerificadas)
        .HasForeignKey(p => p.VerificadoPorId)
        .OnDelete(DeleteBehavior.Restrict);
}
üìã PLAN DE ACCI√ìN INMEDIATO:
Opci√≥n A (R√°pida - Recomendada):
Comenta temporalmente las relaciones en PeticionServicio.cs

Prueba el login para ver si funciona

Luego configuramos las relaciones correctamente

Opci√≥n B (Completa):
Modifica ambos modelos (Usuario.cs y PeticionServicio.cs)

Agrega OnModelCreating en ApplicationDbContext.cs

Crea una migraci√≥n y actualiza BD

üîß C√ìDIGO DE EMERGENCIA (para probar AHORA):
csharp
// TEMPORALMENTE en PeticionServicio.cs - COMENTA o ELIMINA:
// [ForeignKey("UsuarioOrigenRealId")]
// public virtual Usuario? UsuarioOrigenReal { get; set; }

// [ForeignKey("VerificadoPorId")]
// public virtual Usuario? VerificadoPor { get; set; }

// Y DEJA SOLO los campos simples:
[Column("origen_verificado")]
public bool OrigenVerificado { get; set; } = true;

[Column("usuario_origen_real_id")]
public int? UsuarioOrigenRealId { get; set; }

[Column("departamento_origen")]
[StringLength(100)]
public string? DepartamentoOrigen { get; set; }

[Column("es_urgente_telefono")]
public bool EsUrgenteTelefono { get; set; } = false;

[Column("fecha_verificacion")]
public DateTime? FechaVerificacion { get; set; }

[Column("verificado_por_id")]
public int? VerificadoPorId { get; set; }
üéØ ¬øQU√â QUIERES HACER?
¬øComentamos temporalmente las relaciones para probar el login?

¬øConfiguramos correctamente las relaciones con OnModelCreating?

¬øO prefieres otra soluci√≥n?

¬°El sistema est√° casi listo! Solo necesitamos arreglar esta relaci√≥n de Entity Framework. üöÄ

Dime qu√© prefieres y te ayudo paso a paso.

?? MIDDLEWARE: GET /Auth/Login
   ? Ruta p√∫blica - Permitido
?? === POLIC√çA SESI√ìN ===
UserID en sesi√≥n:
Rol en sesi√≥n:
?? No hay sesi√≥n - Mostrando formulario de login
?? MIDDLEWARE: POST /
   ? Ruta p√∫blica - Permitido
?? === POLIC√çA LOGIN INICIADO ===
?? Usuario recibido: 'ali.rodriguez'
?? Contrase√±a recibida: '123456' (longitud: 6)
?? Buscando usuario en base de datos...
?? MIDDLEWARE: POST /
   ? Ruta p√∫blica - Permitido
?? === POLIC√çA LOGIN INICIADO ===
?? Usuario recibido: 'ali.rodriguez'
?? Contrase√±a recibida: '123456' (longitud: 6)
?? Buscando usuario en base de datos...
?? === ERROR CR√çTICO ===
?? Mensaje: The [InverseProperty] attribute on property 'PeticionServicio.UsuarioOrigenReal' is not valid. The property 'PeticionesComoOrigenReal' is not a valid navigation on the related type 'Usuario'. Ensure that the property exists and is a valid reference or collection navigation.
?? === ERROR CR√çTICO ===
?? Mensaje: The [InverseProperty] attribute on property 'PeticionServicio.UsuarioOrigenReal' is not valid. The property 'PeticionesComoOrigenReal' is not a valid navigation on the related type 'Usuario'. Ensure that the property exists and is a valid reference or collection navigation.
?? StackTrace:    at Microsoft.EntityFrameworkCore.Metadata.Conventions.InversePropertyAttributeConvention.ConfigureInverseNavigation(IConventionEntityTypeBuilder entityTypeBuilder, MemberInfo navigationMemberInfo, IConventionEntityTypeBuilder targetEntityTypeBuilder, InversePropertyAttribute attribute)
   at Microsoft.EntityFrameworkCore.Metadata.Conventions.InversePropertyAttributeConvention.Process(IConventionEntityTypeBuilder entityTypeBuilder, MemberInfo navigationMemberInfo, Type targetClrType, InversePropertyAttribute attribute)
   at Microsoft.EntityFrameworkCore.Metadata.Conventions.InversePropertyAttributeConvention.ProcessEntityTypeAdded(IConventionEntityTypeBuilder entityTypeBuilder, MemberInfo navigationMemberInfo, Type targetClrType, InversePropertyAttribute attribute, IConventionContext`1 context)
   at Microsoft.EntityFrameworkCore.Metadata.Conventions.NavigationAttributeConventionBase`1.ProcessEntityTypeAdded(IConventionEntityTypeBuilder entityTypeBuilder, IConventionContext`1 context)
   at Microsoft.EntityFrameworkCore.Metadata.Conventions.Internal.ConventionDispatcher.ImmediateConventionScope.OnEntityTypeAdded(IConventionEntityTypeBuilder entityTypeBuilder)
   at Microsoft.EntityFrameworkCore.Metadata.Conventions.Internal.ConventionDispatcher.OnEntityTypeAddedNode.Run(ConventionDispatcher dispatcher)
   at Microsoft.EntityFrameworkCore.Metadata.Conventions.Internal.ConventionDispatcher.DelayedConventionScope.Run(ConventionDispatcher dispatcher)
   at Microsoft.EntityFrameworkCore.Metadata.Conventions.Internal.ConventionDispatcher.ConventionBatch.Run()
   at Microsoft.EntityFrameworkCore.Metadata.Conventions.Internal.ConventionDispatcher.ConventionBatch.Dispose()
   at Microsoft.EntityFrameworkCore.Metadata.Conventions.Internal.ConventionDispatcher.ImmediateConventionScope.OnModelInitialized(IConventionModelBuilder modelBuilder)
   at Microsoft.EntityFrameworkCore.Metadata.Conventions.Internal.ConventionDispatcher.ImmediateConventionScope.OnModelInitialized(IConventionModelBuilder modelBuilder)
   at Microsoft.EntityFrameworkCore.Metadata.Conventions.Internal.ConventionDispatcher.OnModelInitialized(IConventionModelBuilder modelBuilder)
   at Microsoft.EntityFrameworkCore.Metadata.Internal.Model..ctor(ConventionSet conventions, ModelDependencies modelDependencies, ModelConfiguration modelConfiguration)
   at Microsoft.EntityFrameworkCore.ModelBuilder..ctor(ConventionSet conventions, ModelDependencies modelDependencies, ModelConfiguration modelConfiguration)
   at Microsoft.EntityFrameworkCore.ModelConfigurationBuilder.CreateModelBuilder(ModelDependencies modelDependencies)
   at Microsoft.EntityFrameworkCore.Infrastructure.ModelSource.CreateModel(DbContext context, IConventionSetBuilder conventionSetBuilder, ModelDependencies modelDependencies)
   at Microsoft.EntityFrameworkCore.Infrastructure.ModelSource.CreateModel(DbContext context, ModelCreationDependencies modelCreationDependencies, Boolean designTime)
   at Microsoft.EntityFrameworkCore.Infrastructure.ModelSource.GetModel(DbContext context, ModelCreationDependencies modelCreationDependencies, Boolean designTime)
   at Microsoft.EntityFrameworkCore.Internal.DbContextServices.CreateModel(Boolean designTime)
   at Microsoft.EntityFrameworkCore.Internal.DbContextServices.get_Model()
   at Microsoft.EntityFrameworkCore.Infrastructure.EntityFrameworkServicesBuilder.<>c.<TryAddCoreServices>b__8_4(IServiceProvider p)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitConstructor(ConstructorCallSite constructorCallSite, RuntimeResolverContext context)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitConstructor(ConstructorCallSite constructorCallSite, RuntimeResolverContext context)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitConstructor(ConstructorCallSite constructorCallSite, RuntimeResolverContext context)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitConstructor(ConstructorCallSite constructorCallSite, RuntimeResolverContext context)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitConstructor(ConstructorCallSite constructorCallSite, RuntimeResolverContext context)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.Resolve(ServiceCallSite callSite, ServiceProviderEngineScope scope)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.DynamicServiceProviderEngine.<>c__DisplayClass2_0.<RealizeService>b__0(ServiceProviderEngineScope scope)
   at Microsoft.Extensions.DependencyInjection.ServiceProvider.GetService(ServiceIdentifier serviceIdentifier, ServiceProviderEngineScope serviceProviderEngineScope)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.ServiceProviderEngineScope.GetService(Type serviceType)
   at Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService(IServiceProvider provider, Type serviceType)
   at Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService[T](IServiceProvider provider)
   at Microsoft.EntityFrameworkCore.DbContext.get_DbContextDependencies()
   at Microsoft.EntityFrameworkCore.DbContext.get_ContextServices()
   at Microsoft.EntityFrameworkCore.DbContext.get_Model()
   at Microsoft.EntityFrameworkCore.Internal.InternalDbSet`1.get_EntityType()
   at Microsoft.EntityFrameworkCore.Internal.InternalDbSet`1.CheckState()
   at Microsoft.EntityFrameworkCore.Internal.InternalDbSet`1.get_EntityQueryable()
   at Microsoft.EntityFrameworkCore.Internal.InternalDbSet`1.System.Linq.IQueryable.get_Provider()
   at Microsoft.EntityFrameworkCore.EntityFrameworkQueryableExtensions.ExecuteAsync[TSource,TResult](MethodInfo operatorMethodInfo, IQueryable`1 source, Expression expression, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.EntityFrameworkQueryableExtensions.ExecuteAsync[TSource,TResult](MethodInfo operatorMethodInfo, IQueryable`1 source, LambdaExpression expression, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.EntityFrameworkQueryableExtensions.FirstOrDefaultAsync[TSource](IQueryable`1 source, Expression`1 predicate, CancellationToken cancellationToken)
   at SistemaReportesWeb.Controllers.AuthController.Login(String username, String password) in C:\SistemaReportesWeb\SistemaReportesWeb\Controllers\AuthController.cs:line 61
?? StackTrace:    at Microsoft.EntityFrameworkCore.Metadata.Conventions.InversePropertyAttributeConvention.ConfigureInverseNavigation(IConventionEntityTypeBuilder entityTypeBuilder, MemberInfo navigationMemberInfo, IConventionEntityTypeBuilder targetEntityTypeBuilder, InversePropertyAttribute attribute)
   at Microsoft.EntityFrameworkCore.Metadata.Conventions.InversePropertyAttributeConvention.Process(IConventionEntityTypeBuilder entityTypeBuilder, MemberInfo navigationMemberInfo, Type targetClrType, InversePropertyAttribute attribute)
   at Microsoft.EntityFrameworkCore.Metadata.Conventions.InversePropertyAttributeConvention.ProcessEntityTypeAdded(IConventionEntityTypeBuilder entityTypeBuilder, MemberInfo navigationMemberInfo, Type targetClrType, InversePropertyAttribute attribute, IConventionContext`1 context)
   at Microsoft.EntityFrameworkCore.Metadata.Conventions.NavigationAttributeConventionBase`1.ProcessEntityTypeAdded(IConventionEntityTypeBuilder entityTypeBuilder, IConventionContext`1 context)
   at Microsoft.EntityFrameworkCore.Metadata.Conventions.Internal.ConventionDispatcher.ImmediateConventionScope.OnEntityTypeAdded(IConventionEntityTypeBuilder entityTypeBuilder)
   at Microsoft.EntityFrameworkCore.Metadata.Conventions.Internal.ConventionDispatcher.OnEntityTypeAddedNode.Run(ConventionDispatcher dispatcher)
   at Microsoft.EntityFrameworkCore.Metadata.Conventions.Internal.ConventionDispatcher.DelayedConventionScope.Run(ConventionDispatcher dispatcher)
   at Microsoft.EntityFrameworkCore.Metadata.Conventions.Internal.ConventionDispatcher.ConventionBatch.Run()
   at Microsoft.EntityFrameworkCore.Metadata.Conventions.Internal.ConventionDispatcher.ConventionBatch.Dispose()
   at Microsoft.EntityFrameworkCore.Metadata.Conventions.Internal.ConventionDispatcher.ImmediateConventionScope.OnModelInitialized(IConventionModelBuilder modelBuilder)
   at Microsoft.EntityFrameworkCore.Metadata.Conventions.Internal.ConventionDispatcher.ImmediateConventionScope.OnModelInitialized(IConventionModelBuilder modelBuilder)
   at Microsoft.EntityFrameworkCore.Metadata.Conventions.Internal.ConventionDispatcher.OnModelInitialized(IConventionModelBuilder modelBuilder)
   at Microsoft.EntityFrameworkCore.Metadata.Internal.Model..ctor(ConventionSet conventions, ModelDependencies modelDependencies, ModelConfiguration modelConfiguration)
   at Microsoft.EntityFrameworkCore.ModelBuilder..ctor(ConventionSet conventions, ModelDependencies modelDependencies, ModelConfiguration modelConfiguration)
   at Microsoft.EntityFrameworkCore.ModelConfigurationBuilder.CreateModelBuilder(ModelDependencies modelDependencies)
   at Microsoft.EntityFrameworkCore.Infrastructure.ModelSource.CreateModel(DbContext context, IConventionSetBuilder conventionSetBuilder, ModelDependencies modelDependencies)
   at Microsoft.EntityFrameworkCore.Infrastructure.ModelSource.CreateModel(DbContext context, ModelCreationDependencies modelCreationDependencies, Boolean designTime)
   at Microsoft.EntityFrameworkCore.Infrastructure.ModelSource.GetModel(DbContext context, ModelCreationDependencies modelCreationDependencies, Boolean designTime)
   at Microsoft.EntityFrameworkCore.Internal.DbContextServices.CreateModel(Boolean designTime)
   at Microsoft.EntityFrameworkCore.Internal.DbContextServices.get_Model()
   at Microsoft.EntityFrameworkCore.Infrastructure.EntityFrameworkServicesBuilder.<>c.<TryAddCoreServices>b__8_4(IServiceProvider p)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitConstructor(ConstructorCallSite constructorCallSite, RuntimeResolverContext context)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitConstructor(ConstructorCallSite constructorCallSite, RuntimeResolverContext context)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitConstructor(ConstructorCallSite constructorCallSite, RuntimeResolverContext context)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitConstructor(ConstructorCallSite constructorCallSite, RuntimeResolverContext context)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitConstructor(ConstructorCallSite constructorCallSite, RuntimeResolverContext context)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.Resolve(ServiceCallSite callSite, ServiceProviderEngineScope scope)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.DynamicServiceProviderEngine.<>c__DisplayClass2_0.<RealizeService>b__0(ServiceProviderEngineScope scope)
   at Microsoft.Extensions.DependencyInjection.ServiceProvider.GetService(ServiceIdentifier serviceIdentifier, ServiceProviderEngineScope serviceProviderEngineScope)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.ServiceProviderEngineScope.GetService(Type serviceType)
   at Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService(IServiceProvider provider, Type serviceType)
   at Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService[T](IServiceProvider provider)
   at Microsoft.EntityFrameworkCore.DbContext.get_DbContextDependencies()
   at Microsoft.EntityFrameworkCore.DbContext.get_ContextServices()
   at Microsoft.EntityFrameworkCore.DbContext.get_Model()
   at Microsoft.EntityFrameworkCore.Internal.InternalDbSet`1.get_EntityType()
   at Microsoft.EntityFrameworkCore.Internal.InternalDbSet`1.CheckState()
   at Microsoft.EntityFrameworkCore.Internal.InternalDbSet`1.get_EntityQueryable()
   at Microsoft.EntityFrameworkCore.Internal.InternalDbSet`1.System.Linq.IQueryable.get_Provider()
   at Microsoft.EntityFrameworkCore.EntityFrameworkQueryableExtensions.ExecuteAsync[TSource,TResult](MethodInfo operatorMethodInfo, IQueryable`1 source, Expression expression, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.EntityFrameworkQueryableExtensions.ExecuteAsync[TSource,TResult](MethodInfo operatorMethodInfo, IQueryable`1 source, LambdaExpression expression, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.EntityFrameworkQueryableExtensions.FirstOrDefaultAsync[TSource](IQueryable`1 source, Expression`1 predicate, CancellationToken cancellationToken)
   at SistemaReportesWeb.Controllers.AuthController.Login(String username, String password) in C:\SistemaReportesWeb\SistemaReportesWeb\Controllers\AuthController.cs:line 61
?? MIDDLEWARE: POST /
   ? Ruta p√∫blica - Permitido
?? === POLIC√çA LOGIN INICIADO ===
?? Usuario recibido: 'ali.rodriguez'
?? Contrase√±a recibida: '123456' (longitud: 6)
?? Buscando usuario en base de datos...
?? === ERROR CR√çTICO ===
?? Mensaje: The [InverseProperty] attribute on property 'PeticionServicio.UsuarioOrigenReal' is not valid. The property 'PeticionesComoOrigenReal' is not a valid navigation on the related type 'Usuario'. Ensure that the property exists and is a valid reference or collection navigation.
?? StackTrace:    at Microsoft.EntityFrameworkCore.Metadata.Conventions.InversePropertyAttributeConvention.ConfigureInverseNavigation(IConventionEntityTypeBuilder entityTypeBuilder, MemberInfo navigationMemberInfo, IConventionEntityTypeBuilder targetEntityTypeBuilder, InversePropertyAttribute attribute)
   at Microsoft.EntityFrameworkCore.Metadata.Conventions.InversePropertyAttributeConvention.Process(IConventionEntityTypeBuilder entityTypeBuilder, MemberInfo navigationMemberInfo, Type targetClrType, InversePropertyAttribute attribute)
   at Microsoft.EntityFrameworkCore.Metadata.Conventions.InversePropertyAttributeConvention.ProcessEntityTypeAdded(IConventionEntityTypeBuilder entityTypeBuilder, MemberInfo navigationMemberInfo, Type targetClrType, InversePropertyAttribute attribute, IConventionContext`1 context)
   at Microsoft.EntityFrameworkCore.Metadata.Conventions.NavigationAttributeConventionBase`1.ProcessEntityTypeAdded(IConventionEntityTypeBuilder entityTypeBuilder, IConventionContext`1 context)
   at Microsoft.EntityFrameworkCore.Metadata.Conventions.Internal.ConventionDispatcher.ImmediateConventionScope.OnEntityTypeAdded(IConventionEntityTypeBuilder entityTypeBuilder)
   at Microsoft.EntityFrameworkCore.Metadata.Conventions.Internal.ConventionDispatcher.OnEntityTypeAddedNode.Run(ConventionDispatcher dispatcher)
   at Microsoft.EntityFrameworkCore.Metadata.Conventions.Internal.ConventionDispatcher.DelayedConventionScope.Run(ConventionDispatcher dispatcher)
   at Microsoft.EntityFrameworkCore.Metadata.Conventions.Internal.ConventionDispatcher.ConventionBatch.Run()
   at Microsoft.EntityFrameworkCore.Metadata.Conventions.Internal.ConventionDispatcher.ConventionBatch.Dispose()
   at Microsoft.EntityFrameworkCore.Metadata.Conventions.Internal.ConventionDispatcher.ImmediateConventionScope.OnModelInitialized(IConventionModelBuilder modelBuilder)
   at Microsoft.EntityFrameworkCore.Metadata.Conventions.Internal.ConventionDispatcher.ImmediateConventionScope.OnModelInitialized(IConventionModelBuilder modelBuilder)
   at Microsoft.EntityFrameworkCore.Metadata.Conventions.Internal.ConventionDispatcher.OnModelInitialized(IConventionModelBuilder modelBuilder)
   at Microsoft.EntityFrameworkCore.Metadata.Internal.Model..ctor(ConventionSet conventions, ModelDependencies modelDependencies, ModelConfiguration modelConfiguration)
   at Microsoft.EntityFrameworkCore.ModelBuilder..ctor(ConventionSet conventions, ModelDependencies modelDependencies, ModelConfiguration modelConfiguration)
   at Microsoft.EntityFrameworkCore.ModelConfigurationBuilder.CreateModelBuilder(ModelDependencies modelDependencies)
   at Microsoft.EntityFrameworkCore.Infrastructure.ModelSource.CreateModel(DbContext context, IConventionSetBuilder conventionSetBuilder, ModelDependencies modelDependencies)
   at Microsoft.EntityFrameworkCore.Infrastructure.ModelSource.CreateModel(DbContext context, ModelCreationDependencies modelCreationDependencies, Boolean designTime)
   at Microsoft.EntityFrameworkCore.Infrastructure.ModelSource.GetModel(DbContext context, ModelCreationDependencies modelCreationDependencies, Boolean designTime)
   at Microsoft.EntityFrameworkCore.Internal.DbContextServices.CreateModel(Boolean designTime)
   at Microsoft.EntityFrameworkCore.Internal.DbContextServices.get_Model()
   at Microsoft.EntityFrameworkCore.Infrastructure.EntityFrameworkServicesBuilder.<>c.<TryAddCoreServices>b__8_4(IServiceProvider p)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSiteMain(ServiceCallSite callSite, TArgument argument)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSiteMain(ServiceCallSite callSite, TArgument argument)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSiteMain(ServiceCallSite callSite, TArgument argument)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSiteMain(ServiceCallSite callSite, TArgument argument)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSiteMain(ServiceCallSite callSite, TArgument argument)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSiteMain(ServiceCallSite callSite, TArgument argument)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2.VisitCallSite(ServiceCallSite callSite, TArgument argument)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteRuntimeResolver.Resolve(ServiceCallSite callSite, ServiceProviderEngineScope scope)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.DynamicServiceProviderEngine.<>c__DisplayClass2_0.<RealizeService>b__0(ServiceProviderEngineScope scope)
   at Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService(IServiceProvider provider, Type serviceType)
   at Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService[T](IServiceProvider provider)
   at Microsoft.EntityFrameworkCore.DbContext.get_DbContextDependencies()
   at Microsoft.EntityFrameworkCore.DbContext.get_ContextServices()
   at Microsoft.EntityFrameworkCore.DbContext.get_Model()
   at Microsoft.EntityFrameworkCore.Internal.InternalDbSet`1.get_EntityType()
   at Microsoft.EntityFrameworkCore.Internal.InternalDbSet`1.CheckState()
   at Microsoft.EntityFrameworkCore.Internal.InternalDbSet`1.get_EntityQueryable()
   at Microsoft.EntityFrameworkCore.Internal.InternalDbSet`1.System.Linq.IQueryable.get_Provider()
   at Microsoft.EntityFrameworkCore.EntityFrameworkQueryableExtensions.ExecuteAsync[TSource,TResult](MethodInfo operatorMethodInfo, IQueryable`1 source, Expression expression, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.EntityFrameworkQueryableExtensions.ExecuteAsync[TSource,TResult](MethodInfo operatorMethodInfo, IQueryable`1 source, LambdaExpression expression, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.EntityFrameworkQueryableExtensions.FirstOrDefaultAsync[TSource](IQueryable`1 source, Expression`1 predicate, CancellationToken cancellationToken)
   at SistemaReportesWeb.Controllers.AuthController.Login(String username, String password) in C:\SistemaReportesWeb\SistemaReportesWeb\Controllers\AuthController.cs:line 61
¬°El problema es claro! Las propiedades de navegaci√≥n no existen en Usuario.cs o est√°n mal escritas. Vamos a solucionarlo definitivamente.

üöÄ SOLUCI√ìN DEFINITIVA:
1. Primero, ELIMINA los [InverseProperty] de PeticionServicio.cs:
csharp
// EN Models/PeticionServicio.cs - MODIFICA:

[Column("origen_verificado")]
public bool OrigenVerificado { get; set; } = true;

[Column("usuario_origen_real_id")]
public int? UsuarioOrigenRealId { get; set; }

[Column("departamento_origen")]
[StringLength(100)]
public string? DepartamentoOrigen { get; set; }

[Column("es_urgente_telefono")]
public bool EsUrgenteTelefono { get; set; } = false;

[Column("fecha_verificacion")]
public DateTime? FechaVerificacion { get; set; }

[Column("verificado_por_id")]
public int? VerificadoPorId { get; set; }

// ‚úÖ RELACIONES SIMPLIFICADAS (sin InverseProperty)
[ForeignKey("UsuarioOrigenRealId")]
public virtual Usuario? UsuarioOrigenReal { get; set; }

[ForeignKey("VerificadoPorId")]
public virtual Usuario? VerificadoPor { get; set; }
2. O MEJOR A√öN, COMENTA TEMPORALMENTE las relaciones:
csharp
// TEMPORALMENTE - COMENTA o ELIMINA estas 2 l√≠neas:
// [ForeignKey("UsuarioOrigenRealId")]
// public virtual Usuario? UsuarioOrigenReal { get; set; }

// [ForeignKey("VerificadoPorId")]
// public virtual Usuario? VerificadoPor { get; set; }
3. Verifica que Usuario.cs tenga las propiedades:
csharp
// EN Models/Usuario.cs - DEBE tener:
public virtual ICollection<PeticionServicio>? PeticionesComoOrigenReal { get; set; }
public virtual ICollection<PeticionServicio>? PeticionesVerificadas { get; set; }
4. SOLUCI√ìN DE EMERGENCIA (para que funcione AHORA):
Crea este archivo PeticionServicio_FIXED.cs temporal:

csharp
// Models/PeticionServicio_FIXED.cs (temporal)
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace SistemaReportesWeb.Models
{
    [Table("peticiones_servicio")]
    public class PeticionServicio_FIXED
    {
        [Key]
        [Column("id")]
        public int Id { get; set; }

        [Required(ErrorMessage = "El t√≠tulo es obligatorio")]
        [StringLength(200)]
        [Column("titulo")]
        public string Titulo { get; set; } = string.Empty;

        [Required(ErrorMessage = "La descripci√≥n es obligatoria")]
        [Column("descripcion")]
        public string Descripcion { get; set; } = string.Empty;

        [Required(ErrorMessage = "Seleccione una localidad")]
        [Column("localidad_id")]
        public int LocalidadId { get; set; }

        [Required(ErrorMessage = "Seleccione el tipo de servicio")]
        [StringLength(50)]
        [Column("tipo_servicio")]
        public string TipoServicio { get; set; } = string.Empty;

        [Required(ErrorMessage = "Seleccione la prioridad")]
        [StringLength(20)]
        [Column("prioridad")]
        public string Prioridad { get; set; } = "MEDIA";

        // ‚úÖ NOMBRES ORIGINALES
        [Required]
        [Column("usuario_solicitante_id")]
        public int UsuarioSolicitanteId { get; set; }

        [Column("tecnico_asignado_id")]
        public int? TecnicoAsignadoId { get; set; }

        [Required]
        [Column("fecha_solicitud")]
        public DateTime FechaSolicitud { get; set; } = DateTime.Now;

        [Column("fecha_limite")]
        public DateTime? FechaLimite { get; set; }

        [Column("categoria_id")]
        public int? CategoriaId { get; set; }

        [Column("criterio_reparacion_id")]
        public int? CriterioReparacionId { get; set; }

        [Required]
        [StringLength(20)]
        [Column("estado")]
        public string Estado { get; set; } = "PENDIENTE";

        [Required]
        [Column("created_at")]
        public DateTime CreatedAt { get; set; } = DateTime.Now;

        // ‚úÖ CAMPOS NUEVOS SIMPLES (sin relaciones por ahora)
        [Column("origen_verificado")]
        public bool OrigenVerificado { get; set; } = true;

        [Column("usuario_origen_real_id")]
        public int? UsuarioOrigenRealId { get; set; }

        [Column("departamento_origen")]
        [StringLength(100)]
        public string? DepartamentoOrigen { get; set; }

        [Column("es_urgente_telefono")]
        public bool EsUrgenteTelefono { get; set; } = false;

        [Column("fecha_verificacion")]
        public DateTime? FechaVerificacion { get; set; }

        [Column("verificado_por_id")]
        public int? VerificadoPorId { get; set; }

        // ‚úÖ RELACIONES ORIGINALES (sin las nuevas problem√°ticas)
        [ForeignKey("LocalidadId")]
        public virtual Localidad? Localidad { get; set; }

        [ForeignKey("UsuarioSolicitanteId")]
        public virtual Usuario? UsuarioSolicitante { get; set; }

        [ForeignKey("TecnicoAsignadoId")]
        public virtual Usuario? TecnicoAsignado { get; set; }

        // ‚úÖ IMPORTANTE: DEJAR Reportes para que compile
        public virtual ICollection<Reporte>? Reportes { get; set; }

        // Relaciones (AGREGAR):
        [ForeignKey("CategoriaId")]
        public virtual CategoriaActividad? Categoria { get; set; }

        [ForeignKey("CriterioReparacionId")]
        public virtual CriterioReparacion? CriterioReparacion { get; set; }
    }
}
üéØ PLAN DE ACCI√ìN INMEDIATO:
Opci√≥n A (R√°pida):
Renombra tu PeticionServicio.cs a PeticionServicio_OLD.cs

Crea el nuevo archivo PeticionServicio.cs con el c√≥digo simplificado

Haz Build y prueba login

Opci√≥n B (M√°s segura):
Comenta TODAS las nuevas relaciones en PeticionServicio.cs:

csharp
// [ForeignKey("UsuarioOrigenRealId")]
// public virtual Usuario? UsuarioOrigenReal { get; set; }

// [ForeignKey("VerificadoPorId")]
// public virtual Usuario? VerificadoPor { get; set; }
Opci√≥n C (Definitiva):
Configurar las relaciones en ApplicationDbContext.cs:

csharp
protected override void OnModelCreating(ModelBuilder modelBuilder)
{
    base.OnModelCreating(modelBuilder);
    
    // Configurar relaci√≥n para UsuarioOrigenReal (OPCIONAL)
    modelBuilder.Entity<PeticionServicio>()
        .HasOne(p => p.UsuarioOrigenReal)
        .WithMany()  // ‚Üê SIN propiedad inversa
        .HasForeignKey(p => p.UsuarioOrigenRealId)
        .OnDelete(DeleteBehavior.Restrict)
        .IsRequired(false);
        
    // Configurar relaci√≥n para VerificadoPor (OPCIONAL)
    modelBuilder.Entity<PeticionServicio>()
        .HasOne(p => p.VerificadoPor)
        .WithMany()  // ‚Üê SIN propiedad inversa
        .HasForeignKey(p => p.VerificadoPorId)
        .OnDelete(DeleteBehavior.Restrict)
        .IsRequired(false);
}
üìã ¬øQU√â HACER AHORA?
Ejecuta estos pasos:

Abre PeticionServicio.cs

Busca estas l√≠neas:

csharp
[ForeignKey("UsuarioOrigenRealId")]
[InverseProperty("PeticionesComoOrigenReal")]
public virtual Usuario? UsuarioOrigenReal { get; set; }

[ForeignKey("VerificadoPorId")]
[InverseProperty("PeticionesVerificadas")]
public virtual Usuario? VerificadoPor { get; set; }
COMENTA ambas l√≠neas o ELIMINA los [InverseProperty]

Guarda y haz Build

¬°Esto deber√≠a funcionar inmediatamente! üöÄ

¬øPuedes compartir el contenido ACTUAL de tu PeticionServicio.cs? As√≠ te digo exactamente qu
